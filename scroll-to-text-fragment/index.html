<!doctype html>
<html lang="ja-JP">

<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <title>URL フラグメント テキスト ディレクティブ</title>
    <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
    <link href="https://www.w3.org/StyleSheets/TR/2021/cg-draft" rel="stylesheet">
    <!-- <meta content="Bikeshed version 82ce88815, updated Thu Sep 7 16:33:55 2023 -0700" name="generator"> -->
    <link href="https://wicg.github.io/scroll-to-text-fragment/" rel="canonical">
    <style>
        .monkeypatch {
            color: grey;
        }

        .monkeypatch .diff {
            color: var(--text);
        }
    </style>
    <style>
        /* Boilerplate: style-autolinks */
        .css.css,
        .property.property,
        .descriptor.descriptor {
            color: var(--a-normal-text);
            font-size: inherit;
            font-family: inherit;
        }

        .css::before,
        .property::before,
        .descriptor::before {
            content: "‘";
        }

        .css::after,
        .property::after,
        .descriptor::after {
            content: "’";
        }

        .property,
        .descriptor {
            /* Don't wrap property and descriptor names */
            white-space: nowrap;
        }

        .type {
            /* CSS value <type> */
            font-style: italic;
        }

        pre .property::before,
        pre .property::after {
            content: "";
        }

        [data-link-type="property"]::before,
        [data-link-type="propdesc"]::before,
        [data-link-type="descriptor"]::before,
        [data-link-type="value"]::before,
        [data-link-type="function"]::before,
        [data-link-type="at-rule"]::before,
        [data-link-type="selector"]::before,
        [data-link-type="maybe"]::before {
            content: "‘";
        }

        [data-link-type="property"]::after,
        [data-link-type="propdesc"]::after,
        [data-link-type="descriptor"]::after,
        [data-link-type="value"]::after,
        [data-link-type="function"]::after,
        [data-link-type="at-rule"]::after,
        [data-link-type="selector"]::after,
        [data-link-type="maybe"]::after {
            content: "’";
        }

        [data-link-type].production::before,
        [data-link-type].production::after,
        .prod [data-link-type]::before,
        .prod [data-link-type]::after {
            content: "";
        }

        [data-link-type=element],
        [data-link-type=element-attr] {
            font-family: Menlo, Consolas, "DejaVu Sans Mono", monospace;
            font-size: .9em;
        }

        [data-link-type=element]::before {
            content: "<"
        }

        [data-link-type=element]::after {
            content: ">"
        }

        [data-link-type=biblio] {
            white-space: pre;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --selflink-text: black;
                --selflink-bg: silver;
                --selflink-hover-text: white;
            }
        }
    </style>
    <style>
        /* Boilerplate: style-colors */

        /* Any --*-text not paired with a --*-bg is assumed to have a transparent bg */
        :root {
            color-scheme: light dark;

            --text: black;
            --bg: white;

            --unofficial-watermark: url(https://www.w3.org/StyleSheets/TR/2016/logos/UD-watermark);

            --logo-bg: #1a5e9a;
            --logo-active-bg: #c00;
            --logo-text: white;

            --tocnav-normal-text: #707070;
            --tocnav-normal-bg: var(--bg);
            --tocnav-hover-text: var(--tocnav-normal-text);
            --tocnav-hover-bg: #f8f8f8;
            --tocnav-active-text: #c00;
            --tocnav-active-bg: var(--tocnav-normal-bg);

            --tocsidebar-text: var(--text);
            --tocsidebar-bg: #f7f8f9;
            --tocsidebar-shadow: rgba(0, 0, 0, .1);
            --tocsidebar-heading-text: hsla(203, 20%, 40%, .7);

            --toclink-text: var(--text);
            --toclink-underline: #3980b5;
            --toclink-visited-text: var(--toclink-text);
            --toclink-visited-underline: #054572;

            --heading-text: #005a9c;

            --hr-text: var(--text);

            --algo-border: #def;

            --del-text: red;
            --del-bg: transparent;
            --ins-text: #080;
            --ins-bg: transparent;

            --a-normal-text: #034575;
            --a-normal-underline: #bbb;
            --a-visited-text: var(--a-normal-text);
            --a-visited-underline: #707070;
            --a-hover-bg: rgba(75%, 75%, 75%, .25);
            --a-active-text: #c00;
            --a-active-underline: #c00;

            --blockquote-border: silver;
            --blockquote-bg: transparent;
            --blockquote-text: currentcolor;

            --issue-border: #e05252;
            --issue-bg: #fbe9e9;
            --issue-text: var(--text);
            --issueheading-text: #831616;

            --example-border: #e0cb52;
            --example-bg: #fcfaee;
            --example-text: var(--text);
            --exampleheading-text: #574b0f;

            --note-border: #52e052;
            --note-bg: #e9fbe9;
            --note-text: var(--text);
            --noteheading-text: hsl(120, 70%, 30%);
            --notesummary-underline: silver;

            --assertion-border: #aaa;
            --assertion-bg: #eee;
            --assertion-text: black;

            --advisement-border: orange;
            --advisement-bg: #fec;
            --advisement-text: var(--text);
            --advisementheading-text: #b35f00;

            --warning-border: red;
            --warning-bg: hsla(40, 100%, 50%, 0.95);
            --warning-text: var(--text);

            --amendment-border: #330099;
            --amendment-bg: #F5F0FF;
            --amendment-text: var(--text);
            --amendmentheading-text: #220066;

            --def-border: #8ccbf2;
            --def-bg: #def;
            --def-text: var(--text);
            --defrow-border: #bbd7e9;

            --datacell-border: silver;

            --indexinfo-text: #707070;

            --indextable-hover-text: black;
            --indextable-hover-bg: #f7f8f9;

            --outdatedspec-bg: rgba(0, 0, 0, .5);
            --outdatedspec-text: black;
            --outdated-bg: maroon;
            --outdated-text: white;
            --outdated-shadow: red;

            --editedrec-bg: darkorange;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --text: #ddd;
                --bg: black;

                --unofficial-watermark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400'%3E%3Cg fill='%23100808' transform='translate(200 200) rotate(-45) translate(-200 -200)' stroke='%23100808' stroke-width='3'%3E%3Ctext x='50%25' y='220' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EUNOFFICIAL%3C/text%3E%3Ctext x='50%25' y='305' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EDRAFT%3C/text%3E%3C/g%3E%3C/svg%3E");

                --logo-bg: #1a5e9a;
                --logo-active-bg: #c00;
                --logo-text: white;

                --tocnav-normal-text: #999;
                --tocnav-normal-bg: var(--bg);
                --tocnav-hover-text: var(--tocnav-normal-text);
                --tocnav-hover-bg: #080808;
                --tocnav-active-text: #f44;
                --tocnav-active-bg: var(--tocnav-normal-bg);

                --tocsidebar-text: var(--text);
                --tocsidebar-bg: #080808;
                --tocsidebar-shadow: rgba(255, 255, 255, .1);
                --tocsidebar-heading-text: hsla(203, 20%, 40%, .7);

                --toclink-text: var(--text);
                --toclink-underline: #6af;
                --toclink-visited-text: var(--toclink-text);
                --toclink-visited-underline: #054572;

                --heading-text: #8af;

                --hr-text: var(--text);

                --algo-border: #456;

                --del-text: #f44;
                --del-bg: transparent;
                --ins-text: #4a4;
                --ins-bg: transparent;

                --a-normal-text: #6af;
                --a-normal-underline: #555;
                --a-visited-text: var(--a-normal-text);
                --a-visited-underline: var(--a-normal-underline);
                --a-hover-bg: rgba(25%, 25%, 25%, .2);
                --a-active-text: #f44;
                --a-active-underline: var(--a-active-text);

                --borderedblock-bg: rgba(255, 255, 255, .05);

                --blockquote-border: silver;
                --blockquote-bg: var(--borderedblock-bg);
                --blockquote-text: currentcolor;

                --issue-border: #e05252;
                --issue-bg: var(--borderedblock-bg);
                --issue-text: var(--text);
                --issueheading-text: hsl(0deg, 70%, 70%);

                --example-border: hsl(50deg, 90%, 60%);
                --example-bg: var(--borderedblock-bg);
                --example-text: var(--text);
                --exampleheading-text: hsl(50deg, 70%, 70%);

                --note-border: hsl(120deg, 100%, 35%);
                --note-bg: var(--borderedblock-bg);
                --note-text: var(--text);
                --noteheading-text: hsl(120, 70%, 70%);
                --notesummary-underline: silver;

                --assertion-border: #444;
                --assertion-bg: var(--borderedblock-bg);
                --assertion-text: var(--text);

                --advisement-border: orange;
                --advisement-bg: #222218;
                --advisement-text: var(--text);
                --advisementheading-text: #f84;

                --warning-border: red;
                --warning-bg: hsla(40, 100%, 20%, 0.95);
                --warning-text: var(--text);

                --amendment-border: #330099;
                --amendment-bg: #080010;
                --amendment-text: var(--text);
                --amendmentheading-text: #cc00ff;

                --def-border: #8ccbf2;
                --def-bg: #080818;
                --def-text: var(--text);
                --defrow-border: #136;

                --datacell-border: silver;

                --indexinfo-text: #aaa;

                --indextable-hover-text: var(--text);
                --indextable-hover-bg: #181818;

                --outdatedspec-bg: rgba(255, 255, 255, .5);
                --outdatedspec-text: black;
                --outdated-bg: maroon;
                --outdated-text: white;
                --outdated-shadow: red;

                --editedrec-bg: darkorange;
            }

            /* In case a transparent-bg image doesn't expect to be on a dark bg,
       which is quite common in practice... */
            img {
                background: white;
            }
        }
    </style>
    <style>
        /* Boilerplate: style-counters */
        body {
            counter-reset: example figure issue;
        }

        .issue {
            counter-increment: issue;
        }

        .issue:not(.no-marker)::before {
            content: "Issue " counter(issue);
        }

        .example {
            counter-increment: example;
        }

        .example:not(.no-marker)::before {
            content: "Example " counter(example);
        }

        .invalid.example:not(.no-marker)::before,
        .illegal.example:not(.no-marker)::before {
            content: "Invalid Example" counter(example);
        }

        figcaption {
            counter-increment: figure;
        }

        figcaption:not(.no-marker)::before {
            content: "Figure " counter(figure) " ";
        }
    </style>
    <style>
        /* Boilerplate: style-dfn-panel */
        :root {
            --dfnpanel-bg: #ddd;
            --dfnpanel-text: var(--text);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --dfnpanel-bg: #222;
                --dfnpanel-text: var(--text);
            }
        }

        .dfn-panel {
            position: absolute;
            z-index: 35;
            width: 20em;
            width: 300px;
            height: auto;
            max-height: 500px;
            overflow: auto;
            padding: 0.5em 0.75em;
            font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
            background: var(--dfnpanel-bg);
            color: var(--dfnpanel-text);
            border: outset 0.2em;
            white-space: normal;
            /* in case it's moved into a pre */
        }

        .dfn-panel:not(.on) {
            display: none;
        }

        .dfn-panel * {
            margin: 0;
            padding: 0;
            text-indent: 0;
        }

        .dfn-panel>b {
            display: block;
        }

        .dfn-panel a {
            color: var(--dfnpanel-text);
        }

        .dfn-panel a:not(:hover) {
            text-decoration: none !important;
            border-bottom: none !important;
        }

        .dfn-panel>b+b {
            margin-top: 0.25em;
        }

        .dfn-panel ul {
            padding: 0 0 0 1em;
            list-style: none;
        }

        .dfn-panel li a {
            white-space: pre;
            display: inline-block;
            max-width: calc(300px - 1.5em - 1em);
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .dfn-panel.activated {
            display: inline-block;
            position: fixed;
            left: .5em;
            bottom: 2em;
            margin: 0 auto;
            max-width: calc(100vw - 1.5em - .4em - .5em);
            max-height: 30vh;
        }

        .dfn-paneled[role="button"] {
            cursor: pointer;
        }
    </style>
    <style>
        /* Boilerplate: style-dfn-panel */
        :root {
            --dfnpanel-bg: #ddd;
            --dfnpanel-text: var(--text);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --dfnpanel-bg: #222;
                --dfnpanel-text: var(--text);
            }
        }

        .dfn-panel {
            position: absolute;
            z-index: 35;
            width: 20em;
            width: 300px;
            height: auto;
            max-height: 500px;
            overflow: auto;
            padding: 0.5em 0.75em;
            font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
            background: var(--dfnpanel-bg);
            color: var(--dfnpanel-text);
            border: outset 0.2em;
            white-space: normal;
            /* in case it's moved into a pre */
        }

        .dfn-panel:not(.on) {
            display: none;
        }

        .dfn-panel * {
            margin: 0;
            padding: 0;
            text-indent: 0;
        }

        .dfn-panel>b {
            display: block;
        }

        .dfn-panel a {
            color: var(--dfnpanel-text);
        }

        .dfn-panel a:not(:hover) {
            text-decoration: none !important;
            border-bottom: none !important;
        }

        .dfn-panel>b+b {
            margin-top: 0.25em;
        }

        .dfn-panel ul {
            padding: 0 0 0 1em;
            list-style: none;
        }

        .dfn-panel li a {
            white-space: pre;
            display: inline-block;
            max-width: calc(300px - 1.5em - 1em);
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .dfn-panel.activated {
            display: inline-block;
            position: fixed;
            left: .5em;
            bottom: 2em;
            margin: 0 auto;
            max-width: calc(100vw - 1.5em - .4em - .5em);
            max-height: 30vh;
        }

        .dfn-paneled[role="button"] {
            cursor: pointer;
        }
    </style>
    <style>
        /* Boilerplate: style-issues */
        a[href].issue-return {
            float: right;
            float: inline-end;
            color: var(--issueheading-text);
            font-weight: bold;
            text-decoration: none;
        }
    </style>
    <style>
        /* Boilerplate: style-md-lists */
        /* This is a weird hack for me not yet following the commonmark spec
   regarding paragraph and lists. */
        [data-md]> :first-child {
            margin-top: 0;
        }

        [data-md]> :last-child {
            margin-bottom: 0;
        }
    </style>
    <style>
        /* Boilerplate: style-selflinks */

        :root {
            --selflink-text: white;
            --selflink-bg: gray;
            --selflink-hover-text: black;
        }

        .heading,
        .issue,
        .note,
        .example,
        li,
        dt {
            position: relative;
        }

        a.self-link {
            position: absolute;
            top: 0;
            left: calc(-1 * (3.5rem - 26px));
            width: calc(3.5rem - 26px);
            height: 2em;
            text-align: center;
            border: none;
            transition: opacity .2s;
            opacity: .5;
        }

        a.self-link:hover {
            opacity: 1;
        }

        .heading>a.self-link {
            font-size: 83%;
        }

        .example>a.self-link,
        .note>a.self-link,
        .issue>a.self-link {
            /* These blocks are overflow:auto, so positioning outside
       doesn't work. */
            left: auto;
            right: 0;
        }

        li>a.self-link {
            left: calc(-1 * (3.5rem - 26px) - 2em);
        }

        dfn>a.self-link {
            top: auto;
            left: auto;
            opacity: 0;
            width: 1.5em;
            height: 1.5em;
            background: var(--selflink-bg);
            color: var(--selflink-text);
            font-style: normal;
            transition: opacity .2s, background-color .2s, color .2s;
        }

        dfn:hover>a.self-link {
            opacity: 1;
        }

        dfn>a.self-link:hover {
            color: var(--selflink-hover-text);
        }

        a.self-link::before {
            content: "¶";
        }

        .heading>a.self-link::before {
            content: "§";
        }

        dfn>a.self-link::before {
            content: "#";
        }
    </style>
    <style>
        /* Boilerplate: style-syntax-highlighting */

        pre.idl.highlight {
            background: var(--borderedblock-bg, var(--def-bg));
        }
    </style>
    <style>
        /* Boilerplate: style-syntax-highlighting */

        code.highlight {
            padding: .1em;
            border-radius: .3em;
        }

        pre.highlight,
        pre>code.highlight {
            display: block;
            padding: 1em;
            margin: .5em 0;
            overflow: auto;
            border-radius: 0;
        }

        .highlight:not(.idl) {
            background: rgba(0, 0, 0, .03);
        }

        c-[a] {
            color: #990055
        }

        /* Keyword.Declaration */
        c-[b] {
            color: #990055
        }

        /* Keyword.Type */
        c-[c] {
            color: #708090
        }

        /* Comment */
        c-[d] {
            color: #708090
        }

        /* Comment.Multiline */
        c-[e] {
            color: #0077aa
        }

        /* Name.Attribute */
        c-[f] {
            color: #669900
        }

        /* Name.Tag */
        c-[g] {
            color: #222222
        }

        /* Name.Variable */
        c-[k] {
            color: #990055
        }

        /* Keyword */
        c-[l] {
            color: #000000
        }

        /* Literal */
        c-[m] {
            color: #000000
        }

        /* Literal.Number */
        c-[n] {
            color: #0077aa
        }

        /* Name */
        c-[o] {
            color: #999999
        }

        /* Operator */
        c-[p] {
            color: #999999
        }

        /* Punctuation */
        c-[s] {
            color: #a67f59
        }

        /* Literal.String */
        c-[t] {
            color: #a67f59
        }

        /* Literal.String.Single */
        c-[u] {
            color: #a67f59
        }

        /* Literal.String.Double */
        c-[cp] {
            color: #708090
        }

        /* Comment.Preproc */
        c-[c1] {
            color: #708090
        }

        /* Comment.Single */
        c-[cs] {
            color: #708090
        }

        /* Comment.Special */
        c-[kc] {
            color: #990055
        }

        /* Keyword.Constant */
        c-[kn] {
            color: #990055
        }

        /* Keyword.Namespace */
        c-[kp] {
            color: #990055
        }

        /* Keyword.Pseudo */
        c-[kr] {
            color: #990055
        }

        /* Keyword.Reserved */
        c-[ld] {
            color: #000000
        }

        /* Literal.Date */
        c-[nc] {
            color: #0077aa
        }

        /* Name.Class */
        c-[no] {
            color: #0077aa
        }

        /* Name.Constant */
        c-[nd] {
            color: #0077aa
        }

        /* Name.Decorator */
        c-[ni] {
            color: #0077aa
        }

        /* Name.Entity */
        c-[ne] {
            color: #0077aa
        }

        /* Name.Exception */
        c-[nf] {
            color: #0077aa
        }

        /* Name.Function */
        c-[nl] {
            color: #0077aa
        }

        /* Name.Label */
        c-[nn] {
            color: #0077aa
        }

        /* Name.Namespace */
        c-[py] {
            color: #0077aa
        }

        /* Name.Property */
        c-[ow] {
            color: #999999
        }

        /* Operator.Word */
        c-[mb] {
            color: #000000
        }

        /* Literal.Number.Bin */
        c-[mf] {
            color: #000000
        }

        /* Literal.Number.Float */
        c-[mh] {
            color: #000000
        }

        /* Literal.Number.Hex */
        c-[mi] {
            color: #000000
        }

        /* Literal.Number.Integer */
        c-[mo] {
            color: #000000
        }

        /* Literal.Number.Oct */
        c-[sb] {
            color: #a67f59
        }

        /* Literal.String.Backtick */
        c-[sc] {
            color: #a67f59
        }

        /* Literal.String.Char */
        c-[sd] {
            color: #a67f59
        }

        /* Literal.String.Doc */
        c-[se] {
            color: #a67f59
        }

        /* Literal.String.Escape */
        c-[sh] {
            color: #a67f59
        }

        /* Literal.String.Heredoc */
        c-[si] {
            color: #a67f59
        }

        /* Literal.String.Interpol */
        c-[sx] {
            color: #a67f59
        }

        /* Literal.String.Other */
        c-[sr] {
            color: #a67f59
        }

        /* Literal.String.Regex */
        c-[ss] {
            color: #a67f59
        }

        /* Literal.String.Symbol */
        c-[vc] {
            color: #0077aa
        }

        /* Name.Variable.Class */
        c-[vg] {
            color: #0077aa
        }

        /* Name.Variable.Global */
        c-[vi] {
            color: #0077aa
        }

        /* Name.Variable.Instance */
        c-[il] {
            color: #000000
        }

        /* Literal.Number.Integer.Long */


        @media (prefers-color-scheme: dark) {
            .highlight:not(.idl) {
                background: rgba(255, 255, 255, .05);
            }

            c-[a] {
                color: #d33682
            }

            /* Keyword.Declaration */
            c-[b] {
                color: #d33682
            }

            /* Keyword.Type */
            c-[c] {
                color: #2aa198
            }

            /* Comment */
            c-[d] {
                color: #2aa198
            }

            /* Comment.Multiline */
            c-[e] {
                color: #268bd2
            }

            /* Name.Attribute */
            c-[f] {
                color: #b58900
            }

            /* Name.Tag */
            c-[g] {
                color: #cb4b16
            }

            /* Name.Variable */
            c-[k] {
                color: #d33682
            }

            /* Keyword */
            c-[l] {
                color: #657b83
            }

            /* Literal */
            c-[m] {
                color: #657b83
            }

            /* Literal.Number */
            c-[n] {
                color: #268bd2
            }

            /* Name */
            c-[o] {
                color: #657b83
            }

            /* Operator */
            c-[p] {
                color: #657b83
            }

            /* Punctuation */
            c-[s] {
                color: #6c71c4
            }

            /* Literal.String */
            c-[t] {
                color: #6c71c4
            }

            /* Literal.String.Single */
            c-[u] {
                color: #6c71c4
            }

            /* Literal.String.Double */
            c-[ch] {
                color: #2aa198
            }

            /* Comment.Hashbang */
            c-[cp] {
                color: #2aa198
            }

            /* Comment.Preproc */
            c-[cpf] {
                color: #2aa198
            }

            /* Comment.PreprocFile */
            c-[c1] {
                color: #2aa198
            }

            /* Comment.Single */
            c-[cs] {
                color: #2aa198
            }

            /* Comment.Special */
            c-[kc] {
                color: #d33682
            }

            /* Keyword.Constant */
            c-[kn] {
                color: #d33682
            }

            /* Keyword.Namespace */
            c-[kp] {
                color: #d33682
            }

            /* Keyword.Pseudo */
            c-[kr] {
                color: #d33682
            }

            /* Keyword.Reserved */
            c-[ld] {
                color: #657b83
            }

            /* Literal.Date */
            c-[nc] {
                color: #268bd2
            }

            /* Name.Class */
            c-[no] {
                color: #268bd2
            }

            /* Name.Constant */
            c-[nd] {
                color: #268bd2
            }

            /* Name.Decorator */
            c-[ni] {
                color: #268bd2
            }

            /* Name.Entity */
            c-[ne] {
                color: #268bd2
            }

            /* Name.Exception */
            c-[nf] {
                color: #268bd2
            }

            /* Name.Function */
            c-[nl] {
                color: #268bd2
            }

            /* Name.Label */
            c-[nn] {
                color: #268bd2
            }

            /* Name.Namespace */
            c-[py] {
                color: #268bd2
            }

            /* Name.Property */
            c-[ow] {
                color: #657b83
            }

            /* Operator.Word */
            c-[mb] {
                color: #657b83
            }

            /* Literal.Number.Bin */
            c-[mf] {
                color: #657b83
            }

            /* Literal.Number.Float */
            c-[mh] {
                color: #657b83
            }

            /* Literal.Number.Hex */
            c-[mi] {
                color: #657b83
            }

            /* Literal.Number.Integer */
            c-[mo] {
                color: #657b83
            }

            /* Literal.Number.Oct */
            c-[sa] {
                color: #6c71c4
            }

            /* Literal.String.Affix */
            c-[sb] {
                color: #6c71c4
            }

            /* Literal.String.Backtick */
            c-[sc] {
                color: #6c71c4
            }

            /* Literal.String.Char */
            c-[dl] {
                color: #6c71c4
            }

            /* Literal.String.Delimiter */
            c-[sd] {
                color: #6c71c4
            }

            /* Literal.String.Doc */
            c-[se] {
                color: #6c71c4
            }

            /* Literal.String.Escape */
            c-[sh] {
                color: #6c71c4
            }

            /* Literal.String.Heredoc */
            c-[si] {
                color: #6c71c4
            }

            /* Literal.String.Interpol */
            c-[sx] {
                color: #6c71c4
            }

            /* Literal.String.Other */
            c-[sr] {
                color: #6c71c4
            }

            /* Literal.String.Regex */
            c-[ss] {
                color: #6c71c4
            }

            /* Literal.String.Symbol */
            c-[fm] {
                color: #268bd2
            }

            /* Name.Function.Magic */
            c-[vc] {
                color: #cb4b16
            }

            /* Name.Variable.Class */
            c-[vg] {
                color: #cb4b16
            }

            /* Name.Variable.Global */
            c-[vi] {
                color: #cb4b16
            }

            /* Name.Variable.Instance */
            c-[vm] {
                color: #cb4b16
            }

            /* Name.Variable.Magic */
            c-[il] {
                color: #657b83
            }

            /* Literal.Number.Integer.Long */
        }
    </style>
    <style>
        /* Boilerplate: style-var-click-highlighting */
        /*
Colors were chosen in Lab using https://nixsensor.com/free-color-converter/
D50 2deg illuminant, L in [0,100], a and b in [-128, 128]
0 = lab(85,0,85)
1 = lab(85,80,30)
2 = lab(85,-40,40)
3 = lab(85,-50,0)
4 = lab(85,5,15)
5 = lab(85,-10,-50)
6 = lab(85,35,-15)
*/
        var {
            cursor: pointer;
        }

        var.selected0 {
            background-color: #F4D200;
            box-shadow: 0 0 0 2px #F4D200;
        }

        var.selected1 {
            background-color: #FF87A2;
            box-shadow: 0 0 0 2px #FF87A2;
        }

        var.selected2 {
            background-color: #96E885;
            box-shadow: 0 0 0 2px #96E885;
        }

        var.selected3 {
            background-color: #3EEED2;
            box-shadow: 0 0 0 2px #3EEED2;
        }

        var.selected4 {
            background-color: #EACFB6;
            box-shadow: 0 0 0 2px #EACFB6;
        }

        var.selected5 {
            background-color: #82DDFF;
            box-shadow: 0 0 0 2px #82DDFF;
        }

        var.selected6 {
            background-color: #FFBCF2;
            box-shadow: 0 0 0 2px #FFBCF2;
        }
    </style>
    <style>
        /* Boilerplate: style-wpt */
        :root {
            --wpt-border: hsl(0, 0%, 60%);
            --wpt-bg: hsl(0, 0%, 95%);
            --wpt-text: var(--text);
            --wptheading-text: hsl(0, 0%, 30%);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --wpt-border: hsl(0, 0%, 30%);
                --wpt-bg: var(--borderedblock-bg);
                --wpt-text: var(--text);
                --wptheading-text: hsl(0, 0%, 60%);
            }
        }

        .wpt-tests-block {
            list-style: none;
            border-left: .5em solid var(--wpt-border);
            background: var(--wpt-bg);
            color: var(--wpt-text);
            margin: 1em auto;
            padding: .5em;
        }

        .wpt-tests-block summary {
            color: var(--wptheading-text);
            font-weight: normal;
            text-transform: uppercase;
        }

        .wpt-tests-block summary::marker {
            color: var(--wpt-border);
        }

        .wpt-tests-block summary:hover::marker {
            color: var(--wpt-text);
        }

        /*
   The only content  of a wpt test block in its closed state is the <summary>,
   which contains the word TESTS,
   and that is absolutely positioned.
   In that closed state, wpt test blocks are styled
   to have a top margin whose height is exactly equal
   to the height of the absolutely positioned <summary>,
   and no other background/padding/margin/border.
   The wpt test block elements will therefore allow the maring
   of the previous/next block elements
   to collapse through them;
   if this combined margin would be larger than its own top margin,
   it stays as is,
   and therefore the pre-existing vertical rhythm of the document is undisturbed.
   If that combined margin would be smaller, it is grown to that size.
   This means that the wpt test block ensures
   that there's always enough vertical space to insert the summary,
   without adding more than is needed.
*/
        .wpt-tests-block:not([open]) {
            padding: 0;
            border: none;
            background: none;
            font-size: 0.75em;
            line-height: 1;
            position: relative;
            margin: 1em 0 0;
        }

        .wpt-tests-block:not([open]) summary {
            position: absolute;
            right: 0;
            bottom: 0;
        }

        /*
   It is possible that both the last child of a block element
   and the block element itself
   would be annotated with a <wpt> block each.
   If the block element has a padding or a border,
   that's fine, but otherwise
   the bottom margin of the block and of its last child would collapse
   and both <wpt> elements would overlap, being both placed there.
   To avoid that, add 1px of padding to the <wpt> element annotating the last child
   to prevent the bottom margin of the block and of its last child from collapsing
   (and as much negative margin,
   as wel only want to prevent margin collapsing,
   but are not trying to actually take more space).
*/
        .wpt-tests-block:not([open]):last-child {
            padding-bottom: 1px;
            margin-bottom: -1px;
        }

        /*
   Exception to the previous rule:
   don't do that in non-last list items,
   because it's not necessary,
   and would therefore consume more space than strictly needed.
   Lists must have list items as children, not <wpt> elements,
   so a <wpt> element cannot be a sibling of a list item,
   and the collision that the previous rule avoids cannot happen.
*/
        li:not(:last-child)>.wpt-tests-block:not([open]):last-child,
        dd:not(:last-child)>.wpt-tests-block:not([open]):last-child {
            padding-bottom: 0;
            margin-bottom: 0;
        }

        .wpt-tests-block:not([open]):not(:hover) {
            opacity: 0.5;
        }

        .wpt-tests-list {
            list-style: none;
            display: grid;
            margin: 0;
            padding: 0;
            grid-template-columns: 1fr max-content auto auto;
            grid-column-gap: .5em;
        }

        .wpt-tests-block hr:last-child {
            display: none;
        }

        .wpt-test {
            display: contents;
        }

        .wpt-test>a {
            text-decoration: underline;
            border: none;
        }

        .wpt-test>.wpt-name {
            grid-column: 1;
        }

        .wpt-test>.wpt-results {
            grid-column: 2;
        }

        .wpt-test>.wpt-live {
            grid-column: 3;
        }

        .wpt-test>.wpt-source {
            grid-column: 4;
        }

        .wpt-test>.wpt-results {
            display: flex;
            gap: .1em;
        }

        .wpt-test .wpt-result {
            display: inline-block;
            height: 1em;
            width: 1em;
            border-radius: 50%;
            position: relative;
        }
    </style>

<body class="h-entry">
    <div class="head">
        <p data-fill-with="logo"><a class="logo" href="https://www.w3.org/"> <img alt="W3C" height="48"
                    src="https://www.w3.org/StyleSheets/TR/2021/logos/W3C" width="72"> </a> </p>
        <h1 class="p-name no-ref" id="title">URLフラグメントテキストディレクティブ</h1>
        <p id="w3c-state"><a href="https://www.w3.org/standards/types#CG-DRAFT">ドラフトコミュニティグループレポート</a>, <time
                class="dt-updated" datetime="2023-12-13">2023年12月13日</time></p>
        <div data-fill-with="spec-metadata">
            <dl>
                <dt>このバージョン:
                <dd><a class="u-url"
                        href="https://wicg.github.io/scroll-to-text-fragment/">https://wicg.github.io/scroll-to-text-fragment/</a>
                <dt>課題の追跡:
                <dd><a href="https://github.com/wicg/scroll-to-text-fragment/issues/">GitHub</a>
                <dd><a href="#issues-index">仕様内インライン</a>
                <dt class="editor">編集者:
                <dd class="editor p-author h-card vcard"><a class="p-name fn u-email email"
                        href="mailto:nburris@chromium.org">Nick Burris</a> (<a class="p-org org"
                        href="https://www.google.com">Google</a>)
                <dd class="editor p-author h-card vcard"><a class="p-name fn u-email email"
                        href="mailto:bokan@chromium.org">David Bokan</a> (<a class="p-org org"
                        href="https://www.google.com">Google</a>)
                <dt>テストスイート:
                <dd class="wpt-overview"><a
                        href="https://wpt.fyi/results/scroll-to-text-fragment/">https://wpt.fyi/results/scroll-to-text-fragment/</a>
            </dl>
        </div>
        <div data-fill-with="warning"></div>
        <p class="copyright" data-fill-with="copyright"><a href="https://www.w3.org/policies/#copyright">Copyright</a> ©
            2023 the Contributors to the URL Fragment Text Directives Specification, published by the <a
                href="https://www.w3.org/community/wicg/">Web Platform Incubator Community Group</a> under the <a
                href="https://www.w3.org/community/about/agreements/cla/">W3C Community Contributor License Agreement
                (CLA)</a>.
            A human-readable <a href="http://www.w3.org/community/about/agreements/cla-deed/">summary</a> is available.
        </p>
        <hr title="Separator for header">
    </div>
    <div class="p-summary" data-fill-with="abstract">
        <h2 class="no-num no-toc no-ref heading settled" id="abstract"><span class="content">概要</span></h2>
        <p>テキストディレクティブはURLのフラグメントでテキストスニペットを指定する機能を追加します。

            このようなフラグメントを含むURLに移動すると、ユーザーエージェントはその部分を強調表示したり、ユーザーの注意を引いたりすることができます。</p>
    </div>
    <div data-fill-with="at-risk"></div>
    <h2 class="no-num no-toc no-ref heading settled" id="status"><span class="content">この文書のステータス</span>
    </h2>
    <div data-fill-with="status">
        <p> この仕様は<a href="https://www.w3.org/community/wicg/">Web Platform Incubator Community Group</a>によって公開されました。
            これはW3C標準ではなく、W3C標準トラックにもありません。

            <a
                href="https://www.w3.org/community/about/agreements/cla/">W3Cコミュニティ貢献者ライセンス契約（CLA）</a>の下で、制限付きのオプトアウトおよびその他の条件が適用されることにご留意ください。

            <a href="http://www.w3.org/community/">W3Cコミュニティおよびビジネスグループ</a>の詳細をご覧ください。
        </p>
        <p></p>
    </div>
    <div data-fill-with="at-risk"></div>
    <nav data-fill-with="table-of-contents" id="toc">
        <h2 class="no-num no-toc no-ref" id="contents">目次</h2>
        <ol class="toc" role="directory">
            <li><a href="#infrastructure"><span class="secno">1</span> <span class="content">インフラストラクチャ</span></a>
            <li>
                <a href="#introduction"><span class="secno">2</span> <span class="content">はじめに</span></a>
                <ol class="toc">
                    <li>
                        <a href="#use-cases"><span class="secno">2.1</span> <span class="content">ユースケース</span></a>
                        <ol class="toc">
                            <li><a href="#web-text-references"><span class="secno">2.1.1</span> <span
                                        class="content">Webテキスト参照</span></a>
                            <li><a href="#user-sharing"><span class="secno">2.1.2</span> <span
                                        class="content">ユーザー共有</span></a>
                        </ol>
                    <li><a href="#link-lifetime"><span class="secno">2.2</span> <span
                                class="content">リンクの有効期間</span></a>
                </ol>
            <li>
                <a href="#description"><span class="secno">3</span> <span class="content">説明</span></a>
                <ol class="toc">
                    <li><a href="#indication"><span class="secno">3.1</span> <span class="content">指示</span></a>
                    <li>
                        <a href="#syntax"><span class="secno">3.2</span> <span class="content">構文</span></a>
                        <ol class="toc">
                            <li><a href="#context-terms"><span class="secno">3.2.1</span> <span
                                        class="content">コンテキスト用語</span></a>
                            <li><a href="#bidi-considerations"><span class="secno">3.2.2</span> <span
                                        class="content">双方向（BiDi）の考慮事項</span></a>
                        </ol>
                    <li>
                        <a href="#the-fragment-directive"><span class="secno">3.3</span> <span
                                class="content">フラグメントディレクティブ</span></a>
                        <ol class="toc">
                            <li><a href="#extracting-the-fragment-directive"><span class="secno">3.3.1</span> <span
                                        class="content">フラグメントディレクティブの抽出</span></a>
                            <li><a href="#applying-directives-to-a-document"><span class="secno">3.3.2</span> <span
                                        class="content">ドキュメントへのディレクティブ適用</span></a>
                            <li><a href="#fragment-directive-grammar"><span class="secno">3.3.3</span> <span
                                        class="content">フラグメントディレクティブの文法</span></a>
                        </ol>
                    <li>
                        <a href="#text-directives"><span class="secno">3.4</span> <span
                                class="content">テキストディレクティブ</span></a>
                        <ol class="toc">
                            <li><a href="#invoking-text-directives"><span class="secno">3.4.1</span> <span
                                        class="content">テキストディレクティブの呼び出し</span></a>
                        </ol>
                    <li>
                        <a href="#security-and-privacy"><span class="secno">3.5</span> <span
                                class="content">セキュリティとプライバシー</span></a>
                        <ol class="toc">
                            <li><a href="#motivation"><span class="secno">3.5.1</span> <span
                                        class="content">動機</span></a>
                            <li><a href="#scroll-on-navigation"><span class="secno">3.5.2</span> <span
                                        class="content">ナビゲーション時のスクロール</span></a>
                            <li><a href="#search-timing"><span class="secno">3.5.3</span> <span
                                        class="content">検索タイミング</span></a>
                            <li><a href="#restricting-the-text-fragment"><span class="secno">3.5.4</span> <span
                                        class="content">テキストフラグメントの制限</span></a>
                            <li><a href="#restricting-scroll-on-load"><span class="secno">3.5.5</span> <span
                                        class="content">ロード時のスクロール制限</span></a>
                        </ol>
                    <li>
                        <a href="#navigating-to-text-fragment"><span class="secno">3.6</span> <span
                                class="content">テキストフラグメントへのナビゲーション</span></a>
                        <ol class="toc">
                            <li><a href="#finding-ranges-in-a-document"><span class="secno">3.6.1</span> <span
                                        class="content">ドキュメント内の範囲の特定</span></a>
                            <li><a href="#word-boundaries"><span class="secno">3.6.2</span> <span
                                        class="content">単語境界</span></a>
                        </ol>
                    <li>
                        <a href="#indicating-the-text-match"><span class="secno">3.7</span> <span
                                class="content">一致したテキストの指示</span></a>
                        <ol class="toc">
                            <li>
                                <a href="#urls-in-ua-features"><span class="secno">3.7.1</span> <span
                                        class="content">UA機能のURL表示</span></a>
                                <ol class="toc">
                                    <li><a href="#urls-in-location-bar"><span class="secno">3.7.1.1</span> <span
                                                class="content">ロケーションバー</span></a>
                                    <li><a href="#urls-in-bookmarks"><span class="secno">3.7.1.2</span> <span
                                                class="content">ブックマーク</span></a>
                                    <li><a href="#urls-in-sharing"><span class="secno">3.7.1.3</span> <span
                                                class="content">共有</span></a>
                                </ol>
                        </ol>
                    <li><a href="#document-policy-integration"><span class="secno">3.8</span> <span
                                class="content">Document Policyとの統合</span></a>
                    <li><a href="#feature-detectability"><span class="secno">3.9</span> <span
                                class="content">機能検出について</span></a>
                </ol>
            <li>
                <a href="#generating-text-fragment-directives"><span class="secno">4</span> <span
                        class="content">テキストフラグメントディレクティブ生成</span></a>
                <ol class="toc">
                    <li><a href="#prefer-exact-matching-to-range-based"><span class="secno">4.1</span> <span
                                class="content">範囲一致より完全一致を優先</span></a>
                    <li><a href="#use-context-only-when-necessary"><span class="secno">4.2</span> <span
                                class="content">文脈指定は必要時のみ</span></a>
                    <li><a href="#determine-if-fragment-id-is-needed"><span class="secno">4.3</span> <span
                                class="content">フラグメントIDの要否判定</span></a>
                </ol>
            <li>
                <a href="#w3c-conformance"><span class="secno"></span> <span class="content">適合性</span></a>
                <ol class="toc">
                    <li><a href="#w3c-conventions"><span class="secno"></span> <span class="content">ドキュメント慣例</span></a>
                </ol>
            <li>
                <a href="#index"><span class="secno"></span> <span class="content">索引</span></a>
                <ol class="toc">
                    <li><a href="#index-defined-here"><span class="secno"></span> <span
                                class="content">本仕様で定義される用語</span></a>
                    <li><a href="#index-defined-elsewhere"><span class="secno"></span> <span
                                class="content">参考規格によって定義される用語</span></a>
                </ol>
            <li>
                <a href="#references"><span class="secno"></span> <span class="content">参考文献</span></a>
                <ol class="toc">
                    <li><a href="#normative"><span class="secno"></span> <span class="content">規範参考文献</span></a>
                    <li><a href="#informative"><span class="secno"></span> <span class="content">参考情報</span></a>
                </ol>
            <li><a href="#idl-index"><span class="secno"></span> <span class="content">IDL索引</span></a>
            <li><a href="#issues-index"><span class="secno"></span> <span class="content">課題索引</span></a>
        </ol>
    </nav>
    <main>
        <h2 class="heading settled" data-level="1" id="infrastructure"><span class="secno">1. </span><span
                class="content">インフラストラクチャ</span><a class="self-link" href="#infrastructure"></a></h2>
        <p>この仕様はInfra Standardに依存しています。<a data-link-type="biblio" href="#biblio-infra"
                title="Infra Standard">[INFRA]</a> </p>
        <h2 class="heading settled" data-level="2" id="introduction"><span class="secno">2. </span><span
                class="content">はじめに</span><a class="self-link" href="#introduction"></a></h2>
        <div class="note" role="note">このセクションは規範的ではありません</div>
        <h3 class="heading settled" data-level="2.1" id="use-cases"><span class="secno">2.1. </span><span
                class="content">ユースケース</span><a class="self-link" href="#use-cases"></a></h3>
        <h4 class="heading settled" data-level="2.1.1" id="web-text-references"><span class="secno">2.1.1. </span><span
                class="content">Webテキスト参照</span><a class="self-link" href="#web-text-references"></a></h4>
        テキストフラグメントの主なユースケースは、URLがWeb全体で正確なテキスト参照として機能することです。例えば、Wikipediaの参照はページから引用している正確なテキストにリンクできます。同様に、検索エンジンはページの先頭ではなく、ユーザーが探している答えがある場所へ誘導するURLを提供することができます。
        <h4 class="heading settled" data-level="2.1.2" id="user-sharing"><span class="secno">2.1.2. </span><span
                class="content">ユーザー共有</span><a class="self-link" href="#user-sharing"></a></h4>
        テキストディレクティブを使うことで、ブラウザはユーザーがテキスト選択部分でコンテキストメニューを開いたときに「ここへのURLをコピー」というオプションを実装できるかもしれません。ブラウザは選択したテキストを適切に指定したURLを生成し、そのURLの受信者に指定されたテキストが分かりやすく示されます。テキストフラグメントがなければ、ユーザーがページ内のテキストを共有したい時は、通常そのテキストをコピー＆ペーストすることになりますが、その場合、受信者はページのコンテキストを失ってしまいます。
        <h3 class="heading settled" data-level="2.2" id="link-lifetime"><span class="secno">2.2. </span><span
                class="content">リンクの有効期間</span><a class="self-link" href="#link-lifetime"></a></h3>
        <p>この仕様は、例えば実際のテキスト内容をURLのペイロードとして使用したり、フォールバックとして要素IDのフラグメントを許可することにより、テキストディレクティブリンクの有用な有効期間を最大化しようとしています。しかし、Web上のページはしばしば更新され、内容が変化します。そのため、このようなリンクは参照先のテキスト内容が目的のページから無くなってしまい「リンク切れ」を起こす場合があります。
        </p>
        <p>この問題があってもテキストディレクティブリンクは有用です。ユーザー共有のユースケースでは、リンクは送信してから短期間のみ利用されることが多く、一時的なものです。参照やWebページのリンクのような長期間にわたって利用される場合でも、テキストディレクティブは通常のリンクに緩やかに劣化するので価値があります。また、古くなったテキストディレクティブがあることで、ユーザーがリンク作成者の意図やその後ページ内容が変わったことを理解する助けになります。
        </p>
        <p>強固なテキストディレクティブリンクの作成方法については<a href="#generating-text-fragment-directives">§ 4
                テキストフラグメントディレクティブの生成</a>を参照してください。</p>
        <h2 class="heading settled" data-level="3" id="description"><span class="secno">3. </span><span
                class="content">説明</span><a class="self-link" href="#description"></a></h2>
        <h3 class="heading settled" data-level="3.1" id="indication"><span class="secno">3.1. </span><span
                class="content">指示</span><a class="self-link" href="#indication"></a></h3>
        <div class="note" role="note">このセクションは規範的ではありません</div>
        <p>この仕様はユーザーエージェントがテキストの一致を「指示」する際に取るアクションを意図的に定義しません。ユーザーエージェントにより異なる体験やトレードオフが考えられます。可能なアクション例:</p>
        <ul>
            <li data-md>
                <p>テキスト部分を視覚的に強調またはハイライトする</p>
            <li data-md>
                <p>ページ移動時に自動的にその部分までスクロールする</p>
            <li data-md>
                <p>該当テキスト部分でUAのページ内検索機能を起動する</p>
            <li data-md>
                <p>「クリックしてテキスト部分へスクロール」通知の表示</p>
            <li data-md>
                <p>該当テキスト部分がページ内に見つからない場合の通知の表示</p>
        </ul>
        <div class="note" role="note">どのアクションを選ぶかはユーザーのセキュリティやプライバシーに影響を与える場合があります。詳細は<a
                href="#security-and-privacy">§ 3.5 セキュリティとプライバシー</a>を参照してください。</div>
        <h3 class="heading settled" data-level="3.2" id="syntax"><span class="secno">3.2. </span><span
                class="content">構文</span><a class="self-link" href="#syntax"></a></h3>
        <div class="note" role="note">このセクションは規範的ではありません</div>
        <p><a data-link-type="dfn" href="#text-directive" id="ref-for-text-directive">テキストディレクティブ</a>は、<a
                data-link-type="dfn" href="#fragment-directive" id="ref-for-fragment-directive">フラグメントディレクティブ</a>(<a
                href="#the-fragment-directive">§ 3.3 フラグメントディレクティブ</a>参照)で次のフォーマットで指定されます:</p>
        <pre>#:~:text=[prefix-,]start[,end][,-suffix]
          context  |--match--|  context
</pre>
        <p><em>(角括弧はオプションパラメータを示します)</em></p>
        <p>テキストパラメータは一致前にパーセントデコードされます。テキストパラメータ内のダッシュ(-)、アンパサンド(&amp;)、カンマ(,)はテキストディレクティブ構文の一部と解釈されないようパーセントエンコードされます。
        </p>
        <p>唯一必須のパラメータは<code>start</code>です。<code>start</code>だけが指定された場合、その正確なテキストが最初に出現する箇所がターゲットテキストとなります。</p>
        <div class="example" id="example-4e85550d"><a class="self-link" href="#example-4e85550d"></a>
            <code>#:~:text=an%20example%20text%20fragment</code> は、"an example text fragment"
            という正確なテキストがターゲットとなることを示します。
        </div>
        <p><code>end</code>パラメータも指定された場合、テキストディレクティブはページ内のテキスト範囲を示します。ターゲット範囲は<code>start</code>の最初の出現から、その後に現れる<code>end</code>の最初の出現までの範囲です。これは<code>start</code>に全体のテキスト範囲を指定するのと同じですが、長いテキストディレクティブでURLが肥大化するのを防げます。
        </p>
        <div class="example" id="example-7df2027e"><a class="self-link" href="#example-7df2027e"></a>
            <code>#:~:text=an%20example,text%20fragment</code>は、"an example"が最初に出現してから、続けて現れる"text
            fragment"の最初までがターゲットテキストとなることを示します。
        </div>
        <h4 class="heading settled" data-level="3.2.1" id="context-terms"><span class="secno">3.2.1. </span><span
                class="content">コンテキスト用語</span><a class="self-link" href="#context-terms"></a></h4>
        <div class="note" role="note">このセクションは規範的ではありません</div>
        <p>他の2つのオプションパラメータはコンテキスト用語です。プレフィックスの後やサフィックスの前にダッシュ(-)を置くことで指定し、<code>start</code>や<code>end</code>パラメータと区別します。任意のオプションパラメータの組み合わせが可能です。
        </p>
        <p>コンテキスト用語はターゲットテキストフラグメントを区別するために使います。コンテキスト用語はフラグメント直前(プレフィックス)や直後(サフィックス)のテキストを指定でき、空白も許容されます。</p>
        <div class="note" role="note">
            マッチが成功するのはコンテキスト用語がターゲットのテキストフラグメントを挟んでいる場合ですが、その間にどれだけ空白が入っても構いません。たとえばフラグメントが段落の先頭にあり、前要素のテキストをプレフィックスにして区別したい場合など、コンテキスト用語が要素の境界をまたぐこともできます。
        </div>
        <p>コンテキスト用語はターゲットテキストフラグメントには含まれず、視覚的にも指示されません。</p>
        <div class="example" id="example-5c87b699"><a class="self-link" href="#example-5c87b699"></a>
            <code>#:~:text=this%20is-,an%20example,-text%20fragment</code> は "this is an example text fragment" の "an
            example" に一致しますが、"here is an example text" の "an example" には一致しません。
        </div>
        <h4 class="heading settled" data-level="3.2.2" id="bidi-considerations"><span class="secno">3.2.2. </span><span
                class="content">双方向（BiDi）の考慮事項</span><a class="self-link" href="#bidi-considerations"></a></h4>
        <div class="note" role="note">このセクションは規範的ではありません</div>
        <div class="note" role="note"> <a
                href="https://www.w3.org/International/articles/inline-bidi-markup/uba-basics.en">Unicode
                双方向アルゴリズムの基本</a>を参照すると、双方向テキストの仕組みがよくわかります。 </div>
        <p>URL文字列はASCIIエンコードなので、双方向テキストを組み込むサポートはありません。ただし、対象とするページ内容はLTR(左から右)、RTL(右から左)、あるいは両方(双方向/BiDi)となり得ます。このセクションは、仕様の規範的セクションで暗黙的に記述された挙動の直感的な説明を提供します。
        </p>
        <p>テキストフラグメント内の各項目の文字は<em>論理順序</em>です。つまり、母語話者が読む順番（かつメモリ上の文字の格納順）です。</p>
        <p>同様に<code>prefix</code>や<code>start</code>用語は論理順で他の用語の前、<code>suffix</code>や<code>end</code>は論理順で後ろにあるテキストを特定します。
        </p>
        <p class="note" role="note"><span
                class="marker">注:</span>ユーザーエージェントは、表示時にURL文字列をUnicodeへ変換するなど、母語話者向けに視覚的な表示を工夫できますが、URLの文字列表現は純粋なASCIIのままです。
        </p>
        <div class="example" id="example-b17c0d6b">
            <a class="self-link" href="#example-b17c0d6b"></a> 例えば<code lang="ar">مِصر‎</code>(エジプト、アラビア語)を、<code
                lang="ar">البحرين‎</code>(バーレーン、アラビア語)が直前にある形で選択したい場合、まず各項目をパーセントエンコードします:
            <p><code lang="ar">مِصر‎</code> は "%D9%85%D8%B5%D8%B1" になります（注: UTF-8文字[0xD9,0x85]がアラビア語単語の最初(右端)の文字）。</p>
            <p><code lang="ar">البحرين‎</code> は "%D8%A7%D9%84%D8%A8%D8%AD%D8%B1%D9%8A%D9%86" になります。</p>
            <p>テキストフラグメントはこうなります:</p>
            <p><code> :~:text=%D8%A7%D9%84%D8%A8%D8%AD%D8%B1%D9%8A%D9%86-,%D9%85%D8%B5%D8%B1 </code></p>
            <p>ブラウザのアドレスバーでは、自然なRTL方向で視覚的に表示され、ユーザーには次のように見えます:</p>
            <p><code> :~:text=<span lang="ar">البحرين</span>-,<span lang="ar">مِصر</span> </code></p>
        </div>
        <h3 class="heading settled" data-level="3.3" id="the-fragment-directive"><span class="secno">3.3. </span><span
                class="content">フラグメントディレクティブ</span><a class="self-link" href="#the-fragment-directive"></a>
        </h3>
        <p>既存のURLフラグメントの利用と互換性の問題を避けるため、この仕様では<dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport
                id="fragment-directive">フラグメントディレクティブ</dfn>という概念を導入します。これはURL<a data-link-type="dfn"
                href="https://url.spec.whatwg.org/#concept-url-fragment"
                id="ref-for-concept-url-fragment">フラグメント</a>のうち、<a data-link-type="dfn"
                href="#fragment-directive-delimiter"
                id="ref-for-fragment-directive-delimiter">フラグメントディレクティブ区切り子</a>の後ろの部分であり、区切り子が現れなければnullになり得ます。</p>
        <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport
                id="fragment-directive-delimiter">フラグメントディレクティブ区切り子</dfn>は":~:"という文字列、すなわち3連続するU+003A(:)、U+007E(~)、U+003A(:)のコードポイントです。
        </p>
        <div class="note" role="note"> <a data-link-type="dfn" href="#fragment-directive"
                id="ref-for-fragment-directive①">フラグメントディレクティブ</a>はURLフラグメントの一部です。そのため、常にURLにU+0023(#)コードポイントの後ろに現れます。
        </div>
        <div class="example" id="example-6998d91f"><a class="self-link" href="#example-6998d91f"></a>
            https://example.com のようなURLに<a data-link-type="dfn" href="#fragment-directive"
                id="ref-for-fragment-directive②">フラグメントディレクティブ</a>を追加するには、まずフラグメントを付与します:
            https://example.com#:~:text=foo. </div>
        <p>フラグメントディレクティブは解析され、ユーザーエージェントに何らかのアクションを実行するよう指示する<dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport
                id="directives">ディレクティブ</dfn>として個別に処理されます。一つのフラグメントディレクティブ内に複数のディレクティブを記述できます。</p>
        <div class="note" role="note"> 本仕様で導入された唯一のディレクティブはテキストディレクティブですが、今後他のディレクティブが追加される可能性もあります。 </div>
        <div class="example" id="example-9acce0ff">
            <a class="self-link" href="#example-9acce0ff"></a>
            <code>https://example.com#:~:text=foo&amp;text=bar&amp;unknownDirective</code>
            <p>2つのテキストディレクティブと1つの未知のディレクティブを含みます。</p>
        </div>
        <p>ページ動作への影響を避けるため、著者のスクリプトとの相互作用を防ぐ目的でスクリプトからアクセス可能なAPIではこれを削除します。これにより、将来新たなディレクティブを追加してもWeb互換性リスクを回避できます。</p>
        <h4 class="heading settled" data-level="3.3.1" id="extracting-the-fragment-directive"><span class="secno">3.3.1.
            </span><span class="content">フラグメントディレクティブの抽出</span><a class="self-link"
                href="#extracting-the-fragment-directive"></a></h4>
        <p>このセクションでは、フラグメントディレクティブがスクリプトから隠される仕組みと、それが<a
                href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigation-and-session-history"><cite>HTML</cite>
                § 7.4 ナビゲーションとセッション履歴</a>にどのように組み込まれるかについて説明します。</p>
        <div class="note" role="note">
            このセクションの変更点のまとめ:
            <ul>
                <li data-md>
                    <p>セッション履歴エントリに新しい「ディレクティブ状態」項目が含まれるようになりました</p>
                <li data-md>
                    <p>すべての新しいエントリは空値を持つディレクティブ状態で作成されます。新しいURLにフラグメントディレクティブが含まれていれば、それが状態値に書き込まれます（そうでなければnullのままです）。
                    </p>
                <li data-md>
                    <p>フラグメントディレクティブを含む可能性のあるURLがセッション履歴エントリに書き込まれるたびに、URLからフラグメントディレクティブを抽出し、そのエントリのディレクティブ状態項目に格納します。ディレクティブを含む可能性があるのは次の4つのタイミングです:
                    </p>
                    <ul>
                        <li data-md>
                            <p>通常のクロスドキュメントナビゲーションの「navigate」手順中</p>
                        <li data-md>
                            <p>フラグメントベースの同一ドキュメントナビゲーションの「navigate to a fragment」手順中</p>
                        <li data-md>
                            <p>pushState/replaceStateなどの同期更新時「URL and history update steps」</p>
                        <li data-md>
                            <p>リダイレクト由来のURL用「create navigation params by fetching」手順中</p>
                    </ul>
                <li data-md>
                    <p>フラグメントのみを変更し、新しいURLにディレクティブが指定されていない同一ドキュメントナビゲーションは、前のエントリのディレクティブ状態を引き継ぐ新しいエントリを作成します。</p>
            </ul>
        </div>
        <p><a href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#session-history-infrastructure"><cite>HTML</cite>
                § 7.4.1 セッション履歴</a>で<a data-link-type="dfn" href="#directive-state"
                id="ref-for-directive-state">ディレクティブ状態</a>を定義します:</p>
        <blockquote>
            <p><strong><a
                        href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#session-history-infrastructure"><cite>HTML</cite>
                        § 7.4.1 セッション履歴</a>へのモンキーパッチ:</strong></p>
            <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="directive-state">ディレクティブ状態</dfn>
                は、セッション履歴エントリ作成時の<a data-link-type="dfn" href="#fragment-directive"
                    id="ref-for-fragment-directive③">フラグメントディレクティブ</a>の値を保持し、エントリを辿るたびにテキストハイライトなどのディレクティブを起動するために使用されます。次の内容を持ちます:
            </p>
            <ul>
                <li data-md>
                    <p><dfn class="dfn-paneled" data-dfn-for="directive state" data-dfn-type="dfn" data-noexport
                            id="directive-state-value">value</dfn>：<a data-link-type="dfn" href="#fragment-directive"
                            id="ref-for-fragment-directive④">フラグメントディレクティブ</a>またはnullの<a data-link-type="dfn"
                            href="https://infra.spec.whatwg.org/#ascii-string"
                            id="ref-for-ascii-string">ASCII文字列</a>。初期値はnull。</p>
            </ul>
            <p><a data-link-type="dfn" href="#directive-state"
                    id="ref-for-directive-state①">ディレクティブ状態</a>は、複数のセッション履歴エントリで共有される場合があります。</p>
            <div class="note" role="note">
                <p>フラグメントディレクティブはURLから削除され、セッション履歴エントリにセットされる前にディレクティブ状態に格納されます。これにより、スクリプトAPIから見えなくなり、ページ動作に影響を与えずにディレクティブを指定できます。
                </p>
                <p>ディレクティブは生の文字列ではなくディレクティブ状態オブジェクト内に格納されます。これは、同一のディレクティブ状態が複数の連続した履歴エントリで共有できるようにするためです。トラバース時、2つのエントリ間でディレクティブ状態が変化した場合のみ（＝新規ハイライト等が必要な時）ディレクティブが処理されます。
                </p>
            </div>
        </blockquote>
        <p><a
                href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#session-history-entry">セッション履歴エントリ</a>の定義に、次を追加します:
        </p>
        <blockquote>
            <p><strong><a
                        href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#session-history-entries"><cite>HTML</cite>
                        § 7.4.1.1 セッション履歴エントリ</a>へのモンキーパッチ:</strong></p>
            <div class="monkeypatch">
                セッション履歴エントリは以下の項目を持つ構造体です:
                <ul>
                    <li data-md>
                        <p>...</p>
                    <li data-md>
                        <p>永続化ユーザー状態（実装依存・初期値null）</p>
                    <li data-md>
                        <p><span class="diff"><dfn class="dfn-paneled" data-dfn-for="she" data-dfn-type="dfn"
                                    data-noexport id="she-directive-state">ディレクティブ状態</dfn>：<a data-link-type="dfn"
                                    href="#directive-state" id="ref-for-directive-state②">ディレクティブ状態</a>。初期値は新規<a
                                    data-link-type="dfn" href="#directive-state"
                                    id="ref-for-directive-state③">ディレクティブ状態</a>
                            </span></p>
                </ul>
            </div>
        </blockquote>
        <p><a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url"
                id="ref-for-concept-url">URL</a>からフラグメントディレクティブ文字列を削除・返却するヘルパーアルゴリズムを追加します:</p>
        <blockquote>
            <p><strong><a data-link-type="biblio" href="#biblio-html"
                        title="HTML Standard">[HTML]</a>へのモンキーパッチ:</strong></p>
            <div class="note" role="note"> このアルゴリズムはURLのフラグメントを<a data-link-type="dfn"
                    href="#fragment-directive-delimiter"
                    id="ref-for-fragment-directive-delimiter①">フラグメントディレクティブ区切り子</a>手前までにします。戻り値の<a data-link-type="dfn"
                    href="#fragment-directive"
                    id="ref-for-fragment-directive⑤">フラグメントディレクティブ</a>は区切り子以降すべての文字を含み、区切り子自体は含みません。 </div>
            <div class="issue" id="issue-f4a5d96b"><a class="self-link" href="#issue-f4a5d96b"></a> TODO:
                フラグメントが':~:'で終わる（空ディレクティブ）の場合、nullを返します。これは明示的ディレクティブ未指定扱い（既存を上書きしない）ですが、空文字列を返すべき？
                '#:~:'へのnavigate/pushStateで明示的にディレクティブやハイライトを解除できるよう配慮する案。</div>
            <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport
                    id="remove-the-fragment-directive">フラグメントディレクティブを除去</dfn>するには、<a data-link-type="dfn"
                    href="https://url.spec.whatwg.org/#concept-url" id="ref-for-concept-url①">URL</a> <var>url</var>
                から、次の手順を実行する：</p>
            <ol>
                <li data-md>
                    <p><var>raw fragment</var> に <var>url</var> の<a data-link-type="dfn"
                            href="https://url.spec.whatwg.org/#concept-url-fragment"
                            id="ref-for-concept-url-fragment①">フラグメント</a>を代入</p>
                <li data-md>
                    <p><var>fragment directive</var> をnullにする</p>
                <li data-md>
                    <p><var>raw fragment</var>が非nullかつ<a data-link-type="dfn" href="#fragment-directive-delimiter"
                            id="ref-for-fragment-directive-delimiter②">フラグメントディレクティブ区切り子</a>を含む場合:</p>
                    <ol>
                        <li data-md>
                            <p><var>position</var> に、<var>raw fragment</var>内で<a data-link-type="dfn"
                                    href="#fragment-directive-delimiter"
                                    id="ref-for-fragment-directive-delimiter③">区切り子</a>が最初に現れるコードポイントの<a
                                    data-link-type="dfn" href="https://infra.spec.whatwg.org/#string-position-variable"
                                    id="ref-for-string-position-variable">位置変数</a>を代入。なければ末尾＋1。</p>
                        <li data-md>
                            <p><var>new fragment</var> に、<var>raw fragment</var>の先頭から<var>position</var>直前までの<a
                                    data-link-type="dfn"
                                    href="https://infra.spec.whatwg.org/#code-point-substring-by-positions"
                                    id="ref-for-code-point-substring-by-positions">部分文字列</a>を代入。</p>
                        <li data-md>
                            <p><var>position</var> を<a data-link-type="dfn"
                                    href="https://infra.spec.whatwg.org/#string-code-point-length"
                                    id="ref-for-string-code-point-length">区切り子のコードポイント長</a>だけ進める。</p>
                        <li data-md>
                            <p><var>position</var>が<var>raw fragment</var>末尾を超えていなければ:</p>
                            <ol>
                                <li data-md>
                                    <p><var>fragment directive</var>に、<var>raw fragment</var>の<var>position</var>以降の<a
                                            data-link-type="dfn"
                                            href="https://infra.spec.whatwg.org/#code-point-substring-to-the-end-of-the-string"
                                            id="ref-for-code-point-substring-to-the-end-of-the-string">部分文字列</a>をセット</p>
                            </ol>
                        <li data-md>
                            <p><var>url</var>の<a data-link-type="dfn"
                                    href="https://url.spec.whatwg.org/#concept-url-fragment"
                                    id="ref-for-concept-url-fragment②">フラグメント</a>を<var>new fragment</var>にする</p>
                    </ol>
                <li data-md>
                    <p><var>fragment directive</var> を返す</p>
            </ol>
            <div class="example" id="example-775c8cc2"><a class="self-link" href="#example-775c8cc2"></a>
                <code>https://example.org/#test:~:text=foo</code> はフラグメントが"test"、<a data-link-type="dfn"
                    href="#fragment-directive"
                    id="ref-for-fragment-directive⑥">フラグメントディレクティブ</a>が"text=foo"になるようにパースされます。
            </div>
        </blockquote>
        <p>以降の4つのモンキーパッチは、フラグメントディレクティブが含まれる可能性があるURLでセッション履歴エントリ作成時に、フラグメントディレクティブを除去して<a data-link-type="dfn"
                href="#directive-state" id="ref-for-directive-state④">ディレクティブ状態</a>へ保存する点を修正します。</p>
        <p><a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigate"
                id="ref-for-navigate">navigate</a>の定義では:</p>
        <blockquote>
            <p><strong><a
                        href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#beginning-navigation"><cite>HTML</cite>
                        § 7.4.2.2 ナビゲーション開始</a>へのモンキーパッチ:</strong></p>
            <div class="monkeypatch">
                ナビゲーブルなnavigableをURL<var>url</var>にナビゲートするには...:
                <ol>
                    <li data-md>
                        <p>...</p>
                    <li value="14">navigableのongoing navigationをnavigationIdに設定
                    <li data-md>
                        <p>urlのスキームが"javascript"なら...</p>
                    <li data-md>
                        <p>並列で次の手順を実行:</p>
                        <ol>
                            <li data-md>
                                <p>...</p>
                            <li value="5">urlがabout:blankならdocumentStateのoriginにinitiator originを設定
                            <li data-md>
                                <p>そうでなくabout:srcdocならdocumentStateのoriginにnavigableの親のアクティブドキュメントoriginを設定</p>
                            <li data-md>
                                <strike>historyEntryを新規セッション履歴エントリにし、そのURLをurl、document stateをdocumentStateに設定。</strike>
                            <li value="7"><span class="diff"><var>fragment directive</var>に<a data-link-type="dfn"
                                        href="#remove-the-fragment-directive"
                                        id="ref-for-remove-the-fragment-directive">フラグメントディレクティブを削除</a>を<var>url</var>で実行した結果を代入。</span>
                            <li data-md>
                                <p><span class="diff"><var>directive state</var>を新しい<a data-link-type="dfn"
                                            href="#directive-state" id="ref-for-directive-state⑤">ディレクティブ状態</a>（<a
                                            data-link-type="dfn" href="#directive-state-value"
                                            id="ref-for-directive-state-value">value</a>に<var>fragment
                                            directive</var>セット）として作成</span></p>
                            <li data-md>
                                <p><span class="diff">historyEntryを新規セッション履歴エントリ（URLは<var>url</var>、document
                                        stateはdocumentState、<a data-link-type="dfn" href="#she-directive-state"
                                            id="ref-for-she-directive-state">ディレクティブ状態</a>は<var>directive
                                            state</var>）に設定</span></p>
                            <li data-md>
                                <p>navigationParamsをnullに設定</p>
                            <li data-md>
                                <p>...</p>
                        </ol>
                </ol>
            </div>
        </blockquote>
        <p><a href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigate-fragid"
                id="319d7c290">navigate to a fragment</a>の定義では:</p>
        <blockquote>
            <p><strong><a
                        href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#scroll-to-fragid"><cite>HTML</cite>
                        § 7.4.2.3.3 フラグメントナビゲーション</a>へのモンキーパッチ:</strong></p>
            <div class="monkeypatch">
                ナビゲーブルnavigableでフラグメントにナビゲートするには...:
                <ol>
                    <li data-md>
                        <p><span class="diff"><var>directive state</var>にnavigableのアクティブセッション履歴エントリの<a
                                    data-link-type="dfn" href="#she-directive-state"
                                    id="ref-for-she-directive-state①">ディレクティブ状態</a>を代入</span></p>
                    <li data-md>
                        <p><span class="diff"><var>fragment directive</var>に<a data-link-type="dfn"
                                    href="#remove-the-fragment-directive"
                                    id="ref-for-remove-the-fragment-directive①">フラグメントディレクティブを削除</a>を<var>url</var>で実行した結果を代入</span>
                        </p>
                    <li data-md>
                        <p><span class="diff"><var>fragment directive</var>がnullでなければ：</span></p>
                        <div class="note" role="note">フラグメントのみ変更かつディレクティブ未指定なら、アクティブエントリのディレクティブ状態を再利用（＝ハイライト維持）。</div>
                        <ol>
                            <li data-md>
                                <p><span class="diff"><var>directive state</var>に新規<a data-link-type="dfn"
                                            href="#directive-state" id="ref-for-directive-state⑥">ディレクティブ状態</a>（<a
                                            data-link-type="dfn" href="#directive-state-value"
                                            id="ref-for-directive-state-value①">value</a>は<var>fragment
                                            directive</var>）を設定</span></p>
                        </ol>
                    <li data-md>
                        <p>historyEntryを新規セッション履歴エントリとして:</p>
                        <ul>
                            <li data-md>
                                <p>URL: url</p>
                            <li data-md>
                                <p>document state: navigableのアクティブセッション履歴エントリのdocument state</p>
                            <li data-md>
                                <p>scroll restoration mode: navigableのアクティブセッション履歴エントリのscroll restoration mode</p>
                            <li data-md>
                                <p><span class="diff"><a data-link-type="dfn" href="#she-directive-state"
                                            id="ref-for-she-directive-state②">ディレクティブ状態</a>: <var>directive
                                            state</var></span></p>
                        </ul>
                    <li data-md>
                        <p>historyHandlingが"replace"ならentryToReplaceをnavigableのアクティブセッション履歴エントリに、そうでなければnullに設定</p>
                    <li data-md>
                        <p>...</p>
                </ol>
            </div>
        </blockquote>
        <p><a
                href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#url-and-history-update-steps">URLと履歴更新手順</a>の定義では:
        </p>
        <blockquote>
            <p><strong><a
                        href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigate-non-frag-sync"><cite>HTML</cite>
                        § 7.4.4 非フラグメント同期ナビゲーション</a>へのモンキーパッチ:</strong></p>
            <div class="monkeypatch">
                Document <var>document</var>でのURLと履歴更新手順は...:
                <ol>
                    <li data-md>
                        <p><var>navigable</var>に<var>document</var>のノードナビゲーブルを代入</p>
                    <li data-md>
                        <p><var>activeEntry</var>に<var>navigable</var>のアクティブセッション履歴エントリを代入</p>
                    <li data-md>
                        <p><span class="diff"><var>fragment directive</var>に<a data-link-type="dfn"
                                    href="#remove-the-fragment-directive"
                                    id="ref-for-remove-the-fragment-directive②">フラグメントディレクティブを削除</a>を<var>newUrl</var>で実行した結果を代入</span>
                        </p>
                    <li data-md>
                        <p><var>historyEntry</var>を新規セッション履歴エントリ（</p>
                        <ul>
                            <li data-md>
                                <p>URL: <var>newUrl</var></p>
                            <li data-md>
                                <p>...</p>
                            <li data-md>
                                <p><span class="diff"><a data-link-type="dfn" href="#she-directive-state"
                                            id="ref-for-she-directive-state③">ディレクティブ状態</a>:
                                        <var>activeEntry</var>の<a data-link-type="dfn" href="#she-directive-state"
                                            id="ref-for-she-directive-state④">ディレクティブ状態</a></span></p>
                        </ul>
                    <li data-md>
                        <p><var>document</var>のis initial about:blankがtrueならhistoryHandlingを"replace"にセット</p>
                    <li data-md>
                        <p>historyHandlingが"push"なら:</p>
                        <ol>
                            <li data-md>
                                <p>documentのhistory objectのindexをインクリメント</p>
                            <li data-md>
                                <p>history objectのlengthをindex+1に</p>
                            <li data-md>
                                <p><span class="diff"><var>newUrl</var>≠<var>activeEntry</var>のURL（fragment除去）または<var>fragment
                                            directive</var>がnullでなければ:</span></p>
                                <div class="note" role="note">フラグメントのみ変更＆ディレクティブ未指定ならアクティブエントリのディレクティブ状態再利用、ハイライト維持
                                </div>
                                <ol>
                                    <li data-md>
                                        <p><span class="diff"><var>historyEntry</var>の<a data-link-type="dfn"
                                                    href="#she-directive-state"
                                                    id="ref-for-she-directive-state⑤">ディレクティブ状態</a>を新規<a
                                                    data-link-type="dfn" href="#directive-state"
                                                    id="ref-for-directive-state⑦">ディレクティブ状態</a>（<a data-link-type="dfn"
                                                    href="#directive-state-value"
                                                    id="ref-for-directive-state-value②">value</a>は<var>fragment
                                                    directive</var>）に設定</span></p>
                                </ol>
                        </ol>
                    <li data-md>
                        <p><span class="diff">そうでなく、<var>fragment directive</var>がnullでなければ、<var>historyEntry</var>の<a
                                    data-link-type="dfn" href="#she-directive-state"
                                    id="ref-for-she-directive-state⑥">ディレクティブ状態</a>の<a data-link-type="dfn"
                                    href="#directive-state-value"
                                    id="ref-for-directive-state-value③">value</a>に<var>fragment
                                    directive</var>をセット</span></p>
                    <li data-md>
                        <p>serializedDataがnullでなければ、history object stateをdocumentとnewEntryで復元</p>
                </ol>
            </div>
        </blockquote>
        <p><a href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#create-navigation-params-by-fetching"
                id="fc0e1ad00"> create navigation params by fetching</a>の定義では:</p>
        <blockquote>
            <p><strong><a
                        href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#populating-a-session-history-entry"><cite>HTML</cite>
                        § 7.4.5 セッション履歴エントリの充填</a>へのモンキーパッチ:</strong></p>
            <div class="monkeypatch">
                session history entry <var>entry</var>でcreate navigation params by fetchingを行うには...:
                <ol>
                    <li data-md>
                        <p class="assertion">これは並列実行であるassert</p>
                    <li data-md>
                        <p>...</p>
                    <li value="17">currentURLにrequestのcurrent URLをセット
                    <li data-md>
                        <p>commitEarlyHintsをnullに</p>
                    <li data-md>
                        <p>while (true):</p>
                        <ol>
                            <li data-md>
                                <p>requestのreserved clientがnullでなく、currentURLのorigin≠reserved clientの生成URLのoriginなら:</p>
                            <li data-md>
                                <p>...</p>
                            <li value="21">currentURL = <var>locationURL</var>
                            <li data-md>
                                <p><span class="diff"><var>fragment directive</var>に<a data-link-type="dfn"
                                            href="#remove-the-fragment-directive"
                                            id="ref-for-remove-the-fragment-directive③">フラグメントディレクティブを削除</a>を<var>locationURL</var>で実行した結果を代入</span>
                                </p>
                            <li data-md>
                                <strike class="diff"><var>entry</var>のURLをcurrentURLに</strike>
                            <li data-md>
                                <p><span class="diff"><var>entry</var>のURLを<var>locationURL</var>に</span></p>
                            <li data-md>
                                <p><span class="diff"><var>entry</var>の<a data-link-type="dfn"
                                            href="#she-directive-state"
                                            id="ref-for-she-directive-state⑦">ディレクティブ状態</a>の<a data-link-type="dfn"
                                            href="#directive-state-value"
                                            id="ref-for-directive-state-value④">value</a>に<var>fragment
                                            directive</var>をセット</span></p>
                            <li data-md>
                                <p>locationURLのスキームがfetch schemeでなければ、initiator originをrequestのcurrent
                                    URLのoriginとした新規non-fetch scheme navigation paramsを返す</p>
                            <li data-md>
                                <p>...</p>
                        </ol>
                </ol>
            </div>
        </blockquote>
        <div class="note" role="note">
            <p> Documentは履歴エントリから生成されるため、その<a data-link-type="dfn"
                    href="https://dom.spec.whatwg.org/#concept-document-url" id="ref-for-concept-document-url">URL</a>
                にはフラグメントディレクティブが含まれません。またwindowの<code
                    class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/nav-history-apis.html#location" id="ref-for-location">Location</a></code>
                オブジェクトはアクティブドキュメントの<a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url"
                    id="ref-for-concept-url②">URL</a>表現であり、全getterでディレクティブを除去したバージョンが返ります。</p>
            <p> さらに、<code
                    class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/nav-history-apis.html#hashchangeevent" id="ref-for-hashchangeevent">HashChangeEvent</a></code>
                は<a
                    href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#updating-the-document">フラグメントの変更</a>に応じて
                セッション履歴エントリ間のURLの変化で発火しますが、ナビゲーションやトラバースでフラグメントディレクティブのみ変化した場合は
                hashchangeは発火しません。
            </p>
            <p> 様々なエッジケースを明確化する例をいくつか示します。 </p>
        </div>
        <div class="example" id="example-c4fd5b50">
            <a class="self-link" href="#example-c4fd5b50"></a>
            <pre>window.location = "https://example.com#page1:~:hello";
console.log(window.location.href); // 'https://example.com#page1'
console.log(window.location.hash); // '#page1'
</pre>
            <p>初回ナビゲーションで新しいセッション履歴エントリが作成されます。エントリのURLはフラグメントディレクティブが除去され："https://example.com#page1"、ディレクティブ状態の値は"hello"となります。ドキュメントがこのエントリから生成されるため、Web
                API経由のURLにはフラグメントディレクティブは含まれません。</p>
            <pre>location.hash = "page2";
console.log(location.href); // 'https://example.com#page2'
</pre>
            <p>同一ドキュメント内でフラグメントだけが変更されました。これは<a
                    href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigate-fragid"
                    id="319d7c291">navigate to
                    a fragment</a>手順で新規履歴エントリ追加となりますが、フラグメントのみ変更であるため新エントリのディレクティブ状態は前エントリと同じ（"bar"）を参照します。</p>
            <pre>onhashchange = () => console.assert(false, "hashchange doesn’t fire.");
location.hash = "page2:~:world";
console.log(location.href); // 'https://example.com#page2'
onhashchange = null;
</pre>
            <p>同一ドキュメントナビゲーションでフラグメントのみ変更したうえでディレクティブも含めた場合、明示的ディレクティブ指定なので新エントリは独自の（値が"fizz"の）ディレクティブ状態を持ちます。</p>
            <p>この場合ページに見えるフラグメントは変わっていないためhashchangeは発火しません。hashchange判定は履歴エントリ間のディレクティブ除去済URLで行われるためです。</p>
            <pre>history.pushState("", "", "page3");
console.log(location.href); // 'https://example.com/page3'
</pre>
            <p>pushStateによる同一ドキュメントの新規履歴エントリ作成。非フラグメントURLが変化しているためこのエントリのディレクティブ状態は独立し、値は現時点でnull。</p>
        </div>
        <div class="example" id="example-f4d8b076">
            <a class="self-link" href="#example-f4d8b076"></a> セッション履歴エントリにURLをセットしないその他ケース（例:
            URLオブジェクト/リンク要素等）はフラグメントディレクティブ除去なし。
            <p>URLオブジェクト:</p>
            <pre>let url = new URL('https://example.com#foo:~:bar');
console.log(url.href); // 'https://example.com#foo:~:bar'
console.log(url.hash); // '#foo:~:bar'

document.url = url;
console.log(document.url.href); // 'https://example.com#foo:~:bar'
console.log(document.url.hash); // '#foo:~:bar'

</pre>
            <p><code>&lt;a></code>や<code>&lt;area></code>要素の場合:</p>
            <pre>&lt;a id='anchor' href="https://example.com#foo:~:bar">Anchor&lt;/a>
&lt;script>
  console.log(anchor.href); // 'https://example.com#foo:~:bar'
  console.log(anchor.hash); // '#foo:~:bar'
&lt;/script>
</pre>
        </div>
        <h4 class="heading settled" data-level="3.3.2" id="applying-directives-to-a-document"><span class="secno">3.3.2.
            </span><span class="content">ドキュメントへのディレクティブ適用</span><a class="self-link"
                href="#applying-directives-to-a-document"></a></h4>
        <p>上記のセクションでは、<a data-link-type="dfn" href="#fragment-directive"
                id="ref-for-fragment-directive⑦">フラグメントディレクティブ</a>がURLから分離され、セッション履歴エントリに保存される仕組みについて説明しました。</p>
        <p>このセクションでは、ナビゲーションおよびトラバーサル時に履歴エントリの<a data-link-type="dfn" href="#she-directive-state"
                id="ref-for-she-directive-state⑧">ディレクティブ状態</a>を利用し、セッション履歴エントリに関連付けられたディレクティブを<a data-link-type="dfn"
                href="https://dom.spec.whatwg.org/#concept-document"
                id="ref-for-concept-document">Document</a>へ適用するタイミングと方法を定義します。</p>
        <blockquote>
            <p><strong><a href="https://dom.spec.whatwg.org/#interface-document"><cite>DOM</cite> § 4.5
                        Interface Document</a>へのモンキーパッチ:</strong></p>
            <p>各ドキュメントは関連付けられた<dfn class="dfn-paneled" data-dfn-for="Document" data-dfn-type="dfn" data-noexport
                    id="document-pending-text-directives">保留中テキストディレクティブ</dfn>を持ちます。これはnullまたは<a data-link-type="dfn"
                    href="https://infra.spec.whatwg.org/#list" id="ref-for-list">リスト</a>（<a data-link-type="dfn"
                    href="#text-directive" id="ref-for-text-directive①">テキストディレクティブ</a>のリスト）で、初期値はnullです。</p>
        </blockquote>
        <p><a data-link-type="dfn"
                href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#update-document-for-history-step-application"
                id="ref-for-update-document-for-history-step-application">履歴ステップ適用のためのドキュメント更新</a>の定義にて:</p>
        <blockquote>
            <p><strong><a
                        href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#updating-the-document"><cite>HTML</cite>
                        § 7.4.6.2 ドキュメントの更新</a>へのモンキーパッチ:</strong></p>
            <div class="monkeypatch">
                Document <var>document</var>とセッション履歴エントリ <var>entry</var> ... を与えて履歴ステップ適用のためのドキュメントを更新する:
                <ol>
                    <li data-md>
                        <p>...</p>
                    <li value="4"> <var>document</var> の history object の length を scriptHistoryLength に設定
                    <li data-md>
                        <p> <var>documentsEntryChanged</var> が true の場合:</p>
                        <ol>
                            <li data-md>
                                <p> <var>oldURL</var> に <var>document</var> の latest entry の URL を代入 </p>
                            <li data-md>
                                <div class="diff">
                                    <var>document</var> の latest entry の<a data-link-type="dfn"
                                        href="#she-directive-state" id="ref-for-she-directive-state⑨">ディレクティブ状態</a>が
                                    <var>entry</var> の<a data-link-type="dfn" href="#she-directive-state"
                                        id="ref-for-she-directive-state①⓪">ディレクティブ状態</a>と異なる場合:
                                    <ol>
                                        <li data-md>
                                            <p> <var>fragment directive</var> を <var>entry</var> の <a
                                                    data-link-type="dfn" href="#she-directive-state"
                                                    id="ref-for-she-directive-state①①">ディレクティブ状態</a>の<a
                                                    data-link-type="dfn" href="#directive-state-value"
                                                    id="ref-for-directive-state-value⑤">value</a>とする。</p>
                                        <li data-md>
                                            <p> <var>document</var> の<a data-link-type="dfn"
                                                    href="#document-pending-text-directives"
                                                    id="ref-for-document-pending-text-directives">保留中テキストディレクティブ</a>に、<a
                                                    data-link-type="dfn" href="#parse-the-fragment-directive"
                                                    id="ref-for-parse-the-fragment-directive">フラグメントディレクティブのパース</a>の結果をセット。
                                            </p>
                                    </ol>
                                </div>
                        </ol>
                    <li data-md>
                        <p> <var>document</var> の latest entry を <var>entry</var> に設定</p>
                    <li data-md>
                        <p>...</p>
                </ol>
            </div>
        </blockquote>
        <h4 class="heading settled" data-level="3.3.3" id="fragment-directive-grammar"><span class="secno">3.3.3.
            </span><span class="content">フラグメントディレクティブの文法</span><a class="self-link"
                href="#fragment-directive-grammar"></a></h4>
        <p class="note" role="note"><span class="marker">注:</span> このセクションは規範的ではありません。</p>
        <p class="note" role="note"><span class="marker">注:</span> この文法は便宜のためのリファレンスです。厳密な構文解析手順は<a
                href="#text-directives">§ 3.4 テキストディレクティブ</a>セクションの手続きで命令的に規定されています。この文法とそちらの手順が異なる場合は、手順のほうが正となります。</p>
        <p><a data-link-type="dfn" href="#fragmentdirectiveproduction"
                id="ref-for-fragmentdirectiveproduction">FragmentDirective</a>は"&amp;"文字で分割された複数のディレクティブを含めることができます。現時点では複数のテキストディレクティブによってページ内で複数のテキストを指示できますが、将来他種類のディレクティブの拡張や併用も可能です。この拡張性のため、不明なディレクティブが含まれていてもパースに失敗しません。
        </p>
        <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#string"
                id="ref-for-string">文字列</a>が有効なフラグメントディレクティブであるのは、次のEBNF（拡張バッカス・ナウア記法）生成規則に合致する場合です：</p>
        <dl>
            <dt> <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport
                    id="fragmentdirectiveproduction"><code>FragmentDirective</code></dfn> <code>::=</code>
            <dd> <code>(<a data-link-type="dfn" href="#textdirective" id="ref-for-textdirective">TextDirective</a> | <a data-link-type="dfn" href="#unknowndirective" id="ref-for-unknowndirective">UnknownDirective</a>) ("&amp;" <a data-link-type="dfn" href="#fragmentdirectiveproduction" id="ref-for-fragmentdirectiveproduction①">FragmentDirective</a>)?</code>
            <dt> <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport
                    id="textdirective"><code>TextDirective</code></dfn> <code>::=</code>
            <dd> <code>"text="<a data-link-type="dfn" href="#characterstring" id="ref-for-characterstring">CharacterString</a></code>
            <dt> <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport
                    id="unknowndirective"><code>UnknownDirective</code></dfn> <code>::=</code>
            <dd> <code><a data-link-type="dfn" href="#characterstring" id="ref-for-characterstring①">CharacterString</a> - <a data-link-type="dfn" href="#textdirective" id="ref-for-textdirective①">TextDirective</a></code>
            <dt> <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport
                    id="characterstring"><code>CharacterString</code></dfn> <code>::=</code>
            <dd> <code>(<a data-link-type="dfn" href="#explicitchar" id="ref-for-explicitchar">ExplicitChar</a> | <a data-link-type="dfn" href="#percentencodedbyte" id="ref-for-percentencodedbyte">PercentEncodedByte</a>)*</code>
            <dt> <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport
                    id="explicitchar"><code>ExplicitChar</code></dfn> <code>::=</code>
            <dd>
                <code>[a-zA-Z0-9] | "!" | "$" | "'" | "(" | ")" | "*" | "+" | "." | "/" | ":" |
    ";" | "=" | "?" | "@" | "_" | "~" | "," | "-"</code>
                <div class="note" role="note"> <a data-link-type="dfn" href="#explicitchar"
                        id="ref-for-explicitchar①">ExplicitChar</a>は"&amp;"以外の任意の<a data-link-type="dfn"
                        href="https://url.spec.whatwg.org/#url-code-points" id="ref-for-url-code-points">URL code
                        point</a>です。 </div>
        </dl>
        <p><a data-link-type="dfn" href="#textdirective"
                id="ref-for-textdirective②">TextDirective</a>は次の生成規則を満たすとき有効と見なします:</p>
        <dl>
            <dt><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport
                    id="validtextdirective"><code>ValidTextDirective</code></dfn> <code>::=</code>
            <dd><code>"text=" <a data-link-type="dfn" href="#textdirectiveparameters" id="ref-for-textdirectiveparameters">TextDirectiveParameters</a></code>
            <dt><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport
                    id="textdirectiveparameters"><code>TextDirectiveParameters</code></dfn> <code>::=</code>
            <dd> <code> (<a data-link-type="dfn" href="#textdirectiveprefix" id="ref-for-textdirectiveprefix">TextDirectivePrefix</a> ",")? <a data-link-type="dfn" href="#textdirectivestring" id="ref-for-textdirectivestring">TextDirectiveString</a> ("," <a data-link-type="dfn" href="#textdirectivestring" id="ref-for-textdirectivestring①">TextDirectiveString</a>)?  ("," <a data-link-type="dfn" href="#textdirectivesuffix" id="ref-for-textdirectivesuffix">TextDirectiveSuffix</a>)? </code>
            <dt><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport
                    id="textdirectiveprefix"><code>TextDirectivePrefix</code></dfn> <code>::=</code>
            <dd><code><a data-link-type="dfn" href="#textdirectivestring" id="ref-for-textdirectivestring②">TextDirectiveString</a>"-"</code>
            <dt><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport
                    id="textdirectivesuffix"><code>TextDirectiveSuffix</code></dfn> <code>::=</code>
            <dd><code>"-"<a data-link-type="dfn" href="#textdirectivestring" id="ref-for-textdirectivestring③">TextDirectiveString</a></code>
            <dt><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport
                    id="textdirectivestring"><code>TextDirectiveString</code></dfn> <code>::=</code>
            <dd><code>(<a data-link-type="dfn" href="#textdirectiveexplicitchar" id="ref-for-textdirectiveexplicitchar">TextDirectiveExplicitChar</a> | <a data-link-type="dfn" href="#percentencodedbyte" id="ref-for-percentencodedbyte①">PercentEncodedByte</a>)+</code>
            <dt><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport
                    id="textdirectiveexplicitchar"><code>TextDirectiveExplicitChar</code></dfn> <code>::=</code>
            <dd>
                <code> [a-zA-Z0-9] | "!" | "$" | "'" | "(" | ")" | "*" | "+" | "." | "/" | ":" |
    ";" | "=" | "?" | "@" | "_" | "~" </code>
                <div class="note" role="note"><a data-link-type="dfn" href="#textdirectiveexplicitchar"
                        id="ref-for-textdirectiveexplicitchar①">TextDirectiveExplicitChar</a>は"&amp;""-""、","で使われている以外の全ての<a
                        data-link-type="dfn" href="https://url.spec.whatwg.org/#url-code-points"
                        id="ref-for-url-code-points①">URL code
                        point</a>。テキストフラグメントが"&amp;"や"-"や","を参照する場合はパーセントエンコードする必要があります。 </div>
            <dt><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport
                    id="percentencodedbyte"><code>PercentEncodedByte</code></dfn> <code>::=</code>
            <dd><code>"%" [a-zA-Z0-9][a-zA-Z0-9]</code>
        </dl>
        <h3 class="heading settled" data-level="3.4" id="text-directives"><span class="secno">3.4. </span><span
                class="content">テキストディレクティブ</span><a class="self-link" href="#text-directives"></a></h3>
        <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport
                id="text-directive">テキストディレクティブ</dfn>は、ユーザーに指示するためのテキスト範囲を示す<a data-link-type="dfn" href="#directives"
                id="ref-for-directives">ディレクティブ</a>の一種です。<a data-link-type="dfn"
                href="https://infra.spec.whatwg.org/#struct" id="ref-for-struct">構造体</a>で、四つの文字列： <dfn
                class="dfn-paneled" data-dfn-for="text directive" data-dfn-type="dfn" data-noexport
                id="text-directive-start">start</dfn>, <dfn class="dfn-paneled" data-dfn-for="text directive"
                data-dfn-type="dfn" data-noexport id="text-directive-end">end</dfn>, <dfn class="dfn-paneled"
                data-dfn-for="text directive" data-dfn-type="dfn" data-noexport id="text-directive-prefix">prefix</dfn>,
            <dfn class="dfn-paneled" data-dfn-for="text directive" data-dfn-type="dfn" data-noexport
                id="text-directive-suffix">suffix</dfn> を持ちます。<a data-link-type="dfn" href="#text-directive-start"
                id="ref-for-text-directive-start">start</a>はnull不可。他3つはnullでもよく、未指定時を示します。空文字列はどれにも許可されません。
        </p>
        <p>各構成要素の意味や使い方は<a href="#syntax">§ 3.2 構文</a>を参照してください。</p>
        <div class="algorithm" data-algorithm="percent-decode a text directive term">
            <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#string" id="ref-for-string①">string</a>
            <var>term</var> を引数に、「<dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport
                id="percent-decode-a-text-directive-term">テキストディレクティブ項目のパーセントデコード</dfn>」は次の手順
            <ol class="algorithm">
                <li data-md>
                    <p><var>term</var>がnullならnullを返す。</p>
                <li data-md>
                    <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#assert"
                            id="ref-for-assert">Assert</a>: <var>term</var> は<a data-link-type="dfn"
                            href="https://infra.spec.whatwg.org/#ascii-string"
                            id="ref-for-ascii-string①">ASCII文字列</a>である。</p>
                <li data-md>
                    <p><var>decoded bytes</var> を <a data-link-type="dfn"
                            href="https://url.spec.whatwg.org/#string-percent-decode"
                            id="ref-for-string-percent-decode">percent-decoding</a> <var>term</var> の結果とする。</p>
                <li data-md>
                    <p><var>decoded bytes</var> に<a data-link-type="dfn"
                            href="https://encoding.spec.whatwg.org/#utf-8-decode-without-bom"
                            id="ref-for-utf-8-decode-without-bom">BOMなしのUTF-8デコード</a>を実施して返す。</p>
            </ol>
        </div>
        <div class="algorithm" data-algorithm="parse a text directive">
            <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#string" id="ref-for-string②">string</a>
            <var>text directive value</var> を引数に「<dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport
                id="parse-a-text-directive">テキストディレクティブのパース</dfn>」は次の手順:
            <div class="note" role="note">
                <p> このアルゴリズムは単一のテキストディレクティブ値（例："prefix-,foo,bar"）を入力とし、その内容をディレクティブの構成要素（例：("prefix", "foo", "bar",
                    null)）に分割しようとします。各構成要素の意味や使い方は<a href="#syntax">§ 3.2 構文</a>を参照。 </p>
                <p> 入力が不正ならnullを返します。正しければ<a data-link-type="dfn" href="#text-directive"
                        id="ref-for-text-directive②">テキストディレクティブ</a>を返します。 </p>
            </div>
            <ol class="algorithm">
                <li data-md>
                    <p><var>prefix</var>, <var>suffix</var>, <var>start</var>, <var>end</var> をすべてnullで初期化。</p>
                <li data-md>
                    <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#assert"
                            id="ref-for-assert①">Assert</a>: <var>text directive value</var> は<a data-link-type="dfn"
                            href="https://infra.spec.whatwg.org/#ascii-string"
                            id="ref-for-ascii-string②">ASCII文字列</a>で、<a data-link-type="dfn"
                            href="https://url.spec.whatwg.org/#fragment-percent-encode-set"
                            id="ref-for-fragment-percent-encode-set">フラグメントパーセントエンコードセット</a>のコードポイントやU+0026 (&amp;)
                        を含まない。</p>
                <li data-md>
                    <p><var>tokens</var>に<a data-link-type="dfn" href="https://infra.spec.whatwg.org/#strictly-split"
                            id="ref-for-strictly-split">厳密分割</a>で<var>text directive
                            value</var>をU+002C(,)区切りで分割したリストを代入。</p>
                <li data-md>
                    <p><var>tokens</var> の<a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-size"
                            id="ref-for-list-size">サイズ</a>が1未満または4より大ならnullを返す。</p>
                <li data-md>
                    <p><var>tokens</var>の最初の要素がU+002D(-)で終わる場合:</p>
                    <ol>
                        <li data-md>
                            <p><var>prefix</var>を<var>tokens</var>[0]の0番目から長さ-1だけ切り出した<a data-link-type="dfn"
                                    href="https://infra.spec.whatwg.org/#code-point-substring"
                                    id="ref-for-code-point-substring">部分文字列</a>とする。</p>
                        <li data-md>
                            <p><var>tokens</var>の先頭を削除。</p>
                        <li data-md>
                            <p><var>prefix</var>が空文字列またはU+002D(-)を含む場合はnullを返す。</p>
                        <li data-md>
                            <p><var>tokens</var>が<a data-link-type="dfn"
                                    href="https://infra.spec.whatwg.org/#list-empty"
                                    id="ref-for-list-empty">空</a>ならnullを返す。</p>
                    </ol>
                <li data-md>
                    <p><var>tokens</var>の最後の要素がU+002D(-)で始まる場合:</p>
                    <ol>
                        <li data-md>
                            <p><var>suffix</var>を最後の要素の1文字目以降の<a data-link-type="dfn"
                                    href="https://infra.spec.whatwg.org/#code-point-substring-to-the-end-of-the-string"
                                    id="ref-for-code-point-substring-to-the-end-of-the-string①">部分文字列</a>とする。</p>
                        <li data-md>
                            <p><var>tokens</var>の末尾を削除。</p>
                        <li data-md>
                            <p><var>suffix</var>が空文字列またはU+002D(-)を含む場合はnullを返す。</p>
                        <li data-md>
                            <p><var>tokens</var>が<a data-link-type="dfn"
                                    href="https://infra.spec.whatwg.org/#list-empty"
                                    id="ref-for-list-empty①">空</a>ならnullを返す。</p>
                    </ol>
                <li data-md>
                    <p><var>tokens</var>の<a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-size"
                            id="ref-for-list-size①">サイズ</a>が2より大きければnullを返す。</p>
                <li data-md>
                    <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#assert"
                            id="ref-for-assert②">Assert</a>: <var>tokens</var>の<a data-link-type="dfn"
                            href="https://infra.spec.whatwg.org/#list-size" id="ref-for-list-size②">サイズ</a>は1または2。</p>
                <li data-md>
                    <p><var>start</var>を<var>tokens</var>の最初の要素にする。</p>
                <li data-md>
                    <p><var>tokens</var>の先頭を削除。</p>
                <li data-md>
                    <p><var>start</var>が空文字列またはU+002D(-)を含む場合はnullを返す。</p>
                <li data-md>
                    <p><var>tokens</var>が<a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-empty"
                            id="ref-for-list-empty②">空</a>でなければ:</p>
                    <ol>
                        <li data-md>
                            <p><var>end</var>を<var>tokens</var>の最初の要素にする。</p>
                        <li data-md>
                            <p><var>end</var>が空文字列またはU+002D(-)を含む場合はnullを返す。</p>
                    </ol>
                <li data-md>
                    <p>次を持つ<a data-link-type="dfn" href="#text-directive"
                            id="ref-for-text-directive③">テキストディレクティブ</a>新規作成し返す:</p>
                    <dl class="props">
                        <dt><a data-link-type="dfn" href="#text-directive-prefix"
                                id="ref-for-text-directive-prefix">prefix</a>
                        <dd><a data-link-type="dfn" href="#percent-decode-a-text-directive-term"
                                id="ref-for-percent-decode-a-text-directive-term">パーセントデコード</a>済<var>prefix</var>
                        <dt><a data-link-type="dfn" href="#text-directive-start"
                                id="ref-for-text-directive-start①">start</a>
                        <dd><a data-link-type="dfn" href="#percent-decode-a-text-directive-term"
                                id="ref-for-percent-decode-a-text-directive-term①">パーセントデコード</a>済<var>start</var>
                        <dt><a data-link-type="dfn" href="#text-directive-end" id="ref-for-text-directive-end">end</a>
                        <dd><a data-link-type="dfn" href="#percent-decode-a-text-directive-term"
                                id="ref-for-percent-decode-a-text-directive-term②">パーセントデコード</a>済<var>end</var>
                        <dt><a data-link-type="dfn" href="#text-directive-suffix"
                                id="ref-for-text-directive-suffix">suffix</a>
                        <dd><a data-link-type="dfn" href="#percent-decode-a-text-directive-term"
                                id="ref-for-percent-decode-a-text-directive-term③">パーセントデコード</a>済<var>suffix</var>
                    </dl>
            </ol>
        </div>
        <div class="algorithm" data-algorithm="parse the fragment directive">
            <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#ascii-string"
                    id="ref-for-ascii-string③">ASCII文字列</a>
                <var>fragment directive</var> に対し「<dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport
                    id="parse-the-fragment-directive">フラグメントディレクティブのパース</dfn>」は:
            </p>
            <div class="note" role="note"> このアルゴリズムは（すなわち":~:"以降の）フラグメントディレクティブ文字列を受け取り、それから解析した<a data-link-type="dfn"
                    href="#text-directive" id="ref-for-text-directive④">テキストディレクティブ</a>オブジェクトのリストを返します。空リストも可。</div>
            <ol class="algorithm">
                <li data-md>
                    <p><var>directives</var>に<a data-link-type="dfn"
                            href="https://infra.spec.whatwg.org/#strictly-split"
                            id="ref-for-strictly-split①">厳密分割</a>で<var>fragment directive</var>をU+0026 (&amp;)
                        区切りで分割したリストを代入。</p>
                <li data-md>
                    <p><var>output</var>に空の<a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list"
                            id="ref-for-list②">テキストディレクティブリスト</a>を初期化。</p>
                <li data-md>
                    <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-iterate"
                            id="ref-for-list-iterate">各</a> <a data-link-type="dfn"
                            href="https://infra.spec.whatwg.org/#string" id="ref-for-string④">string</a>
                        <var>directive</var> について:
                    </p>
                    <ol>
                        <li data-md>
                            <p><var>directive</var>が"<code>text=</code>"で始まらない場合、<a data-link-type="dfn"
                                    href="https://infra.spec.whatwg.org/#iteration-continue"
                                    id="ref-for-iteration-continue">スキップ</a>。</p>
                        <li data-md>
                            <p><var>text directive value</var> に<var>directive</var>の5文字目以降<a data-link-type="dfn"
                                    href="https://infra.spec.whatwg.org/#code-point-substring-to-the-end-of-the-string"
                                    id="ref-for-code-point-substring-to-the-end-of-the-string②">部分文字列</a>を代入</p>
                            <div class="note" role="note">注: 空文字列もありうる</div>
                        <li data-md>
                            <p><var>parsed text directive</var>に<a data-link-type="dfn" href="#parse-a-text-directive"
                                    id="ref-for-parse-a-text-directive">テキストディレクティブのパース</a>の結果を代入
                            </p>
                        <li data-md>
                            <p><var>parsed text directive</var>がnullでなければ<a data-link-type="dfn"
                                    href="https://infra.spec.whatwg.org/#list-append"
                                    id="ref-for-list-append">output</a>に追加</p>
                    </ol>
                <li data-md>
                    <p><var>output</var> を返す。</p>
            </ol>
        </div>
        <h4 class="heading settled" data-level="3.4.1" id="invoking-text-directives"><span class="secno">3.4.1.
            </span><span class="content">テキストディレクティブの呼び出し</span><a class="self-link"
                href="#invoking-text-directives"></a></h4>
        <p>このセクションでは、ドキュメントの<a data-link-type="dfn" href="#document-pending-text-directives"
                id="ref-for-document-pending-text-directives①">保留中テキストディレクティブ</a>内のテキストディレクティブがどのように処理・呼び出され、該当テキスト部分の指示が行われるかを説明します。
        </p>
        <div class="note" role="note">
            本セクションの変更点まとめ：
            <ul>
                <li data-md>
                    <p>指示された部分処理モデルを修正し、<a data-link-type="dfn" href="#document-pending-text-directives"
                            id="ref-for-document-pending-text-directives②">保留中テキストディレクティブ</a>を<a data-link-type="dfn"
                            href="https://dom.spec.whatwg.org/#concept-range"
                            id="ref-for-concept-range">range</a>に変換し、指示される部分として返すようにします。</p>
                <li data-md>
                    <p>「フラグメントへのスクロール」を修正し、<a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range"
                            id="ref-for-concept-range①">range</a>ベースの指示部分の場合のスクロールとドキュメントのtarget要素の設定を正しく行えるようにします。</p>
                <li data-md>
                    <p><a data-link-type="dfn" href="#document-pending-text-directives"
                            id="ref-for-document-pending-text-directives③">保留中テキストディレクティブ</a>が現在のナビゲーション・トラバーサルのフラグメント検索が完了したらnullにリセットされることを保証します。
                    </p>
                <li data-md>
                    <p>ユーザーエージェントがテキストディレクティブ検索を完了した場合は、通常フラグメントをフォールバックとして試行することを保証します。</p>
            </ul>
        </div>
        <p><a href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#the-indicated-part-of-the-document">
                indicated part</a>において、フラグメントで<a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range"
                id="ref-for-concept-range②">range</a>を指示できるようにします。以下のように修正：</p>
        <blockquote>
            <p><strong><a
                        href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#scrolling-to-a-fragment"><cite>HTML</cite>
                        § 7.4.6.3 フラグメントへのスクロール</a>へのモンキーパッチ：</strong></p>
            <div class="monkeypatch">
                HTML文書<var>document</var>について、その指示部分を決定するための処理モデルは次の通り：
                <ol>
                    <li data-md>
                        <p><span class="diff"><var>text directives</var>をdocumentの<a data-link-type="dfn"
                                    href="#document-pending-text-directives"
                                    id="ref-for-document-pending-text-directives④">保留中テキストディレクティブ</a>とする。</span>
                        </p>
                    <li data-md>
                        <p><span class="diff"><var>text directives</var>がnullでない場合：</span></p>
                        <ol>
                            <li data-md>
                                <p><span class="diff"><var>ranges</var>リストを<a data-link-type="dfn"
                                            href="#invoke-text-directives"
                                            id="ref-for-invoke-text-directives">テキストディレクティブ呼び出し</a>手順でdocumentと<var>text
                                            directives</var>から生成。</span></p>
                            <li data-md>
                                <p><span class="diff"><var>ranges</var>が空でなければ：</span></p>
                                <ol>
                                    <li data-md>
                                        <p><span class="diff"><var>firstRange</var>を<var>ranges</var>の最初の要素とする。</span>
                                        </p>
                                    <li data-md>
                                        <p><span class="diff"><var>ranges</var>内の各<a data-link-type="dfn"
                                                    href="https://dom.spec.whatwg.org/#concept-range"
                                                    id="ref-for-concept-range③">range</a>を <a data-link-type="dfn"
                                                    href="https://infra.spec.whatwg.org/#implementation-defined"
                                                    id="ref-for-implementation-defined">実装依存</a>の方法で視覚的に指示する。指示は著者スクリプトから観測不可でなければならない。<a
                                                    href="#indicating-the-text-match">§ 3.7 テキスト一致の指示</a>を参照。</span></p>
                                        <div class="note" role="note"><var>ranges</var>の最初の<a data-link-type="dfn"
                                                href="https://dom.spec.whatwg.org/#concept-range"
                                                id="ref-for-concept-range④">range</a>がスクロールされますが、全て指示は視覚的にユーザーに見せる必要があります。
                                        </div>
                                    <li data-md>
                                        <p><span
                                                class="diff"><var>firstRange</var>を<var>document</var>の指示部分としてセットし、return。</span>
                                        </p>
                                </ol>
                        </ol>
                    <li data-md>
                        <p>fragmentをdocumentのURLフラグメントとする。</p>
                    <li data-md>
                        <p>fragmentが空文字列なら、特殊値「ドキュメント先頭」を返す。</p>
                    <li data-md>
                        <p>potentialIndicatedElementをdocumentとfragmentをもとに求める。</p>
                    <li data-md>
                        <p>...</p>
                </ol>
            </div>
        </blockquote>
        <p><a data-link-type="dfn"
                href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#scroll-to-the-fragment-identifier"
                id="ref-for-scroll-to-the-fragment-identifier">フラグメント識別子へのスクロール</a>において、指示部分が<a data-link-type="dfn"
                href="https://dom.spec.whatwg.org/#concept-range"
                id="ref-for-concept-range⑤">range</a>の場合や、force-load-at-topポリシー時のスクロール制御を記述。次のように修正：</p>
        <blockquote>
            <p><strong><a
                        href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#scrolling-to-a-fragment"><cite>HTML</cite>
                        § 7.4.6.3 フラグメントへのスクロール</a>へのモンキーパッチ：</strong></p>
            <div class="monkeypatch">
                <ol>
                    <li data-md>
                        <p>documentの指示部分がnullなら、documentのtarget要素をnullに。</p>
                    <li data-md>
                        <p>documentの指示部分が「ドキュメント先頭」なら：</p>
                        <ol>
                            <li data-md>
                                <p>documentのtarget要素をnullに。</p>
                            <li data-md>
                                <p>documentでドキュメント先頭へスクロール。</p>
                            <li data-md>
                                <p>return。</p>
                        </ol>
                    <li data-md>
                        <p>その他の場合：</p>
                        <ol>
                            <li data-md>
                                <p class="assertion">アサーション: documentの指示部分はelement<span class="diff">または<a
                                            data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range"
                                            id="ref-for-concept-range⑥">range</a></span>。</p>
                            <li data-md>
                                <p><span class="diff"><var>scrollTarget</var>をdocumentの指示部分とする。</span></p>
                            <li data-md>
                                <p><span class="diff"><var>target</var>を<var>scrollTarget</var>とする。</span></p>
                            <li data-md>
                                <p><span class="diff"><var>target</var>が<a data-link-type="dfn"
                                            href="https://dom.spec.whatwg.org/#concept-range"
                                            id="ref-for-concept-range⑦">range</a>の場合：</span></p>
                                <ol>
                                    <li data-md>
                                        <p><span class="diff"><var>target</var>をstart node、end nodeの<a
                                                    data-link-type="dfn" href="#first-common-ancestor"
                                                    id="ref-for-first-common-ancestor">最小共通祖先</a>にセット。</span></p>
                                    <li data-md>
                                        <p><span class="diff"><var>target</var>がnullでなくelementでない間、<var>target</var>を<var>target</var>の<a
                                                    data-link-type="dfn"
                                                    href="https://dom.spec.whatwg.org/#concept-tree-parent"
                                                    id="ref-for-concept-tree-parent">親</a>に辿る。</span></p>
                                        <div class="issue" id="issue-424a4e25"><a class="self-link"
                                                href="#issue-424a4e25"></a> shadow tree内の場合のtarget設定はどうするか？ <a
                                                href="https://github.com/WICG/scroll-to-text-fragment/issues/190">#190</a>
                                        </div>
                                </ol>
                            <li data-md>
                                <p><span class="diff">アサート：<var>target</var>はelement。</span></p>
                            <li data-md>
                                <p>documentのtarget要素に<var>target</var>をセット。</p>
                            <li data-md>
                                <p>ancestor details revealingアルゴリズムを<var>target</var>で実行。</p>
                            <li data-md>
                                <p>ancestor hidden-until-found revealingアルゴリズムを<var>target</var>で実行。</p>
                                <div class="issue" id="issue-10739530"><a class="self-link" href="#issue-10739530"></a>
                                    revealingアルゴリズムの現状だとtargetが祖先またはドキュメントルートノードの場合うまくいかない場合がある。 <a
                                        href="https://github.com/WICG/scroll-to-text-fragment/issues/89">#89</a>
                                    でcontain:style layoutブロックへの制限提案あり。</div>
                            <li data-md>
                                <p><span class="diff"><var>blockPosition</var>は<var>scrollTarget</var>が<a
                                            data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range"
                                            id="ref-for-concept-range⑧">range</a>なら"center"、それ以外は"start"。</span></p>
                                <div class="note" role="note">テキストディレクティブへのスクロールはブロック方向で中央寄せスクロールとなる。</div>
                            <li data-md>
                                <strike class="diff">targetを自動・start・nearestでスクロール。</strike>
                            <li value="10">
                                <span class="diff"><a data-link-type="dfn"
                                        href="https://drafts.csswg.org/cssom-view-1/#scroll-a-target-into-view"
                                        id="ref-for-scroll-a-target-into-view">scroll a target into
                                        view</a>の<em>target</em>は
                                    <var>scrollTarget</var>、<em>behavior</em>は"auto"、<em>block</em>は<var>blockPosition</var>、<em>inline</em>は"nearest"で実行。</span>
                                <p><span class="diff">実装はテキストディレクティブから生成されたtargetの場合スクロールしないことも可能。</span></p>
                                <p></p>
                            <li data-md>
                                <p>targetのfocusing stepsを実行（fallbackはDocumentのビューポート）。</p>
                                <div class="issue" id="issue-e253a983"><a class="self-link"
                                        href="#issue-e253a983"></a>Blinkは現状テキストフラグメントでfocusを設定しない。対応要検討。</div>
                            <li data-md>
                                <p>逐次focusナビゲーションの開始点をtargetに移動。</p>
                        </ol>
                </ol>
            </div>
        </blockquote>
        <p>次の2つのモンキーパッチは、ユーザーエージェントがフラグメント検索完了時に<a data-link-type="dfn" href="#document-pending-text-directives"
                id="ref-for-document-pending-text-directives⑤">保留中テキストディレクティブ</a>をクリアすること、およびテキストディレクティブ検索パース終了時は非テキストディレクティブのフラグメントもサーチすることを保証します。
        </p>
        <p><a href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#try-to-scroll-to-the-fragment"
                id="44bd3acf0">try to scroll to the fragment</a>の定義にて：</p>
        <blockquote>
            <p><strong><a
                        href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#scrolling-to-a-fragment"><cite>HTML</cite>
                        § 7.4.6.3 フラグメントへのスクロール</a>へのモンキーパッチ：</strong></p>
            <div class="monkeypatch">
                Document <var>document</var>について、try to scroll to the fragmentのパラレル手順は以下：
                <ol>
                    <li data-md>
                        <p>実装依存の時間だけwait（パフォーマンス配慮のためのUX最適化）。</p>
                    <li data-md>
                        <p>documentのrelevant global objectでnavigation/traversal task sourceのグローバルタスクとして以下をキュー：</p>
                        <ol>
                            <li data-md>
                                <strike class="diff"> documentにparserが存在しないか、パース完了か、スクロール不要ならabort </strike>
                            <li class="diff" value="1">
                                ユーザーエージェントがスクロール不要と判断した場合
                                <ol>
                                    <li data-md>
                                        <p><span class="diff"><a data-link-type="dfn"
                                                    href="#document-pending-text-directives"
                                                    id="ref-for-document-pending-text-directives⑥">保留中テキストディレクティブ</a>をnullにセット</span>
                                        </p>
                                    <li data-md>
                                        <p><span class="diff">abort</span></p>
                                </ol>
                            <li data-md>
                                <p><span class="diff">documentにparserが存在しないかparserがstopなら：</span></p>
                                <p></p>
                                <ol>
                                    <li data-md>
                                        <p><span class="diff"><a data-link-type="dfn"
                                                    href="#document-pending-text-directives"
                                                    id="ref-for-document-pending-text-directives⑦">保留中テキストディレクティブ</a>がnullでなければ：</span>
                                        </p>
                                        <ol>
                                            <li data-md>
                                                <p><span class="diff"><a data-link-type="dfn"
                                                            href="#document-pending-text-directives"
                                                            id="ref-for-document-pending-text-directives⑧">保留中テキストディレクティブ</a>をnullに</span>
                                                </p>
                                            <li data-md>
                                                <p><span class="diff"><a data-link-type="dfn"
                                                            href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#scroll-to-the-fragment-identifier"
                                                            id="ref-for-scroll-to-the-fragment-identifier①">フラグメント識別子へのスクロール</a>をdocumentで実行</span>
                                                </p>
                                        </ol>
                                    <li data-md>
                                        <p><span class="diff">abort</span></p>
                                </ol>
                            <li data-md>
                                <p>documentでフラグメントへスクロールを実行。</p>
                            <li data-md>
                                <p>ドキュメントの indicated part がまだ null の場合、ドキュメントのフラグメントへスクロールを試みる。<span
                                        class="diff">それ以外の場合は、<a data-link-type="dfn"
                                            href="#document-pending-text-directives"
                                            id="ref-for-document-pending-text-directives⑨">保留中のテキストディレクティブ</a> を
                                        null に設定する。</span></p>
                        </ol>
                </ol>
            </div>
        </blockquote>
        <p><a href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigate-fragid"
                id="319d7c292">navigate to a fragment</a>の定義では：</p>
        <blockquote>
            <p><strong><a
                        href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#scroll-to-fragid"><cite>HTML</cite>
                        § 7.4.2.3.3 フラグメントナビゲーション</a>へのモンキーパッチ：</strong></p>
            <div class="monkeypatch">
                navigable <var>navigable</var>でフラグメントにナビゲートするには...:
                <ol>
                    <li data-md>
                        <p>...</p>
                    <li value="8">navigableのactive document, historyEntry, true, scriptHistoryIndex,
                        scriptHistoryLengthで履歴ステップ適用のためのドキュメント更新を行う。
                    <li data-md>
                        <p>navigableのactive documentでフラグメントにスクロールする。</p>
                    <li class="diff">navigableのactive documentの<a data-link-type="dfn"
                            href="#document-pending-text-directives"
                            id="ref-for-document-pending-text-directives①⓪">保留中テキストディレクティブ</a>をnullに
                    <li data-md>
                        <p>traversableをnavigableのtraversable navigableとする。</p>
                    <li data-md>
                        <p>...</p>
                </ol>
            </div>
        </blockquote>
        <p>指示部分へのスクロールは「scroll to the fragment」から行われるものの1つにすぎない。名称と関連定義を「indicating a fragment」にリネーム：</p>
        <blockquote>
            <p><strong><a
                        href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#scroll-to-fragid"><cite>HTML</cite>
                        § 7.4.2.3.3 フラグメントナビゲーション</a>へのモンキーパッチ：</strong></p>
            <p><a href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#scroll-to-fragid"><cite>HTML</cite>
                    § 7.4.2.3.3 Fragment navigations</a> およびその関連手順の名称を「indicating a fragment」（フラグメントの指示）にリネーム。</p>
        </blockquote>
        <h3 class="heading settled" data-level="3.5" id="security-and-privacy"><span class="secno">3.5. </span><span
                class="content">セキュリティとプライバシー</span><a class="self-link" href="#security-and-privacy"></a></h3>
        <h4 class="heading settled" data-level="3.5.1" id="motivation"><span class="secno">3.5.1. </span><span
                class="content">動機</span><a class="self-link" href="#motivation"></a></h4>
        <div class="note" role="note">このセクションは規範的ではありません</div>
        <p><a data-link-type="dfn" href="#text-directive"
                id="ref-for-text-directive⑦">テキストディレクティブ</a>を実装する際は、オリジン間で情報漏えいに使われないよう注意が必要です。スクリプトはクロスオリジンの<a
                data-link-type="dfn" href="#text-directive"
                id="ref-for-text-directive⑧">テキストディレクティブ</a>付きURLにナビゲートできます。悪意のある者が、被害者ページでテキストフラグメントが発見されたかを検出できれば、ページ内テキストの有無を推測できてしまいます。
        </p>
        <p>次節以降の処理モデルでは、この攻撃ベクトルを軽減できるように制限を設けています。要点をまとめると、テキストディレクティブは次の条件下でのみ許可されます：</p>
        <ul>
            <li data-md>
                <p>トップレベルのnavigable（＝iframe不可）</p>
                <ul>
                    <li data-md>
                        <p class="issue" id="issue-35f490f0"><a class="self-link"
                                href="#issue-35f490f0"></a>これは正確ではなく、Chromeではsame-originイニシエーターでは許可。仕様更新要。</p>
                </ul>
            <li data-md>
                <p>ユーザーアクションによるナビゲーション</p>
            <li data-md>
                <p>ナビゲーションがクロスオリジンイニシエータの場合は、行き先がopener isolatedである必要がある（他のドキュメントからグローバルオブジェクト参照不可）</p>
        </ul>
        <h4 class="heading settled" data-level="3.5.2" id="scroll-on-navigation"><span class="secno">3.5.2. </span><span
                class="content">ナビゲーション時のスクロール</span><a class="self-link" href="#scroll-on-navigation"></a></h4>
        <p>UAは一致したテキスト部分を自動スクロール表示できる場合があります。これはユーザーにとって便利ですが、実装UAはリスクに注意が必要です。</p>
        <p>ナビゲーション時スクロールが通常のユーザースクロールと区別できる既知・未知の検出方法があります。</p>
        <div class="example" id="example-fe268bc5"><a class="self-link" href="#example-fe268bc5"></a>
            対象ページのiframe内にあるオリジンでIntersectionObserverを登録し、ロード500ms以内にスクロール発生を検出する。これにより、ページにテキストフラグメントが見つかったか判別できる。
        </div>
        <div class="example" id="example-ce37442a"><a class="self-link" href="#example-ce37442a"></a>
            2人のユーザーが同じネットワークで互いの通信を観測可能な場合、攻撃者がテキストフラグメント付きリンクを送信し、被害者がアクセス、フラグメント付近のリソースがユニークドメインにあり、DNSルックアップ順で一部一致成否を推定できる。
        </div>
        <div class="example" id="example-2e4f39df"><a class="self-link" href="#example-2e4f39df"></a>
            攻撃者が被害者にプライベートトークンを表示するページへのリンクを送り、テキストフラグメントで警告文をスクロールアウトし、トークンのみ読ませようとする。</div>
        <p>このような漏洩方法は、ターゲットページ特有の状況に依存し一般化は難しいです。テキストフラグメントの発動に更なる制限をつけることで、攻撃者の行動範囲はさらに狭くなります。ただし、UAごとにリスク受容性判断が異なる可能性があります。UAはこうしたリスクを考慮し、テキストフラグメントでの自動スクロール実施可否を判断して下さい。
        </p>
        <p>準拠UAはナビゲーション時の自動スクロールをしない選択もできます。その場合はUIでユーザーがスクロール開始できる仕組み（「クリックしてスクロール」など）や、指示部分が下部ページに存在する旨の通知をすることも可能です。
        </p>
        <p>上記例は状況次第でページ内容1ビット漏洩可能となることを示していますが、攻撃を繰り返して任意のページ内容抽出が行えないよう、ユーザーアクティベーション制限やブラウジングコンテキスト分離などが重要かつ必須です。</p>
        <div class="note" role="note">
            ブラウジングコンテキスト分離は、他ドキュメントからのスクリプトによる攻撃面を減らします。
            <p>また、悪意ある利用も隠しにくくなります。グループ内唯一ならトップレベルコンテキスト（タブやウィンドウ）となるため。</p>
        </div>
        <p>UAが自動スクロール実施を選ぶ場合、ドキュメントがバックグラウンド（非アクティブタブ等）では一切スクロールしない必要があります。これにより、不正利用がユーザー可視となり、バックグラウンド自動化攻撃を防止します。</p>
        <p>UAが自動スクロールを実施しない場合、テキストフラグメント有無に関わらず要素ID指定部分は必ずスクロールしてください。そうしないと要素IDがスクロールされたか否かで一致判別ができてしまいます。</p>
        <h4 class="heading settled" data-level="3.5.3" id="search-timing"><span class="secno">3.5.3. </span><span
                class="content">検索タイミング</span><a class="self-link" href="#search-timing"></a></h4>
        <p>ナイーブなテキスト検索アルゴリズムでは、一致／不一致時の実行時間差で情報漏えいの可能性があります。攻撃者が<a data-link-type="dfn" href="#text-directive"
                id="ref-for-text-directive⑨">テキストディレクティブ</a>呼び出しURLへ同期ナビゲートできれば、その実行時間からテキスト片の存在を推測可能です。</p>
        <div class="note" role="note"> <a href="#restricting-the-text-fragment">§ 3.5.4
                テキストフラグメントの制限</a>により、このケース（特に同一ドキュメント遷移抑止）は防がれますが、防御の多層化の一環です。</div>
        <p>そのため、<em><a href="#navigating-to-text-fragment">§ 3.6
                    テキストフラグメントへのナビゲーション</a>手順の実行時間が一致の有無で変化しないように実装しなければなりません。</em></p>
        <p>この仕様では、UAが達成する手法は問わず、多様な解法とトレードオフが存在します。例：UAは<a data-link-type="dfn"
                href="#find-a-range-from-a-text-directive"
                id="ref-for-find-a-range-from-a-text-directive">テキストディレクティブから範囲検索</a>で一致が見つかってもツリー走査を継続したり、非同期タスクでドキュメント指示部分を設定するなど。
        </p>
        <h4 class="heading settled" data-level="3.5.4" id="restricting-the-text-fragment"><span class="secno">3.5.4.
            </span><span class="content">テキストフラグメントの制限</span><a class="self-link" href="#restricting-the-fragment"></a>
        </h4>
        <div class="note" role="note">
            このセクションでは、HTMLナビゲーションとの統合により、指示されたテキストディレクティブがスクロールを許可されるタイミングを制限します。まとめ：
            <ul>
                <li data-md>
                    <p>DocumentとRequestの両方にboolean型<code>text directive user activation</code>を追加します。このフラグはユーザーアクティベーションによるナビゲートで生成されたドキュメントにセットされ、テキストディレクティブでスクロール時に消費されます。未消費の場合、外部へのナビゲーション要求に転送できます。以下の注記で説明される、リダイレクト経由ユーザーアクティベーション挙動を実装します。
                    </p>
                <li data-md>
                    <p>ドキュメント、およびナビゲーションのユーザー関与・イニシエーターオリジン状態に基づき、一連のチェックを定義し、テキストディレクティブのスクロール許可可否を判定します。</p>
                <li data-md>
                    <p>「finalize a cross document navigation」や「navigate to a fragment steps」でスクロール許可を計算し、「scroll to the
                        fragment」手順へ伝搬して、テキストディレクティブスクロール中断に利用します。</p>
            </ul>
        </div>
        <p><a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request"
                id="ref-for-concept-request">request</a>および<a data-link-type="dfn"
                href="https://dom.spec.whatwg.org/#concept-document"
                id="ref-for-concept-document②">Document</a>の定義を修正し、新たなboolean型<a data-link-type="dfn"
                href="#document-text-directive-user-activation"
                id="ref-for-document-text-directive-user-activation">text directive user activation</a>フィールドを含めます：</p>
        <blockquote>
            <p><strong>Monkeypatching <a data-link-type="biblio" href="#biblio-fetch"
                        title="Fetch Standard">[FETCH]</a>:</strong></p>
            <p><a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request"
                    id="ref-for-concept-request①">request</a>には関連付けられたboolean型<dfn class="dfn-paneled"
                    data-dfn-for="request" data-dfn-type="dfn" data-noexport
                    id="request-text-directive-user-activation">text directive user activation</dfn>
                があり、初期値はfalse。</p>
        </blockquote>
        <blockquote>
            <p><strong>Monkeypatching <a data-link-type="biblio" href="#biblio-html"
                        title="HTML Standard">[HTML]</a>:</strong></p>
            <p>各<a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-document"
                    id="ref-for-concept-document③">Document</a>は<dfn class="dfn-paneled" data-dfn-for="document"
                    data-dfn-type="dfn" data-noexport id="document-text-directive-user-activation">text directive user
                    activation</dfn>（boolean型、初期値はfalse）を持つ。</p>
            <div class="note" role="note">
                <a data-link-type="dfn" href="#document-text-directive-user-activation"
                    id="ref-for-document-text-directive-user-activation①">text directive user
                    activation</a>は、テキストフラグメントを一度だけアクティベート可能にするためのユーザー操作シグナルです。ドキュメント読み込み中、ユーザーアクティベーションによるナビゲート時のみtrueになり、クライアントサイドリダイレクトでも伝搬します。
                <p><a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-document"
                        id="ref-for-concept-document④">Document</a>の<a data-link-type="dfn"
                        href="#document-text-directive-user-activation"
                        id="ref-for-document-text-directive-user-activation②">text directive user
                        activation</a>がテキストフラグメントのアクティベートに使われなかった場合は、新しいナビゲーション<a data-link-type="dfn"
                        href="https://fetch.spec.whatwg.org/#concept-request"
                        id="ref-for-concept-request②">request</a>の<a data-link-type="dfn"
                        href="#request-text-directive-user-activation"
                        id="ref-for-request-text-directive-user-activation">text directive user
                        activation</a>にもtrueがセットされます。これにより、一つの<a data-link-type="dfn"
                        href="#document-text-directive-user-activation"
                        id="ref-for-document-text-directive-user-activation③">text directive user
                        activation</a>がナビゲーションをまたいで引き継がれます。</p>
                <p>どちらの<a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-document"
                        id="ref-for-concept-document⑥">Document</a>の<a data-link-type="dfn"
                        href="#document-text-directive-user-activation"
                        id="ref-for-document-text-directive-user-activation④">text directive user activation</a>も、<a
                        data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request"
                        id="ref-for-concept-request③">request</a>の<a data-link-type="dfn"
                        href="#request-text-directive-user-activation"
                        id="ref-for-request-text-directive-user-activation①">text directive user
                        activation</a>も、使用された時点で常にfalseになる。これにより、一度のユーザーアクティベーションで複数のテキストフラグメントをアクティベートできなくなる。</p>
            </div>
        </blockquote>
        <div class="note" role="note">
            <p>
                この仕組みにより、多くのWebサイトで用いられる一般的なリダイレクト経由でもテキストフラグメントをアクティベートできます。これらのサイトはスクリプトで
                <tt>window.location</tt>
                をセットする200レスポンスで目的地にリダイレクトします。
            </p>
            <p>
                本当のHTTP(
                <tt>status 3xx</tt>)
                リダイレクトとは異なり、そのような「クライアントサイド」リダイレクトではNaavがユーザー操作の結果かを伝搬できません。<a data-link-type="dfn"
                    href="#document-text-directive-user-activation"
                    id="ref-for-document-text-directive-user-activation⑤">text directive user
                    activation</a>は、この限定的な範囲のユーザーアクティベーションをそのようなナビゲーションで引き継ぐことを可能にします。プログラムでテキストフラグメントにナビゲート可能ですが、一度だけユーザー操作同様のアクティベートが許されます。<code>text fragment user activation</code>はここでリセットされるため以降は新たなユーザーアクションが必要です。
            </p>
            <p> 以下の図は、このフラグがクライアントサイドリダイレクトサービス経由で使われる例を示します: </p>
            <p><img alt="Diagram showing how a text fragment flag is set and used" height="671"
                    src="https://raw.githubusercontent.com/WICG/scroll-to-text-fragment/master/text_fragment_activation_flag.png"
                    style="margin-left:auto;margin-right:auto;display:block" width="745"></p>
            <p> 詳しくは <a href="redirects.md">redirects.md</a> 参照。 </p>
        </div>
        <p><a data-link-type="dfn"
                href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#create-navigation-params-by-fetching"
                id="ref-for-create-navigation-params-by-fetching">create navigation params by fetching</a>手順では、<a
                data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document"
                id="ref-for-nav-document①">active
                document</a>の<a data-link-type="dfn" href="#document-text-directive-user-activation"
                id="ref-for-document-text-directive-user-activation⑥">text directive user
                activation</a>値を<var>request</var>の<a data-link-type="dfn"
                href="#request-text-directive-user-activation" id="ref-for-request-text-directive-user-activation②">text
                directive user activation</a>に伝搬します。
        </p>
        <blockquote>
            <p><strong>Monkeypatching <a data-link-type="biblio" href="#biblio-html"
                        title="HTML Standard">[HTML]</a>:</strong></p>
            <div class="monkeypatch">
                <ol>
                    <li data-md>
                        <p class="assertion">これは並列実行である</p>
                    <li data-md>
                        <p>documentResourceをentryのdocument stateのresourceとする。</p>
                    <li data-md>
                        <p><var>request</var>を新規requestとして作成：</p>
                        <dl class="props">
                            <dt>url
                            <dd><var>entry</var>のURL
                            <dt>...
                            <dd>...
                            <dt>referrer policy
                            <dd><var>entry</var>のdocument stateのrequest referrer policy
                            <dt><span class="diff"><a data-link-type="dfn"
                                        href="#request-text-directive-user-activation"
                                        id="ref-for-request-text-directive-user-activation③">text directive user
                                        activation</a></span>
                            <dd><span class="diff"><var>navigable</var>の<a data-link-type="dfn"
                                        href="https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document"
                                        id="ref-for-nav-document②">active document</a>の<a data-link-type="dfn"
                                        href="#document-text-directive-user-activation"
                                        id="ref-for-document-text-directive-user-activation⑦">text directive user
                                        activation</a></span>
                        </dl>
                    <li data-md>
                        <p><span class="diff"><var>navigable</var>の<a data-link-type="dfn"
                                    href="https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document"
                                    id="ref-for-nav-document③">active document</a>の<a data-link-type="dfn"
                                    href="#document-text-directive-user-activation"
                                    id="ref-for-document-text-directive-user-activation⑧">text directive
                                    user activation</a>をfalseに設定。</span></p>
                    <li data-md>
                        <p>documentResourceがPOST resourceであれば：</p>
                        <ol>
                            <li data-md>
                                <p>...</p>
                        </ol>
                </ol>
            </div>
        </blockquote>
        <p><a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigation-params"
                id="ref-for-navigation-params">navigation params</a>定義にも新しいフィールドを含める：</p>
        <blockquote>
            <p><strong>Monkeypatching <a data-link-type="biblio" href="#biblio-html"
                        title="HTML Standard">[HTML]</a>:</strong></p>
            <dl>
                <dt><dfn class="dfn-paneled" data-dfn-for="navigation params" data-dfn-type="dfn" data-noexport
                        id="navigation-params-user-involvement">user involvement</dfn>
                <dd><a data-link-type="dfn"
                        href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#user-navigation-involvement"
                        id="ref-for-user-navigation-involvement">user navigation involvement</a>値。
            </dl>
        </blockquote>
        <p><a data-link-type="dfn" href="#navigation-params-user-involvement"
                id="ref-for-navigation-params-user-involvement">user involvement</a>値をナビゲーションparams作成時にセット。特に<a
                data-link-type="dfn"
                href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#create-navigation-params-by-fetching"
                id="ref-for-create-navigation-params-by-fetching①">create navigation params by
                fetching</a>のケースでは初期値true：</p>
        <blockquote>
            <p><strong>Monkeypatching <a data-link-type="biblio" href="#biblio-html"
                        title="HTML Standard">[HTML]</a>:</strong></p>
            <div class="monkeypatch">
                To create navigation params by fetching given ... <span class="diff"><a data-link-type="dfn"
                        href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#user-navigation-involvement"
                        id="ref-for-user-navigation-involvement①">user navigation
                        involvement</a> <var>user involvement</var></span>, ...
                <ol>
                    <li data-md>
                        <p class="assertion">アサート：これは並列で実行されている。</p>
                    <li data-md>
                        <p>...</p>
                    <li value="23">resultPolicyContainer を、response の URL、entry の document state の history policy
                        container、sourceSnapshotParams の source policy container、null、および responsePolicyContainer
                        からナビゲーションパラメータポリシーコンテナを決定した結果とする。
                    <li data-md>
                        <p>navigable の container が iframe であり、かつ response の timing allow passed フラグが立っている場合、container の
                            pending resource-timing start time を null に設定する。</p>
                    <li data-md>
                        <p>次の内容を持つ新しいナビゲーションパラメータを返す：</p>
                        <dl>
                            <dt>id
                            <dd>navigationId
                            <dt>...
                            <dd>...
                            <dt>about base URL
                            <dd>entry の document state の about base URL
                            <dt class="diff"><a data-link-type="dfn" href="#navigation-params-user-involvement"
                                    id="ref-for-navigation-params-user-involvement①">ユーザー関与</a>
                            <dd class="diff"><var>user involvement</var>
                        </dl>
                </ol>
            </div>
        </blockquote>
        <p><a href="https://html.spec.whatwg.org/multipage/document-lifecycle.html#initialise-the-document-object">
                Documentオブジェクトの生成と初期化</a>手順にて<a data-link-type="dfn" href="#document-text-directive-user-activation"
                id="ref-for-document-text-directive-user-activation⑨">text directive
                user activation</a>フラグの計算と保存を行う：</p>
        <blockquote>
            <p><strong>Monkeypatching <a data-link-type="biblio" href="#biblio-html"
                        title="HTML Standard">[HTML]</a>:</strong></p>
            <div class="monkeypatch">
                <ol start="18">
                    <li data-md>
                        <p>link headersをdocument, navigationParamsのresponse, "pre-media"で処理。</p>
                    <li data-md>
                        <div class="diff">
                            <var>document</var>の<a data-link-type="dfn" href="#document-text-directive-user-activation"
                                id="ref-for-document-text-directive-user-activation①⓪">text directive user
                                activation</a>を、次条件のいずれかでtrue、そうでなければfalseに設定：
                            <ul>
                                <li data-md>
                                    <p><var>navigationParams</var>の<a data-link-type="dfn"
                                            href="#navigation-params-user-involvement"
                                            id="ref-for-navigation-params-user-involvement②">user
                                            involvement</a>が"<code>activation</code>"</p>
                                <li data-md>
                                    <p><var>navigationParams</var>の<a data-link-type="dfn"
                                            href="#navigation-params-user-involvement"
                                            id="ref-for-navigation-params-user-involvement③">user
                                            involvement</a>が"<code>browser UI</code>"</p>
                                <li data-md>
                                    <p><var>navigationParams</var>のrequestの<a data-link-type="dfn"
                                            href="#request-text-directive-user-activation"
                                            id="ref-for-request-text-directive-user-activation④">text directive user
                                            activation</a>がtrue</p>
                                    <div class="note" role="note"> <a data-link-type="dfn"
                                            href="#document-text-directive-user-activation"
                                            id="ref-for-document-text-directive-user-activation①①">text directive user
                                            activation</a>はコピーできないことが重要であり、ユーザーアクティベートされたナビゲートごとに1回のみテキストフラグメントがアクティベートできる。
                                    </div>
                            </ul>
                        </div>
                    <li data-md>
                        <p>documentを返す。</p>
                </ol>
            </div>
        </blockquote>
        <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="text-directive-allowing-mime-type">text
                directive allowing MIME type</dfn>は、<a data-link-type="dfn"
                href="https://mimesniff.spec.whatwg.org/#mime-type" id="ref-for-mime-type">MIME type</a>の<a
                data-link-type="dfn" href="https://mimesniff.spec.whatwg.org/#mime-type-essence"
                id="ref-for-mime-type-essence">essence</a>が"<code>text/html</code>"または"<code>text/plain</code>"であるもの。
        </p>
        <p class="note" role="note"><span class="marker">注:</span> <a
                href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#scrolling-to-a-fragment">scrolling
                to a fragment</a>で述べられているように、フラグメント処理は各MIME Typeごとに定義されています。したがって<a data-link-type="dfn"
                href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#scroll-to-the-fragment-identifier"
                id="ref-for-scroll-to-the-fragment-identifier②">scroll to the
                fragment</a>でのテキストディレクティブスクロールはtext/htmlメディアタイプのみが対象。ただし実際にはブラウザはtext/plainにもHTML方式のフラグメント処理を適用することがあり、そのためtext/plainへのテキストディレクティブ適用許可が有用です。text/css,
            application/json, application/javascript等は明示的に除外され、XS-Search攻撃等への配慮です。</p>
        <p class="issue" id="issue-0e1d8eda"><a class="self-link" href="#issue-0e1d8eda"></a> この記述はHTML仕様として妥当か？</p>
        <div class="algorithm" data-algorithm="check if a text directive can be scrolled">
            <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-document"
                id="ref-for-concept-document⑦">Document</a> <var>document</var>、<a data-link-type="dfn"
                href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin"
                id="ref-for-concept-origin">origin</a>またはnull <var>initiator origin</var>、<a data-link-type="dfn"
                href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#user-navigation-involvement"
                id="ref-for-user-navigation-involvement②">user navigation involvement</a>またはnull <var>user
                involvement</var>を受け取って
            <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport
                id="check-if-a-text-directive-can-be-scrolled">テキストディレクティブがスクロール可能か判定</dfn>手順:
            <ol class="algorithm">
                <li data-md>
                    <p>documentの<a data-link-type="dfn" href="#document-pending-text-directives"
                            id="ref-for-document-pending-text-directives①①">保留中テキストディレクティブ</a>がnullまたは空ならfalseを返す。</p>
                <li data-md>
                    <p>is user involvedを次のいずれかでtrue、そうでなければfalseとする：documentの<a data-link-type="dfn"
                            href="#document-text-directive-user-activation"
                            id="ref-for-document-text-directive-user-activation①②">text directive user
                            activation</a>がtrue、またはuser
                        involvementが"<code>activation</code>"または"<code>browser UI</code>"</p>
                <li data-md>
                    <p>documentの<a data-link-type="dfn" href="#document-text-directive-user-activation"
                            id="ref-for-document-text-directive-user-activation①③">text directive user
                            activation</a>をfalseに。</p>
                <li data-md>
                    <p>documentの<a data-link-type="dfn"
                            href="https://dom.spec.whatwg.org/#concept-document-content-type"
                            id="ref-for-concept-document-content-type">content type</a>が<a data-link-type="dfn"
                            href="#text-directive-allowing-mime-type"
                            id="ref-for-text-directive-allowing-mime-type">text directive allowing MIME
                            type</a>でなければfalse。</p>
                <li data-md>
                    <p>user involvementが"<code>browser UI</code>"ならtrue。</p>
                    <div class="note" role="note">
                        <p>ナビゲーションがブラウザUIからのものなら常に許可、ユーザー起因でありページ/スクリプトがテキスト片を与えないため。</p>
                        <p>この項の意図はアプリ/ページがURL制御可能なケースと完全にユーザー側制御なケースを区別することにある。前者では、宛先が別のブラウジングコンテキストグループ（元ページがテキスト片と副作用を両方制御できない）でない限りテキストフラグメントのスクロールを防ぐ必要がある。UIによる「新しいウィンドウで開く」等、グレーなケースもある。
                        </p>
                        <p><a
                                href="https://w3c.github.io/webappsec-fetch-metadata/#directly-user-initiated">sec-fetch-site</a>も参照。
                        </p>
                    </div>
                <li data-md>
                    <p>is user involvedがfalseならfalse。</p>
                <li data-md>
                    <p>documentの<a data-link-type="dfn"
                            href="https://html.spec.whatwg.org/multipage/document-sequences.html#node-navigable"
                            id="ref-for-node-navigable">node navigable</a>に<a data-link-type="dfn"
                            href="https://html.spec.whatwg.org/multipage/document-sequences.html#nav-parent"
                            id="ref-for-nav-parent">parent</a>があればfalse。</p>
                <li data-md>
                    <p>initiator originがnullでなく、documentの<a data-link-type="dfn"
                            href="https://dom.spec.whatwg.org/#concept-document-origin"
                            id="ref-for-concept-document-origin">origin</a>が<var>initiator origin</var>と<a
                            data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#same-origin"
                            id="ref-for-same-origin">same origin</a>ならtrue。</p>
                <li data-md>
                    <p>documentの<a data-link-type="dfn"
                            href="https://html.spec.whatwg.org/multipage/document-sequences.html#concept-document-bc"
                            id="ref-for-concept-document-bc">browsing context</a>の<a data-link-type="dfn"
                            href="https://html.spec.whatwg.org/multipage/browsers.html#tlbc-group"
                            id="ref-for-tlbc-group">group</a>の<a data-link-type="dfn"
                            href="https://html.spec.whatwg.org/multipage/document-sequences.html#browsing-context-set"
                            id="ref-for-browsing-context-set">browsing context set</a>が長さ1ならtrue。</p>
                    <div class="note" role="note">
                        つまりクロスオリジン要素/スクリプトからのナビゲートは、documentがnoopenerな場合のみ許可。ナビがスクリプトアクセス不可で別プロセスに分離可能な新規トップレベルbrowsing
                        contextであること。</div>
                <li data-md>
                    <p>その他の場合false。</p>
            </ol>
        </div>
        <p><a href="#invoking-text-directives">§ 3.4.1 テキストディレクティブの呼び出し</a>ですでに修正済みの<a data-link-type="dfn"
                href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#scroll-to-the-fragment-identifier"
                id="ref-for-scroll-to-the-fragment-identifier③">scroll to the fragment</a>手順にboolean型<var>allow text
                directive scroll</var>引数を追加：</p>
        <blockquote>
            <p><strong>Monkeypatching <a
                        href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#scrolling-to-a-fragment"><cite>HTML</cite>
                        § 7.4.6.3 フラグメントへのスクロール</a>:</strong></p>
            <div class="monkeypatch">
                Document <var>document</var>、boolean <var>allow text directive scroll</var>引数で
                scroll to the fragmentを実行：
                <ol>
                    <li data-md>
                        <p>ドキュメントの indicated part が null の場合、ドキュメントの target element を null に設定する。</p>
                    <li data-md>
                        <p>...</p>
                    <li data-md>
                        <p>それ以外の場合：</p>
                        <ol>
                            <li data-md>
                                <p class="assertion">アサート：ドキュメントの indicated part は要素、または <a data-link-type="dfn"
                                        href="https://dom.spec.whatwg.org/#concept-range"
                                        id="ref-for-concept-range⑨">range</a> である。</p>
                            <li data-md>
                                <p>...</p>
                            <li value="4"><var>target</var> が <a data-link-type="dfn"
                                    href="https://dom.spec.whatwg.org/#concept-range"
                                    id="ref-for-concept-range①⓪">range</a> の場合：
                                <ol>
                                    <li data-md>
                                        <p><span class="diff"><var>allow text directive scroll</var> が false
                                                なら、return。</span></p>
                                    <li data-md>
                                        <p><var>target</var> を <var>target</var> の <a data-link-type="dfn"
                                                href="#first-common-ancestor"
                                                id="ref-for-first-common-ancestor①">最初の共通祖先</a>（<var>target</var> の <a
                                                data-link-type="dfn"
                                                href="https://dom.spec.whatwg.org/#concept-range-start-node"
                                                id="ref-for-concept-range-start-node①">start node</a> と <a
                                                data-link-type="dfn"
                                                href="https://dom.spec.whatwg.org/#concept-range-end-node"
                                                id="ref-for-concept-range-end-node①">end node</a>）にする。</p>
                                    <li data-md>
                                        <p>...</p>
                                </ol>
                        </ol>
                </ol>
            </div>
        </blockquote>
        <p><a data-link-type="dfn"
                href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#try-to-scroll-to-the-fragment"
                id="ref-for-try-to-scroll-to-the-fragment">try to scroll to the fragment</a>を修正、boolean型<var>allow text
                directive scroll</var>を引数に持ち、手順2のタスク内容を差し替え：</p>
        <blockquote>
            <p><strong>Monkeypatching <a data-link-type="biblio" href="#biblio-html"
                        title="HTML Standard">[HTML]</a>:</strong></p>
            <div class="monkeypatch">
                Document <var>document</var>とboolean <var>allow text directive scroll</var> でtry to scroll to the
                fragmentを並列実行：
                <ol>
                    <li data-md>
                        <p>実装依存の時間wait。</p>
                    <li data-md>
                        <p>documentのrelevant global objectでnavigation/traversal task sourceのグローバルタスクとして以下：</p>
                        <ol>
                            <li data-md>
                                <p>documentにparserがない/停止済/ユーザーがスクロール希望でないならabort。</p>
                            <li data-md>
                                <p><var>document</var>と<var>allow text directive scroll</var>でscroll to the fragmentを実行。
                                </p>
                            <li data-md>
                                <p>documentの指示部分がnullなら再度try to scroll to the fragment(<var>allow text directive
                                        scroll</var>)。</p>
                        </ol>
                </ol>
            </div>
        </blockquote>
        <p><a data-link-type="dfn"
                href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#update-document-for-history-step-application"
                id="ref-for-update-document-for-history-step-application①">update document for history step
                application</a>手順でもboolean <var>allow text directive scroll</var>を引数に持ち、scroll to a fragment時に利用：</p>
        <blockquote>
            <p><strong>Monkeypatching <a data-link-type="biblio" href="#biblio-html"
                        title="HTML Standard">[HTML]</a>:</strong></p>
            <div class="monkeypatch">
                Document document, session history entry entry, boolean doNotReactivate,
                数値scriptHistoryLengthとIndex、entriesForNavigationAPI（任意）、<span class="diff">boolean <var>allow text
                        directive scroll</var></span>引数でupdate document for history step application手順：
                <ol>
                    <li data-md>
                        <p>documentIsNewはdocumentのlatest entryがnullならtrue。</p>
                    <li data-md>
                        <p>...</p>
                    <li value="5">
                        documentsEntryChangedがtrueの場合：
                        <ol>
                            <li data-md>
                                <p>oldURL = documentのlatest entryのURL</p>
                            <li data-md>
                                <p>...</p>
                        </ol>
                    <li data-md>
                        <p>documentIsNewがtrueなら：</p>
                        <ol>
                            <li data-md>
                                <p>documentと<var>allow text directive scroll</var>でtry to scroll to the fragment実行</p>
                        </ol>
                </ol>
            </div>
        </blockquote>
        <p><a data-link-type="dfn"
                href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#apply-the-history-step"
                id="ref-for-apply-the-history-step">apply the history step</a>アルゴリズムもboolean <var>allow text directive
                scroll</var>引数を持ち、<a data-link-type="dfn"
                href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#update-document-for-history-step-application"
                id="ref-for-update-document-for-history-step-application②">update document for history step application
            </a>へ渡す：</p>
        <blockquote>
            <p><strong>Monkeypatching <a data-link-type="biblio" href="#biblio-html"
                        title="HTML Standard">[HTML]</a>:</strong></p>
            <div class="monkeypatch">
                <p>apply the history step handoff... <span class="diff">boolean <var>allow text directive
                            scroll</var>（デフォルトfalse）</span>で呼び出し</p>
                <ol start="14">
                    <li data-md>
                        <p>completedChangeJobs が totalChangeJobs と等しくない間：</p>
                        <ol>
                            <li data-md>
                                <p>...</p>
                            <li value="11">
                                navigation and traversal task source で、navigable の active window
                                に対し次のステップを実行するグローバルタスクをキューする：
                                <ol>
                                    <li data-md>
                                        <p>changingNavigableContinuation の update-only が false の場合：</p>
                                        <ol>
                                            <li data-md>
                                                <p>...</p>
                                            <li data-md>
                                                <p>navigable の targetEntry の履歴エントリをアクティブ化する。</p>
                                        </ol>
                                    <li data-md>
                                        <p>updateDocument を次のアルゴリズムステップとする：targetEntry の
                                            document、targetEntry、changingNavigableContinuation の
                                            update-only、scriptHistoryLength、scriptHistoryIndex、entriesForNavigationAPI、<span
                                                class="diff">および <var>allow text directive scroll</var></span>
                                            を指定して履歴ステップ適用のためのドキュメント更新を実行する。</p>
                                    <li data-md>
                                        <p><var>targetEntry</var> の document が displayedDocument と等しければ、updateDocument
                                            を実行する。</p>
                                </ol>
                        </ol>
                    <li data-md>
                        <p>totalNonchangingJobs を nonchangingNavigablesThatStillNeedUpdates のサイズとする。</p>
                </ol>
            </div>
        </blockquote>
        <p><a data-link-type="dfn"
                href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#apply-the-push%2Freplace-history-step"
                id="ref-for-apply-the-push%2Freplace-history-step">apply the push/replace history step</a>でも<var>allow
                text
                directive scrolling</var>をapply the history stepへ渡す：</p>
        <blockquote>
            <p><strong>Monkeypatching <a data-link-type="biblio" href="#biblio-html"
                        title="HTML Standard">[HTML]</a>:</strong></p>
            <div class="monkeypatch">
                apply the push/replace history step handoff... <span class="diff">boolean <var>allow text directive
                        scroll</var>（デフォルトfalse）</span>で呼び出し
                <p>apply the history step内でfalse, null, null, null, <span class="diff"><var>allow text directive
                            scroll</var></span>を渡し実行。</p>
            </div>
        </blockquote>
        <p class="note" role="note"><span class="marker">注:</span> <var>allow text directive
                scroll</var>はトラバースやリロード時には意図的にセットされません。イニシエーターオリジンやユーザー関与のチェック回避や履歴スクロール状態優先のためです。テキストディレクティブはドキュメントの指示部分として使われるため、ハイライトは復元される。
        </p>
        <p><a data-link-type="dfn"
                href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#finalize-a-cross-document-navigation"
                id="ref-for-finalize-a-cross-document-navigation">finalize a cross-document navigation</a>に<var>user
                involvement</var>引数を渡し、<var>allow text directive scrolling</var>も計算・伝搬：</p>
        <blockquote>
            <p><strong>Monkeypatching <a data-link-type="biblio" href="#biblio-html"
                        title="HTML Standard">[HTML]</a>:</strong></p>
            <div class="monkeypatch">
                finalize a cross-document navigation handoff...<span class="diff"><a data-link-type="dfn"
                        href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#user-navigation-involvement"
                        id="ref-for-user-navigation-involvement③">user
                        navigation involvement</a> <var>user involvement</var></span>、...
                <ol>
                    <li data-md>
                        <p>...</p>
                    <li value="10"><span class="diff"><var>allow text directive scroll</var>を<a data-link-type="dfn"
                                href="#check-if-a-text-directive-can-be-scrolled"
                                id="ref-for-check-if-a-text-directive-can-be-scrolled">テキストディレクティブがスクロール可能か判定</a>で計算し、historyEntryのdocument,
                            entryのdocument state, initiator origin, user involvement引数で渡す</span>
                    <li data-md>
                        <p>apply the push/replace history step targetStep to traversable, <span class="diff">with
                                allow text directive scroll</span></p>
                </ol>
            </div>
        </blockquote>
        <p><a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigate"
                id="ref-for-navigate①">navigate</a>アルゴリズムにてuser involvementをfinalize a cross-document navigationへ伝播：</p>
        <blockquote>
            <p><strong>Monkeypatching <a data-link-type="biblio" href="#biblio-html"
                        title="HTML Standard">[HTML]</a>:</strong></p>
            <div class="monkeypatch">
                <ol>
                    <li data-md>
                        <p>...</p>
                    <li value="20">. 並列で次の手順を実行する：
                        <ol>
                            <li data-md>
                                <p>...</p>
                            <li value="9">. allowPOST を true、completionSteps
                                を次の手順とし、navigable、"navigate"、sourceSnapshotParams、targetSnapshotParams、navigationId、navigationParams、cspNavigationType
                                を指定して historyEntry のための履歴エントリの document を生成しようとする：
                                <ol>
                                    <li data-md>
                                        <p>navigable、historyHandling、historyEntry、<span class="diff">および
                                                <var>userInvolvement</var></span>
                                            を指定して、セッションクロスドキュメントナビゲーションを完了するためのセッション履歴トラバーサル手順を navigable の traversable
                                            に追加する。</p>
                                </ol>
                        </ol>
                </ol>
            </div>
        </blockquote>
        <p><a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigate-fragid"
                id="ref-for-navigate-fragid">Navigate to a fragment</a>アルゴリズムも<var>initiator origin</var>を引数にとり、
            <var>allow text directive scroll</var>をフラグメントスクロール時に渡す：
        </p>
        <blockquote>
            <p><strong>Monkeypatching <a data-link-type="biblio" href="#biblio-html"
                        title="HTML Standard">[HTML]</a>:</strong></p>
            <div class="monkeypatch">
                navigate to a fragment handoff... navigable, URL, ..., userInvolvement, navigationAPIState,
                navigationId,
                <span class="diff"><a data-link-type="dfn"
                        href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin"
                        id="ref-for-concept-origin①">origin</a> initiator origin</span>...
                <ol>
                    <li data-md>
                        <p>...</p>
                    <li value="14"> navigableのactive document, historyEntry, true, ...などでupdate document for history
                        step application
                    <li data-md>
                        <p>...</p>
                    <li data-md>
                        <p><span class="diff"><var>allow text directive scroll</var>をcheck if a text directive can be
                                scrolledで計算（active document, initiator origin, userInvolvement）</span></p>
                    <li data-md>
                        <p>active document, allow text directive scrollでscroll to the fragment呼び出し</p>
                </ol>
            </div>
        </blockquote>
        <p><a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigate"
                id="ref-for-navigate②">navigate</a>アルゴリズムでfragment navigationする際にinitiator originを渡す：</p>
        <blockquote>
            <p><strong>Monkeypatching <a data-link-type="biblio" href="#biblio-html"
                        title="HTML Standard">[HTML]</a>:</strong></p>
            <div class="monkeypatch">
                <ol start="10">
                    <li data-md>
                        <p>navigation must be a replaceの判定（...）</p>
                    <li data-md>
                        <p>次4条件がすべてtrueの場合：</p>
                        <ul>
                            <li data-md>
                                <p>documentResourceがnull</p>
                            <li data-md>
                                <p>responseがnull</p>
                            <li data-md>
                                <p>urlがnavigableのactive session history entryのURL(fragment除去)と等しい</p>
                            <li data-md>
                                <p>urlのfragmentがnon-null</p>
                        </ul>
                        <p>なら：</p>
                        <ol>
                            <li data-md>
                                <p>navigate to a fragment(navigable, url, historyHandling, userInvolvement,
                                    navigationAPIState, navigationId, <span class="diff">initiatorOriginSnapshot</span>)
                                </p>
                            <li data-md>
                                <p>navigation = navigableのactive windowのnavigation API</p>
                        </ol>
                </ol>
            </div>
        </blockquote>
        <h4 class="heading settled" data-level="3.5.5" id="restricting-scroll-on-load"><span class="secno">3.5.5.
            </span><span class="content">ロード時のスクロール制限</span><a class="self-link" href="#restricting-scroll-on-load"></a>
        </h4>
        <p>このセクションでは、新しいドキュメントの読み込み時に、テキストディレクティブなどを含むすべての種類のスクロールを防ぐために、<code>force-load-at-top</code>
            ポリシーがどのように使用されるかを定義します。</p>
        <p class="issue" id="issue-de0fed9d"><a class="self-link" href="#issue-de0fed9d"></a>
            <code>force-load-at-top</code> がナビゲーションAPIとどのように連携するかを決定する必要があります。<a
                href="https://github.com/WICG/scroll-to-text-fragment/issues/242">[Issue
                #WICG/scroll-to-text-fragment#242]</a>
        </p>
        <p><a data-link-type="dfn"
                href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#restore-persisted-state"
                id="ref-for-restore-persisted-state">保存状態の復元</a>ステップを修正し、スクロールの復元を抑制する新しいブールパラメーターを受け取るようにします：</p>
        <blockquote>
            <p><strong>Monkeypatching <a data-link-type="biblio" href="#biblio-html"
                        title="HTML Standard">[HTML]</a>:</strong></p>
            <div class="monkeypatch">
                セッション履歴エントリ <var>entry</var> <span class="diff">, およびブール値 <var>suppressScrolling</var></span>
                から保存状態を復元するには：
                <ol>
                    <li data-md>
                        <p>entryのスクロール復元モードが "auto"、 <span class="diff"><var>suppressScrolling</var>
                                がfalse</span>、かつentryのドキュメントの関連グローバルオブジェクトのナビゲーションAPIの ongoing
                            navigation中の通常のスクロール復元抑制がfalseであれば、entryを指定してスクロール位置データを復元する。</p>
                    <li data-md>
                        <p>...</p>
                </ol>
            </div>
        </blockquote>
        <p><a data-link-type="dfn"
                href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#update-document-for-history-step-application"
                id="ref-for-update-document-for-history-step-application③">履歴ステップ適用のためのドキュメント更新</a>ステップを修正し、
            <code>force-load-at-top</code> ポリシーを確認することで、新しいドキュメントで設定されていればスクロールを回避します。
        </p>
        <blockquote>
            <p><strong>Monkeypatching <a data-link-type="biblio" href="#biblio-html"
                        title="HTML Standard">[HTML]</a>:</strong></p>
            <div class="monkeypatch">
                <ol>
                    <li data-md>
                        <p>...</p>
                    <li value="4">documentの履歴オブジェクトのlengthを scriptHistoryLength に設定する。
                    <li data-md>
                        <p><span class="diff"><var>scrollingBlockedInNewDocument</var> を <a
                                    href="https://wicg.github.io/document-policy#algo-get-policy-value">ポリシー値の取得</a>
                                を使って <code>force-load-at-top</code> を <var>document</var> に対して取得した結果とする。</span></p>
                    <li data-md>
                        <p>documentsEntryChanged が true の場合、次を行う：</p>
                        <ol>
                            <li data-md>
                                <p>oldURL を document の latest entry の URL とする。</p>
                            <li data-md>
                                <p>...</p>
                            <li value="5">
                                documentIsNew が false の場合：
                                <ol>
                                    <li data-md>
                                        <p>ナビゲーション、entry、"traverse" を指定して、同一ドキュメントナビゲーション用のナビゲーションAPIエントリを更新する。</p>
                                    <li data-md>
                                        <p>popstate という名前のイベントを発火する...</p>
                                    <li data-md>
                                        <p>entry <span class="diff">および <var>suppressScrolling</var>
                                                をfalseにして</span>保存状態を復元する。</p>
                                    <li data-md>
                                        <p>oldURLのフラグメントが...でなければ</p>
                                </ol>
                            <li data-md>
                                <p>それ以外の場合、</p>
                                <ol>
                                    <li data-md>
                                        <p class="assertion">Assert: entriesForNavigationAPI が与えられている。</p>
                                    <li data-md>
                                        <p>entry <span class="diff">および <var>scrollingBlockedInNewDocument</var></span>
                                            で保存状態を復元する。</p>
                                    <li data-md>
                                        <p>ナビゲーション、entriesForNavigationAPI、entry を指定して新しいドキュメント用のナビゲーションAPIエントリを初期化する。
                                        </p>
                                </ol>
                        </ol>
                    <li data-md>
                        <p>documentIsNew が true の場合、</p>
                        <ol>
                            <li data-md>
                                <p><span class="diff"><var>scrollingBlockedInNewDocument</var>
                                        がfalseであれば、</span>ドキュメントのフラグメントへスクロールを試みる。</p>
                            <li data-md>
                                <p>この時点でスクリプトが新たに生成された document 用に実行される場合がある。</p>
                        </ol>
                    <li data-md>
                        <p>それ以外で、documentsEntryChanged が false かつ doNotReactivate が false なら：</p>
                        <ol>
                            <li data-md>
                                <p>...</p>
                        </ol>
                </ol>
            </div>
        </blockquote>
        <h3 class="heading settled" data-level="3.6" id="navigating-to-text-fragment"><span class="secno">3.6.
            </span><span class="content">テキストフラグメントへのナビゲーション</span><a class="self-link"
                href="#navigating-to-text-fragment"></a></h3>
        <div class="note" role="note"> テキストフラグメント仕様は <a
                href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#scroll-to-fragid"><cite>HTML</cite>
                § 7.4.2.3.3 フラグメントナビゲーション</a> への修正を提案しています。要約すると、<a data-link-type="dfn" href="#text-directive"
                id="ref-for-text-directive①⓪">テキストディレクティブ</a>
            が存在し、ページ内で一致が見つかった場合、テキストフラグメントが要素フラグメントよりも優先され表示部分として扱われます。HTMLドキュメントの
            indicated part 処理モデルを修正し、<a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range"
                id="ref-for-concept-range①①">range</a> を返すようにします（これまでの
            <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-element"
                id="ref-for-concept-element②">element</a> ではなく）。このrangeがスクロールインビューされます。
        </div>
        <div class="algorithm" data-algorithm="first common ancestor">
            2つのノード <var>nodeA</var> と <var>nodeB</var> の<dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport
                id="first-common-ancestor">最初の共通祖先</dfn>を見つけるには、次の手順を実行します：
            <ol class="algorithm">
                <li data-md>
                    <p><var>commonAncestor</var> を <var>nodeA</var> にする。</p>
                <li data-md>
                    <p><var>commonAncestor</var> がnullでなく、かつ<a data-link-type="dfn"
                            href="https://dom.spec.whatwg.org/#concept-shadow-including-inclusive-ancestor"
                            id="ref-for-concept-shadow-including-inclusive-ancestor">shadow-including inclusive
                            ancestor</a> でない場合、<var>commonAncestor</var> を
                        <var>commonAncestor</var> の<a data-link-type="dfn" href="#shadow-including-parent"
                            id="ref-for-shadow-including-parent">shadow-including parent</a> にする。
                    </p>
                <li data-md>
                    <p><var>commonAncestor</var> を返す。</p>
            </ol>
        </div>
        <div class="algorithm" data-algorithm="shadow-including parent">
            <var>node</var> の <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport
                id="shadow-including-parent">shadow-including parent</dfn> を見つけるには次の手順を実行します：
            <ol class="algorithm">
                <li data-md>
                    <p><var>node</var> が <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-shadow-root"
                            id="ref-for-concept-shadow-root">shadow root</a> の場合、 <var>node</var> の <a
                            data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-documentfragment-host"
                            id="ref-for-concept-documentfragment-host">host</a> を返す。</p>
                <li data-md>
                    <p>それ以外の場合、<var>node</var> の <a data-link-type="dfn"
                            href="https://dom.spec.whatwg.org/#concept-tree-parent"
                            id="ref-for-concept-tree-parent①">parent</a> を返す。</p>
            </ol>
        </div>
        <h4 class="heading settled" data-level="3.6.1" id="finding-ranges-in-a-document"><span class="secno">3.6.1.
            </span><span class="content">ドキュメント内の範囲の特定</span><a class="self-link"
                href="#finding-ranges-in-a-document"></a></h4>
        <div class="note" role="note">
            このセクションでは、フラグメントディレクティブ文字列をドキュメント内の<a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range"
                id="ref-for-concept-range①②">Range</a> のリストに変換する方法を規定する複数のアルゴリズムと定義を示します。
            <p>概略では、次のようなフラグメントディレクティブ文字列を受け取ります：</p>
            <pre>text=prefix-,foo&amp;unknown&amp;text=bar,baz
</pre>
            <p>これを個々のテキストディレクティブに分けます：</p>
            <pre>text=prefix-,foo
text=bar,baz
</pre>
            <p>各テキストディレクティブごとに、ディレクティブ内の制限条件に一致するレンダリング済みテキストの最初のインスタンスをドキュメント内で検索します。
                検索はそれぞれ独立しており、他にいくつディレクティブがあっても、また一致結果にかかわらず、同じ結果となります。</p>
            <p>ディレクティブが文書内テキストと一致した場合、ドキュメント内の一致する部分を示す<a data-link-type="dfn"
                    href="https://dom.spec.whatwg.org/#concept-range" id="ref-for-concept-range①③">range</a>を返します。<a
                    data-link-type="dfn" href="#invoke-text-directives"
                    id="ref-for-invoke-text-directives①">テキストディレクティブの実行</a>ステップがこのセクションで提供される上位APIです。
                これらは、個々のディレクティブ毎のマッチングステップで一致した<a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range"
                    id="ref-for-concept-range①④">range</a>の <a data-link-type="dfn"
                    href="https://infra.spec.whatwg.org/#list" id="ref-for-list④">リスト</a> を（ディレクティブ文字列に指定された順に）返します。</p>
            <p>ディレクティブが一致しなかった場合、その戻り値リストにはアイテムを追加しません。</p>
        </div>
        <div class="algorithm" data-algorithm="invoke text directives">
            <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport
                id="invoke-text-directives">テキストディレクティブの実行</dfn>を行うには、入力として<a data-link-type="dfn"
                href="https://infra.spec.whatwg.org/#list" id="ref-for-list⑤">リスト</a> の<a data-link-type="dfn"
                href="#text-directive" id="ref-for-text-directive①①">テキストディレクティブ</a> <var>text directives</var>と<a
                data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-document"
                id="ref-for-concept-document⑧">Document</a> <var>document</var> を受け取り、次のステップを実行します：
            <div class="note" role="note"> このアルゴリズムは表示指示用の <a data-link-type="dfn"
                    href="https://infra.spec.whatwg.org/#list" id="ref-for-list⑥">range</a>の<a data-link-type="dfn"
                    href="https://dom.spec.whatwg.org/#concept-range" id="ref-for-concept-range①⑤">リスト</a>を返します。
                最初のrangeは（UAが自動スクロールする場合）インビューとなります。 </div>
            <ol class="algorithm">
                <li data-md>
                    <p><var>ranges</var> を <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list"
                            id="ref-for-list⑦">rangeリスト</a>（初期値は空）にする。</p>
                <li data-md>
                    <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-iterate"
                            id="ref-for-list-iterate①">各</a><a data-link-type="dfn" href="#text-directive"
                            id="ref-for-text-directive①②">テキストディレクティブ</a> <var>directive</var> について：</p>
                    <ol>
                        <li data-md>
                            <p><a data-link-type="dfn" href="#find-a-range-from-a-text-directive"
                                    id="ref-for-find-a-range-from-a-text-directive①">テキストディレクティブから範囲を探す</a> を
                                <var>directive</var> と <var>document</var> で実行した結果が null でなければ、それを <a
                                    data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-append"
                                    id="ref-for-list-append①">ranges に追加</a> する。
                            </p>
                    </ol>
                <li data-md>
                    <p><var>ranges</var> を返す。</p>
            </ol>
        </div>
        <div class="algorithm" data-algorithm="find a range from a text directive">
            <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport
                id="find-a-range-from-a-text-directive">テキストディレクティブから範囲を探す</dfn>には、
            <a data-link-type="dfn" href="#text-directive" id="ref-for-text-directive①③">テキストディレクティブ</a>
            <var>parsedValues</var>、<a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-document"
                id="ref-for-concept-document⑨">Document</a> <var>document</var> を受け取り、次の手順を実行する：
            <div class="note" role="note">
                このアルゴリズムはパース済みテキストディレクティブと検索対象ドキュメントを入力とし、
                条件に一致し周辺コンテキストも満たす最初のテキスト部分に該当する<a data-link-type="dfn"
                    href="https://dom.spec.whatwg.org/#concept-range" id="ref-for-concept-range①⑦">range</a>を返します。
                該当部分が存在しなければnullを返します。
                <p><a data-link-type="dfn" href="#text-directive-end" id="ref-for-text-directive-end①">end</a>
                    はnull可です。省略した場合「完全一致」検索となり、返される <a data-link-type="dfn"
                        href="https://dom.spec.whatwg.org/#concept-range" id="ref-for-concept-range①⑧">range</a>は<a
                        data-link-type="dfn" href="#text-directive-start" id="ref-for-text-directive-start②">start</a>
                    と完全一致する文字列となります。
                    <a data-link-type="dfn" href="#text-directive-end" id="ref-for-text-directive-end②">end</a>
                    があれば「範囲検索」となり、返される <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range"
                        id="ref-for-concept-range①⑨">range</a>は
                    <a data-link-type="dfn" href="#text-directive-start" id="ref-for-text-directive-start③">start</a>〜<a
                        data-link-type="dfn" href="#text-directive-end" id="ref-for-text-directive-end③">end</a>
                    で始まります。正規な条件に合致するテキスト部分を、
                    以下「matching text」と呼びます。
                </p>
                <p><a data-link-type="dfn" href="#text-directive-prefix" id="ref-for-text-directive-prefix①">prefix</a>
                    と<a data-link-type="dfn" href="#text-directive-suffix"
                        id="ref-for-text-directive-suffix①">suffix</a>は両方またはいずれかがnull可で、その場合片側のコンテキストはチェックしません。例：<a
                        data-link-type="dfn" href="#text-directive-prefix"
                        id="ref-for-text-directive-prefix②">prefix</a>がnullなら前方のテキスト制約なしで一致。</p>
            </div>
            <div class="note" role="note">
                一致するテキストおよびprefix/suffixはブロック境界をまたぐことができますが、個々のパラメーター自体はまたげません。
                すなわち、<a data-link-type="dfn" href="#text-directive-prefix"
                    id="ref-for-text-directive-prefix③">prefix</a>、<a data-link-type="dfn" href="#text-directive-start"
                    id="ref-for-text-directive-start⑤">start</a>、<a data-link-type="dfn" href="#text-directive-end"
                    id="ref-for-text-directive-end⑤">end</a>、<a data-link-type="dfn" href="#text-directive-suffix"
                    id="ref-for-text-directive-suffix②">suffix</a>は単一ブロック内のみ一致。
                <div class="example" id="example-73638554">
                    <a class="self-link" href="#example-73638554"></a>
                    <pre>:~:text=The quick,lazy dog</pre>
                    次の例では一致しません
                    <pre>&lt;div>The&lt;div> &lt;/div>quick brown fox&lt;/div>
&lt;div>jumped over the lazy dog&lt;/div>
</pre>
                    <p>なぜなら "The quick" という開始文字列が同一かつ途切れないブロック内に登場しないからです。ドキュメント内の"The quick"
                        は"The"と"quick"の間にブロック要素が挟まっています。</p>
                    <p>ただしこの例なら一致します：</p>
                    <pre>&lt;div>The quick brown fox&lt;/div>
&lt;div>jumped over the lazy dog&lt;/div>
</pre>
                </div>
            </div>
            <ol class="algorithm">
                <li data-md>
                    <p><var>searchRange</var> を <a data-link-type="dfn"
                            href="https://dom.spec.whatwg.org/#concept-range"
                            id="ref-for-concept-range②⓪">Range</a>（開始：<var>document</var>, 0、終了：<var>document</var>
                        の長さ）とする</p>
                <li data-md>
                    <p><var>searchRange</var> が<a data-link-type="dfn"
                            href="https://dom.spec.whatwg.org/#range-collapsed"
                            id="ref-for-range-collapsed">collapsed</a> でないかぎり：</p>
                    <ol>
                        <li data-md>
                            <p><var>potentialMatch</var> を null に。</p>
                        <li data-md>
                            <p><var>parsedValues</var> の<a data-link-type="dfn" href="#text-directive-prefix"
                                    id="ref-for-text-directive-prefix④">prefix</a>が null でない場合：</p>
                            <ol>
                                <li data-md>
                                    <p><var>prefixMatch</var> を <a data-link-type="dfn" href="#find-a-string-in-range"
                                            id="ref-for-find-a-string-in-range">範囲内文字列検索</a> を、
                                        <var>query</var> <var>parsedValues</var> の <a data-link-type="dfn"
                                            href="#text-directive-prefix"
                                            id="ref-for-text-directive-prefix⑤">prefix</a>、 <var>searchRange</var>
                                        <var>searchRange</var>、<var>wordStartBounded</var>
                                        true、<var>wordEndBounded</var> false で実行した結果とする。
                                    </p>
                                <li data-md>
                                    <p><var>prefixMatch</var> が null であれば null を返す。</p>
                                <li data-md>
                                    <p><var>searchRange</var> の<a data-link-type="dfn"
                                            href="https://dom.spec.whatwg.org/#concept-range-start"
                                            id="ref-for-concept-range-start①">start</a> を <var>prefixMatch</var> の
                                        <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-bp"
                                            id="ref-for-concept-range-bp">boundary point</a> の後ろ <a data-link-type="dfn"
                                            href="https://dom.spec.whatwg.org/#concept-range-bp-after"
                                            id="ref-for-concept-range-bp-after">after</a> にセット
                                    </p>
                                <li data-md>
                                    <p><var>matchRange</var> を <a data-link-type="dfn"
                                            href="https://dom.spec.whatwg.org/#concept-range"
                                            id="ref-for-concept-range②①">Range</a>（開始：<var>prefixMatch</var>の<a
                                            data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-end"
                                            id="ref-for-concept-range-end①">end</a>、終了：<var>searchRange</var>の<a
                                            data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-end"
                                            id="ref-for-concept-range-end②">end</a>）とする。</p>
                                <li data-md>
                                    <p><var>matchRange</var> の<a data-link-type="dfn"
                                            href="https://dom.spec.whatwg.org/#concept-range-start"
                                            id="ref-for-concept-range-start④">start</a> を <a data-link-type="dfn"
                                            href="#next-non-whitespace-position"
                                            id="ref-for-next-non-whitespace-position">次の非空白位置</a>へ進める。
                                    </p>
                                <li data-md>
                                    <p><var>matchRange</var> が<a data-link-type="dfn"
                                            href="https://dom.spec.whatwg.org/#range-collapsed"
                                            id="ref-for-range-collapsed①">collapsed</a> なら null を返す。</p>
                                    <div class="note" role="note"> この場合、<var>prefixMatch</var> の<a data-link-type="dfn"
                                            href="https://dom.spec.whatwg.org/#concept-range-end"
                                            id="ref-for-concept-range-end④">end</a> 、またはその後の非空白場所がドキュメント末尾にあるときに発生します。
                                    </div>
                                <li data-md>
                                    <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#assert"
                                            id="ref-for-assert③">Assert</a>: <var>matchRange</var> の<a
                                            data-link-type="dfn"
                                            href="https://dom.spec.whatwg.org/#concept-range-start-node"
                                            id="ref-for-concept-range-start-node②">start node</a> は <code
                                            class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#text" id="ref-for-text">Text</a></code>
                                        ノード。</p>
                                    <div class="note" role="note"> <var>matchRange</var> の <a data-link-type="dfn"
                                            href="https://dom.spec.whatwg.org/#concept-range-start"
                                            id="ref-for-concept-range-start⑤">start</a> は一致したprefixに続く次の非空白文字位置。</div>
                                <li data-md>
                                    <p><var>mustEndAtWordBoundary</var> を、<var>parsedValues</var> の<a
                                            data-link-type="dfn" href="#text-directive-end"
                                            id="ref-for-text-directive-end⑥">end</a> が null でなければ true、<a
                                            data-link-type="dfn" href="#text-directive-suffix"
                                            id="ref-for-text-directive-suffix③">suffix</a>が null なら true、そうでなければfalse。
                                    </p>
                                <li data-md>
                                    <p><var>potentialMatch</var> に <a data-link-type="dfn"
                                            href="#find-a-string-in-range"
                                            id="ref-for-find-a-string-in-range①">範囲内文字列検索</a>を (
                                        <var>parsedValues</var> の<a data-link-type="dfn" href="#text-directive-start"
                                            id="ref-for-text-directive-start⑥">start</a>, <var>matchRange</var>, false,
                                        <var>mustEndAtWordBoundary</var>)で実行した結果をセット
                                    </p>
                                <li data-md>
                                    <p><var>potentialMatch</var> が null なら null を返す。</p>
                                <li data-md>
                                    <p><var>potentialMatch</var> の<a data-link-type="dfn"
                                            href="https://dom.spec.whatwg.org/#concept-range-start"
                                            id="ref-for-concept-range-start⑥">start</a> が <var>matchRange</var>の
                                        <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-start"
                                            id="ref-for-concept-range-start⑦">start</a> でなければ、<a data-link-type="dfn"
                                            href="https://infra.spec.whatwg.org/#iteration-continue"
                                            id="ref-for-iteration-continue①">次のループ</a> を続ける。
                                    </p>
                                    <div class="note" role="note">
                                        この場合、一致するprefixは見つかりましたが、それに続くテキストが一致せず、ループを継続して次のprefix出現箇所を探します。</div>
                            </ol>
                        <li data-md>
                            <p>そうでなければ：</p>
                            <ol>
                                <li data-md>
                                    <p><var>mustEndAtWordBoundary</var> を <var>parsedValues</var> の<a
                                            data-link-type="dfn" href="#text-directive-end"
                                            id="ref-for-text-directive-end⑦">end</a> が null でなければ true、<a
                                            data-link-type="dfn" href="#text-directive-suffix"
                                            id="ref-for-text-directive-suffix④">suffix</a>が null なら true、それ以外はfalse。</p>
                                <li data-md>
                                    <p><var>potentialMatch</var> に <a data-link-type="dfn"
                                            href="#find-a-string-in-range"
                                            id="ref-for-find-a-string-in-range②">範囲内文字列検索</a>(<var>parsedValues</var>
                                        の<a data-link-type="dfn" href="#text-directive-start"
                                            id="ref-for-text-directive-start⑦">start</a>, <var>searchRange</var>, true,
                                        <var>mustEndAtWordBoundary</var>)の結果をセット
                                    </p>
                                <li data-md>
                                    <p><var>potentialMatch</var> がnullならnullを返す。</p>
                                <li data-md>
                                    <p><var>searchRange</var> の<a data-link-type="dfn"
                                            href="https://dom.spec.whatwg.org/#concept-range-start"
                                            id="ref-for-concept-range-start⑧">start</a> を <var>potentialMatch</var> の
                                        <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-start"
                                            id="ref-for-concept-range-start⑨">start</a> の直後へ
                                    </p>
                            </ol>
                        <li data-md>
                            <p><var>rangeEndSearchRange</var> を <a data-link-type="dfn"
                                    href="https://dom.spec.whatwg.org/#concept-range"
                                    id="ref-for-concept-range②②">Range</a>（開始：<var>potentialMatch</var>の<a
                                    data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-end"
                                    id="ref-for-concept-range-end⑤">end</a>、終了：<var>searchRange</var> の<a
                                    data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-end"
                                    id="ref-for-concept-range-end⑥">end</a>）とする。</p>
                        <li data-md>
                            <p><var>rangeEndSearchRange</var> が<a data-link-type="dfn"
                                    href="https://dom.spec.whatwg.org/#range-collapsed"
                                    id="ref-for-range-collapsed②">collapsed</a>でないかぎり：</p>
                            <ol>
                                <li data-md>
                                    <p><var>parsedValues</var> の<a data-link-type="dfn" href="#text-directive-end"
                                            id="ref-for-text-directive-end⑧">end</a>がnullでなければ、</p>
                                    <ol>
                                        <li data-md>
                                            <p><var>mustEndAtWordBoundary</var> を <var>parsedValues</var> の<a
                                                    data-link-type="dfn" href="#text-directive-suffix"
                                                    id="ref-for-text-directive-suffix⑤">suffix</a>が null なら
                                                true、そうでなければfalse。
                                            </p>
                                        <li data-md>
                                            <p><var>endMatch</var> を
                                                <a data-link-type="dfn" href="#find-a-string-in-range"
                                                    id="ref-for-find-a-string-in-range③">範囲内文字列検索</a>(
                                                <var>parsedValues</var> の<a data-link-type="dfn"
                                                    href="#text-directive-end" id="ref-for-text-directive-end⑨">end</a>,
                                                <var>rangeEndSearchRange</var>, true, <var>mustEndAtWordBoundary</var>
                                                ) の結果とする。
                                            </p>
                                        <li data-md>
                                            <p><var>endMatch</var> が null なら null を返す。</p>
                                        <li data-md>
                                            <p><var>potentialMatch</var> の<a data-link-type="dfn"
                                                    href="https://dom.spec.whatwg.org/#concept-range-end"
                                                    id="ref-for-concept-range-end⑧">end</a> を <var>endMatch</var> の<a
                                                    data-link-type="dfn"
                                                    href="https://dom.spec.whatwg.org/#concept-range-end"
                                                    id="ref-for-concept-range-end⑨">end</a> にセット。</p>
                                    </ol>
                                <li data-md>
                                    <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#assert"
                                            id="ref-for-assert④">Assert</a>:
                                        <var>potentialMatch</var>は非nullでcollapsedした範囲でなく、一致するテキスト範囲を表す。
                                    </p>
                                <li data-md>
                                    <p><var>parsedValues</var> の<a data-link-type="dfn" href="#text-directive-suffix"
                                            id="ref-for-text-directive-suffix⑥">suffix</a>
                                        がnullなら、<var>potentialMatch</var> を返す。</p>
                                <li data-md>
                                    <p><var>suffixRange</var> を <a data-link-type="dfn"
                                            href="https://dom.spec.whatwg.org/#concept-range"
                                            id="ref-for-concept-range②③">Range</a> (開始:<var>potentialMatch</var> の <a
                                            data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-end"
                                            id="ref-for-concept-range-end①⓪">end</a> 、終了：<var>searchRange</var>の
                                        <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-end"
                                            id="ref-for-concept-range-end①①">end</a>)とする。
                                    </p>
                                <li data-md>
                                    <p><var>suffixRange</var> の<a data-link-type="dfn"
                                            href="https://dom.spec.whatwg.org/#concept-range-start"
                                            id="ref-for-concept-range-start①②">start</a> を<a data-link-type="dfn"
                                            href="#next-non-whitespace-position"
                                            id="ref-for-next-non-whitespace-position①">次の非空白位置</a> に進める。</p>
                                <li data-md>
                                    <p><var>suffixMatch</var> を <a data-link-type="dfn" href="#find-a-string-in-range"
                                            id="ref-for-find-a-string-in-range④">範囲内文字列検索</a>(
                                        <var>parsedValues</var> の<a data-link-type="dfn" href="#text-directive-suffix"
                                            id="ref-for-text-directive-suffix⑦">suffix</a>, <var>suffixRange</var>,
                                        false, true) の結果
                                    </p>
                                <li data-md>
                                    <p><var>suffixMatch</var> が null なら null を返す。</p>
                                    <div class="note" role="note"> suffixが文書残りテキストに現れない場合、一致できない。 </div>
                                <li data-md>
                                    <p><var>suffixMatch</var> の<a data-link-type="dfn"
                                            href="https://dom.spec.whatwg.org/#concept-range-start"
                                            id="ref-for-concept-range-start①③">start</a> が <var>suffixRange</var> の <a
                                            data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-start"
                                            id="ref-for-concept-range-start①④">start</a> なら <var>potentialMatch</var>
                                        を返す。</p>
                                <li data-md>
                                    <p><var>parsedValues</var> の<a data-link-type="dfn" href="#text-directive-end"
                                            id="ref-for-text-directive-end①⓪">end</a>がnullなら <a data-link-type="dfn"
                                            href="https://infra.spec.whatwg.org/#iteration-break"
                                            id="ref-for-iteration-break">break</a>；</p>
                                    <div class="note" role="note">
                                        これは一致がexactでsuffixが一致しなければ、ループを抜けて次の範囲検索に進む。範囲一致の場合はinner loopを続行。</div>
                                <li data-md>
                                    <p><var>rangeEndSearchRange</var> の<a data-link-type="dfn"
                                            href="https://dom.spec.whatwg.org/#concept-range-start"
                                            id="ref-for-concept-range-start①⑤">start</a> を <var>potentialMatch</var> の
                                        <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-end"
                                            id="ref-for-concept-range-end①③">end</a>
                                    </p>
                                    <div class="note" role="note"> この場合、正しいrange startはみつかったがrange end が一致しない場合で、inner
                                        loop を継続する。</div>
                            </ol>
                        <li data-md>
                            <p><var>rangeEndSearchRange</var> が<a data-link-type="dfn"
                                    href="https://dom.spec.whatwg.org/#range-collapsed"
                                    id="ref-for-range-collapsed④">collapsed</a>なら：</p>
                            <ol>
                                <li data-md>
                                    <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#assert"
                                            id="ref-for-assert⑤">Assert</a>: <var>parsedValues</var>の<a
                                            data-link-type="dfn" href="#text-directive-end"
                                            id="ref-for-text-directive-end①①">end</a> がnullでない</p>
                                <li data-md>
                                    <p>null を返す</p>
                                    <div class="note" role="note"> これはexact一致のbreakによるものを除き、rangeEnd+suffixが見つからなかった場合。
                                    </div>
                            </ol>
                    </ol>
                <li data-md>
                    <p>null を返す</p>
            </ol>
        </div>
        <details class="wpt-tests-block" dir="ltr" lang="ja" open>
            <summary>テスト</summary>
            <ul class="wpt-tests-list">
                <li class="wpt-test"><a class="wpt-name"
                        href="https://wpt.fyi/results/scroll-to-text-fragment/find-range-from-text-directive.html"
                        title="scroll-to-text-fragment/find-range-from-text-directive.html">find-range-from-text-directive.html</a>
                    <a class="wpt-live"
                        href="http://wpt.live/scroll-to-text-fragment/find-range-from-text-directive.html"><small>（ライブテスト）</small></a>
                    <a class="wpt-source"
                        href="https://github.com/web-platform-tests/wpt/blob/master/scroll-to-text-fragment/find-range-from-text-directive.html"><small>（ソース）</small></a>
            </ul>
        </details>
        <div class="algorithm" data-algorithm="advance range start to next non-whitespace position">
            <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range"
                id="ref-for-concept-range②④">range</a> <var>range</var> の <a data-link-type="dfn"
                href="https://dom.spec.whatwg.org/#concept-range-start" id="ref-for-concept-range-start①⑥">開始位置</a> を
            <dfn class="dfn-paneled" data-dfn-type="dfn" data-lt="next non-whitespace position" data-noexport
                id="next-non-whitespace-position">次の非空白位置</dfn>へ進めるには、以下の手順に従う：
            <ol class="algorithm">
                <li data-md>
                    <p><var>range</var> が collapsed（折りたたまれていない）間：</p>
                    <ol>
                        <li data-md>
                            <p><var>node</var> を <var>range</var> の <a data-link-type="dfn"
                                    href="https://dom.spec.whatwg.org/#concept-range-start-node"
                                    id="ref-for-concept-range-start-node③">開始ノード</a>とする。</p>
                        <li data-md>
                            <p><var>offset</var> を <var>range</var> の <a data-link-type="dfn"
                                    href="https://dom.spec.whatwg.org/#concept-range-start-offset"
                                    id="ref-for-concept-range-start-offset">開始オフセット</a>とする。</p>
                        <li data-md>
                            <p><var>node</var> が <a data-link-type="dfn" href="#non-searchable-subtree"
                                    id="ref-for-non-searchable-subtree">検索不可部分木</a>の一部である、または <var>node</var>
                                が <a data-link-type="dfn" href="#visible-text-node"
                                    id="ref-for-visible-text-node">可視テキストノード</a> でない、または <var>offset</var> が
                                <var>node</var> の <a data-link-type="dfn"
                                    href="https://dom.spec.whatwg.org/#concept-node-length"
                                    id="ref-for-concept-node-length①">長さ</a>と等しければ：
                            </p>
                            <ol>
                                <li data-md>
                                    <p><var>range</var> の <a data-link-type="dfn"
                                            href="https://dom.spec.whatwg.org/#concept-range-start-node"
                                            id="ref-for-concept-range-start-node④">開始ノード</a> を <a data-link-type="dfn"
                                            href="https://dom.spec.whatwg.org/#concept-shadow-including-tree-order"
                                            id="ref-for-concept-shadow-including-tree-order">shadow-including
                                            tree順</a>で次のノードに設定する。
                                    </p>
                                <li data-md>
                                    <p><var>range</var> の <a data-link-type="dfn"
                                            href="https://dom.spec.whatwg.org/#concept-range-start-offset"
                                            id="ref-for-concept-range-start-offset①">開始オフセット</a> を 0 に設定する。</p>
                                <li data-md>
                                    <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#iteration-continue"
                                            id="ref-for-iteration-continue②">続ける</a>。</p>
                            </ol>
                        <li data-md>
                            <p><var>node</var> の <a data-link-type="dfn"
                                    href="https://dom.spec.whatwg.org/#concept-cd-substring"
                                    id="ref-for-concept-cd-substring">部分文字列データ</a>のオフセット <var>offset</var> から 6 文字分が文字列
                                "&amp;nbsp;" に等しければ：</p>
                            <ol>
                                <li data-md>
                                    <p><var>range</var> の <a data-link-type="dfn"
                                            href="https://dom.spec.whatwg.org/#concept-range-start-offset"
                                            id="ref-for-concept-range-start-offset②">開始オフセット</a> に6を加算。</p>
                            </ol>
                        <li data-md>
                            <p>その他の場合、<a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-cd-substring"
                                    id="ref-for-concept-cd-substring①">部分文字列データ</a>のオフセット <var>offset</var> から5文字分が文字列
                                "&amp;nbsp" に等しければ：</p>
                            <ol>
                                <li data-md>
                                    <p><var>range</var> の <a data-link-type="dfn"
                                            href="https://dom.spec.whatwg.org/#concept-range-start-offset"
                                            id="ref-for-concept-range-start-offset③">開始オフセット</a> に5を加算。</p>
                            </ol>
                        <li data-md>
                            <p>それ以外の場合：</p>
                            <ol>
                                <li data-md>
                                    <p><var>cp</var> を、<a data-link-type="dfn"
                                            href="https://infra.spec.whatwg.org/#code-point"
                                            id="ref-for-code-point">コードポイント</a>として、<var>node</var> の <a
                                            data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-cd-data"
                                            id="ref-for-concept-cd-data">データ</a>の <var>offset</var> 番目とする。
                                    </p>
                                <li data-md>
                                    <p><var>cp</var> が <a
                                            href="http://www.unicode.org/reports/tr44/#White_Space">空白属性</a>を持たない場合、処理を終了する。
                                    </p>
                                <li data-md>
                                    <p><var>range</var> の <a data-link-type="dfn"
                                            href="https://dom.spec.whatwg.org/#concept-range-start-offset"
                                            id="ref-for-concept-range-start-offset④">開始オフセット</a> に1を加算。</p>
                            </ol>
                    </ol>
            </ol>
        </div>
        <div class="algorithm" data-algorithm="find a string in a range">
            <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="find-a-string-in-range">範囲内で文字列を検索</dfn>には、<a
                data-link-type="dfn" href="https://infra.spec.whatwg.org/#string" id="ref-for-string⑤">文字列</a>
            <var>query</var>、<a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range"
                id="ref-for-concept-range②⑤">範囲</a>
            <var>searchRange</var>、およびブール値 <var>wordStartBounded</var>、<var>wordEndBounded</var> を指定し、次の手順を実行：
            <div class="note" role="note"> このアルゴリズムは <var>query</var> テキストの最初の出現を <var>searchRange</var> 内で完全に含む <a
                    data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range"
                    id="ref-for-concept-range②⑥">範囲</a> を返します。単語区切り（<a href="#word-boundaries">§ 3.6.2 Word
                    Boundaries</a>参照）で開始または終了位置を制限することもできます。一致がなければnullを返します。 </div>
            <div class="note" role="note">
                <p> このアルゴリズムの基本は、ブロック内の検索可能な全テキストノードをリストに収集し、それらを連結して検索し、ノードリストでオフセットを解釈して戻り値の範囲を作ること。</p>
                <p> ブロックノードに到達するとリスト化を中断。例：</p>
                <pre>&lt;div>
  a&lt;em>b&lt;/em>c&lt;div>d&lt;/div>e
&lt;/div>
</pre>
                <p></p>
                <p>この場合は"abc"・"d"・"e"と分割して検索。</p>
                <p>よって <var>query</var> は、ブロックレベルのコンテナ内で途切れのない連続したテキストのみに一致する。</p>
            </div>
            <ol class="algorithm">
                <li data-md>
                    <p><var>searchRange</var> が <a data-link-type="dfn"
                            href="https://dom.spec.whatwg.org/#range-collapsed"
                            id="ref-for-range-collapsed⑤">collapsed</a> でない間：</p>
                    <ol>
                        <li data-md>
                            <p><var>curNode</var> を <var>searchRange</var> の <a data-link-type="dfn"
                                    href="https://dom.spec.whatwg.org/#concept-range-start-node"
                                    id="ref-for-concept-range-start-node⑤">開始ノード</a> とする。</p>
                        <li data-md>
                            <p><var>curNode</var> が <a data-link-type="dfn" href="#non-searchable-subtree"
                                    id="ref-for-non-searchable-subtree①">検索不可部分木</a>であれば：</p>
                            <ol>
                                <li data-md>
                                    <p><var>searchRange</var> の <a data-link-type="dfn"
                                            href="https://dom.spec.whatwg.org/#concept-range-start-node"
                                            id="ref-for-concept-range-start-node⑥">開始ノード</a> を、shadow-including tree順で
                                        <var>curNode</var> の <a data-link-type="dfn"
                                            href="https://dom.spec.whatwg.org/#concept-shadow-including-descendant"
                                            id="ref-for-concept-shadow-including-descendant">shadow-including
                                            descendant</a> でない次のノードに設定。
                                    </p>
                                <li data-md>
                                    <p><var>searchRange</var> の <a data-link-type="dfn"
                                            href="https://dom.spec.whatwg.org/#concept-range-start-offset"
                                            id="ref-for-concept-range-start-offset⑤">開始オフセット</a> を 0 に設定。</p>
                                <li data-md>
                                    <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#iteration-continue"
                                            id="ref-for-iteration-continue③">続ける</a>。</p>
                            </ol>
                        <li data-md>
                            <p><var>curNode</var> が <a data-link-type="dfn" href="#visible-text-node"
                                    id="ref-for-visible-text-node①">可視テキストノード</a> でなければ：</p>
                            <ol>
                                <li data-md>
                                    <p><var>searchRange</var> の <a data-link-type="dfn"
                                            href="https://dom.spec.whatwg.org/#concept-range-start-node"
                                            id="ref-for-concept-range-start-node⑦">開始ノード</a> を <a data-link-type="dfn"
                                            href="https://dom.spec.whatwg.org/#concept-shadow-including-tree-order"
                                            id="ref-for-concept-shadow-including-tree-order②">shadow-including
                                            tree順</a>で次の <a data-link-type="dfn"
                                            href="https://dom.spec.whatwg.org/#concept-doctype"
                                            id="ref-for-concept-doctype">doctype</a> でないノードに設定する。
                                    </p>
                                <li data-md>
                                    <p><var>searchRange</var> の <a data-link-type="dfn"
                                            href="https://dom.spec.whatwg.org/#concept-range-start-offset"
                                            id="ref-for-concept-range-start-offset⑥">開始オフセット</a> を 0 に設定。</p>
                                <li data-md>
                                    <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#iteration-continue"
                                            id="ref-for-iteration-continue④">続ける</a>。</p>
                            </ol>
                        <li data-md>
                            <p><var>blockAncestor</var> を <a data-link-type="dfn" href="#nearest-block-ancestor"
                                    id="ref-for-nearest-block-ancestor">直近のブロック祖先</a> とする。</p>
                        <li data-md>
                            <p><var>textNodeList</var> を <a data-link-type="dfn"
                                    href="https://infra.spec.whatwg.org/#list" id="ref-for-list⑧">リスト</a>（初期値は空）の <code
                                    class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#text" id="ref-for-text①">Text</a></code>
                                ノードとする。
                            </p>
                        <li data-md>
                            <p><var>curNode</var> が <a data-link-type="dfn"
                                    href="https://dom.spec.whatwg.org/#concept-shadow-including-descendant"
                                    id="ref-for-concept-shadow-including-descendant①">shadow-including descendant</a> かつ
                                <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-bp"
                                    id="ref-for-concept-range-bp②">境界点</a> (<var>curNode</var>, 0) が <a
                                    data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-bp-after"
                                    id="ref-for-concept-range-bp-after②">searchRangeの終了より後</a>でない間：
                            </p>
                            <ol>
                                <li data-md>
                                    <p><var>curNode</var> が <a data-link-type="dfn" href="#has-block-level-display"
                                            id="ref-for-has-block-level-display">ブロックレベル表示を持つ</a>場合、<a
                                            data-link-type="dfn" href="https://infra.spec.whatwg.org/#iteration-break"
                                            id="ref-for-iteration-break②">break</a>。</p>
                                <li data-md>
                                    <p><var>curNode</var> が <a data-link-type="dfn" href="#search-invisible"
                                            id="ref-for-search-invisible">検索不可</a>であれば：</p>
                                    <ol>
                                        <li data-md>
                                            <p><var>curNode</var> を、shadow-including tree順で <var>curNode</var> の <a
                                                    data-link-type="dfn"
                                                    href="https://dom.spec.whatwg.org/#concept-shadow-including-descendant"
                                                    id="ref-for-concept-shadow-including-descendant②">shadow-including
                                                    descendant</a> でない次のノードに設定。</p>
                                        <li data-md>
                                            <p><a data-link-type="dfn"
                                                    href="https://infra.spec.whatwg.org/#iteration-continue"
                                                    id="ref-for-iteration-continue⑤">続ける</a>。</p>
                                    </ol>
                                <li data-md>
                                    <p><var>curNode</var> が <a data-link-type="dfn" href="#visible-text-node"
                                            id="ref-for-visible-text-node②">可視テキストノード</a> であれば <var>textNodeList</var>
                                        に追加。</p>
                                <li data-md>
                                    <p><var>curNode</var> をshadow-including tree順で次のノードに更新。</p>
                            </ol>
                        <li data-md>
                            <p><a data-link-type="dfn" href="#find-a-range-from-a-node-list"
                                    id="ref-for-find-a-range-from-a-node-list">ノードリストから範囲を得る</a> を引数 <var>query</var>,
                                <var>searchRange</var>, <var>textNodeList</var>, <var>wordStartBounded</var>,
                                <var>wordEndBounded</var> で実行し、結果が非nullならそれを返す。
                            </p>
                        <li data-md>
                            <p><var>curNode</var> が null なら <a data-link-type="dfn"
                                    href="https://infra.spec.whatwg.org/#iteration-break"
                                    id="ref-for-iteration-break③">break</a>。</p>
                        <li data-md>
                            <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#assert"
                                    id="ref-for-assert⑥">Assert</a>: <var>curNode</var> は <a data-link-type="dfn"
                                    href="https://dom.spec.whatwg.org/#concept-tree-following"
                                    id="ref-for-concept-tree-following">searchRangeの開始ノードに続く</a>ノードである。</p>
                        <li data-md>
                            <p><var>searchRange</var> の <a data-link-type="dfn"
                                    href="https://dom.spec.whatwg.org/#concept-range-start"
                                    id="ref-for-concept-range-start①⑦">start</a> を (<var>curNode</var>, 0) に設定。</p>
                    </ol>
                <li data-md>
                    <p>null を返す。</p>
            </ol>
        </div>
        <p>ノードは、<a data-link-type="dfn" data-noexport id="search-invisible">検索不可</a> である条件：
            <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-element"
                id="ref-for-concept-element③">要素</a>であり、<a data-link-type="dfn"
                href="https://infra.spec.whatwg.org/#html-namespace"
                id="ref-for-html-namespace">HTML名前空間</a>内にあり、以下いずれかを満たすとき：
        </p>
        <ol>
            <li data-md>
                <p><a data-link-type="dfn" href="https://drafts.csswg.org/css-cascade-5/#computed-value"
                        id="ref-for-computed-value">computed value</a>（算出値）の <a class="property css"
                        data-link-type="property" href="https://drafts.csswg.org/css-display-4/#propdef-display"
                        id="ref-for-propdef-display">display</a> プロパティが <a class="css" data-link-type="maybe"
                        href="https://drafts.csswg.org/css-display-4/#valdef-display-none"
                        id="ref-for-valdef-display-none">none</a> である。</p>
            <li data-md>
                <p>そのノードが <a data-link-type="dfn"
                        href="https://html.spec.whatwg.org/multipage/parsing.html#serializes-as-void"
                        id="ref-for-serializes-as-void">voidとしてシリアライズされる</a>とき。</p>
            <li data-md>
                <p>次の型のいずれかである場合：<code
                        class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/iframe-embed-object.html#htmliframeelement" id="ref-for-htmliframeelement">HTMLIFrameElement</a></code>、
                    <code
                        class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/embedded-content.html#htmlimageelement" id="ref-for-htmlimageelement">HTMLImageElement</a></code>、
                    <code
                        class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/form-elements.html#htmlmeterelement" id="ref-for-htmlmeterelement">HTMLMeterElement</a></code>、
                    <code
                        class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/iframe-embed-object.html#htmlobjectelement" id="ref-for-htmlobjectelement">HTMLObjectElement</a></code>、
                    <code
                        class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/form-elements.html#htmlprogresselement" id="ref-for-htmlprogresselement">HTMLProgressElement</a></code>、
                    <code
                        class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/semantics.html#htmlstyleelement" id="ref-for-htmlstyleelement">HTMLStyleElement</a></code>、
                    <code
                        class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/scripting.html#htmlscriptelement" id="ref-for-htmlscriptelement">HTMLScriptElement</a></code>、
                    <code
                        class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/media.html#htmlvideoelement" id="ref-for-htmlvideoelement">HTMLVideoElement</a></code>、
                    <code
                        class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/media.html#htmlaudioelement" id="ref-for-htmlaudioelement">HTMLAudioElement</a></code>
                </p>
            <li data-md>
                <p>
                    <code><a data-link-type="element" href="https://html.spec.whatwg.org/multipage/form-elements.html#the-select-element" id="ref-for-the-select-element">select</a></code>
                    要素で
                    <code><a data-link-type="element-sub" href="https://html.spec.whatwg.org/multipage/form-elements.html#attr-select-multiple" id="ref-for-attr-select-multiple">multiple</a></code>
                    属性がない場合
                </p>
        </ol>
        <p>ノードが <a class="dfn-paneled" data-dfn-type="dfn" data-noexport id="non-searchable-subtree">検索不可部分木</a>
            の一部となる条件は、自身または <a data-link-type="dfn"
                href="https://dom.spec.whatwg.org/#concept-shadow-including-ancestor"
                id="ref-for-concept-shadow-including-ancestor">shadow-including ancestor</a> が <a data-link-type="dfn"
                href="#search-invisible" id="ref-for-search-invisible①">検索不可</a> である場合です。</p>
        <p>ノードが <a class="dfn-paneled" data-dfn-type="dfn" data-noexport id="visible-text-node">可視テキストノード</a>
            と判定される条件は、<code
                class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#text" id="ref-for-text②">Text</a></code>
            ノードであり、親要素の<a data-link-type="dfn" href="https://drafts.csswg.org/css-cascade-5/#computed-value"
                id="ref-for-computed-value①">算出値</a>による<a data-link-type="dfn"
                href="https://dom.spec.whatwg.org/#parent-element" id="ref-for-parent-element">親要素</a>の <a
                class="property css" data-link-type="property"
                href="https://drafts.csswg.org/css-display-4/#propdef-visibility"
                id="ref-for-propdef-visibility">visibility</a> プロパティが <a class="css" data-link-type="maybe"
                href="https://drafts.csswg.org/css-display-4/#valdef-visibility-visible"
                id="ref-for-valdef-visibility-visible">visible</a> であり、<a data-link-type="dfn"
                href="https://html.spec.whatwg.org/multipage/rendering.html#being-rendered"
                id="ref-for-being-rendered">描画されている</a>ことです。</p>
        <p>ノードが<a class="dfn-paneled" data-dfn-type="dfn" data-noexport id="has-block-level-display">ブロックレベル表示を持つ</a>とは、
            <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-element"
                id="ref-for-concept-element④">要素</a>であり、
            <a data-link-type="dfn" href="https://drafts.csswg.org/css-cascade-5/#computed-value"
                id="ref-for-computed-value②">算出値</a>による <a class="property css" data-link-type="property"
                href="https://drafts.csswg.org/css-display-4/#propdef-display" id="ref-for-propdef-display①">display</a>
            プロパティが <a class="css" data-link-type="maybe"
                href="https://drafts.csswg.org/css-display-4/#valdef-display-block"
                id="ref-for-valdef-display-block">block</a>、<a class="css" data-link-type="maybe"
                href="https://drafts.csswg.org/css-display-4/#valdef-display-table"
                id="ref-for-valdef-display-table">table</a>、<a class="css" data-link-type="maybe"
                href="https://drafts.csswg.org/css-display-4/#valdef-display-flow-root"
                id="ref-for-valdef-display-flow-root">flow-root</a>、<a class="css" data-link-type="maybe"
                href="https://drafts.csswg.org/css-display-3/#valdef-display-grid"
                id="ref-for-valdef-display-grid">grid</a>、<a class="css" data-link-type="maybe"
                href="https://drafts.csswg.org/css-display-3/#valdef-display-flex"
                id="ref-for-valdef-display-flex">flex</a>、<a class="css" data-link-type="maybe"
                href="https://drafts.csswg.org/css-display-4/#valdef-display-list-item"
                id="ref-for-valdef-display-list-item">list-item</a> のいずれかであることです。
        </p>
        <div class="algorithm" data-algorithm="nearest block ancestor">
            <var>node</var> の<a class="dfn-paneled" data-dfn-type="dfn" data-noexport
                id="nearest-block-ancestor">直近のブロック祖先</a>を求めるには、次の手順：
            <ol class="algorithm">
                <li data-md>
                    <p><var>curNode</var> を <var>node</var> にする。</p>
                <li data-md>
                    <p><var>curNode</var> が null でない間：</p>
                    <ol>
                        <li data-md>
                            <p><var>curNode</var> が <code
                                    class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#text" id="ref-for-text③">Text</a></code>
                                ノードでなく、かつ <a data-link-type="dfn" href="#has-block-level-display"
                                    id="ref-for-has-block-level-display①">ブロックレベル表示を持つ</a>場合は <var>curNode</var> を返す。
                            </p>
                        <li data-md>
                            <p>それ以外は <var>curNode</var> を親ノードに更新。</p>
                    </ol>
                <li data-md>
                    <p><var>node</var> の <a data-link-type="dfn"
                            href="https://dom.spec.whatwg.org/#concept-node-document"
                            id="ref-for-concept-node-document">ノードドキュメント</a>の <a data-link-type="dfn"
                            href="https://dom.spec.whatwg.org/#document-element"
                            id="ref-for-document-element">ドキュメント要素</a> を返す。</p>
            </ol>
        </div>
        <div class="algorithm" data-algorithm="range from node list">
            <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport
                id="find-a-range-from-a-node-list">ノードリストから範囲を得る</dfn>には、検索文字列 <var>queryString</var>、
            <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range"
                id="ref-for-concept-range②⑨">範囲</a> <var>searchRange</var>、<a data-link-type="dfn"
                href="https://infra.spec.whatwg.org/#list" id="ref-for-list⑨">Textノードリスト</a> <var>nodes</var>、
            ブール値 <var>wordStartBounded</var> および <var>wordEndBounded</var> を使い次の手順に従う：
            <div class="note" role="note">
                オプションで、条件一致したテキストが<a data-link-type="dfn" href="#word-boundary"
                    id="ref-for-word-boundary">単語境界</a>で始まる／終わる場合のみ返せます。
                例：
                <div class="example" id="example-27ab4025">
                    <a class="self-link" href="#example-27ab4025"></a> “range”は “mountain range” には必ず一致、
                    <ol>
                        <li data-md>
                            <p>単語開始境界必須なら “color orange” には一致しません。</p>
                        <li data-md>
                            <p>単語終了境界必須なら “forest ranger” には一致しません。</p>
                    </ol>
                </div>
                <p>詳細・他例は <a href="#word-boundaries">§ 3.6.2 Word Boundaries</a> を参照。</p>
            </div>
            <ol class="algorithm">
                <li data-md>
                    <p><var>searchBuffer</var> を <var>nodes</var> 内各要素の <a data-link-type="dfn"
                            href="https://dom.spec.whatwg.org/#concept-cd-data" id="ref-for-concept-cd-data①">データ</a> を
                        <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#string-concatenate"
                            id="ref-for-string-concatenate">連結</a> して作る。
                    </p>
                    <p class="issue" id="issue-96fe4755"><a class="self-link" href="#issue-96fe4755"></a> <a
                            data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-cd-data"
                            id="ref-for-concept-cd-data②">データ</a>はこの文脈では正確でなく、DOM上のテキストデータなので注意。本来は描画済みテキストを対象にし、その後DOMに戻す必要あり。<a
                            href="https://github.com/WICG/scroll-to-text-fragment/issues/98">[Issue
                            #WICG/scroll-to-text-fragment#98]</a></p>
                <li data-md>
                    <p><var>searchStart</var> を 0 に初期化。</p>
                <li data-md>
                    <p><var>nodes</var> の先頭が <var>searchRange</var> の <a data-link-type="dfn"
                            href="https://dom.spec.whatwg.org/#concept-range-start-node"
                            id="ref-for-concept-range-start-node⑨">開始ノード</a>なら
                        <var>searchStart</var> を <var>searchRange</var> の <a data-link-type="dfn"
                            href="https://dom.spec.whatwg.org/#concept-range-start-offset"
                            id="ref-for-concept-range-start-offset⑦">開始オフセット</a>に設定。
                    </p>
                <li data-md>
                    <p><var>start</var>/<var>end</var> を <a data-link-type="dfn"
                            href="https://dom.spec.whatwg.org/#concept-range-bp"
                            id="ref-for-concept-range-bp④">境界点</a>（null初期値）とする。</p>
                <li data-md>
                    <p><var>matchIndex</var> をnullに初期化。</p>
                <li data-md>
                    <p><var>matchIndex</var> がnullの間：</p>
                    <ol>
                        <li data-md>
                            <p><var>searchBuffer</var> で文字列 <var>queryString</var> の最初の出現インデックス <var>matchIndex</var> を
                                <var>searchStart</var> から探す。比較は <a
                                    href="http://www.unicode.org/reports/tr10/#Multi_Level_Comparison">第一水準</a>（大文字小文字・アクセント無視）で。
                            </p>
                            <div class="note" role="note"> 直感的には大文字小文字・濁点など無視の検索。</div>
                        <li data-md>
                            <p><var>matchIndex</var> がnullなら null を返す。</p>
                        <li data-md>
                            <p><var>endIx</var> を <var>matchIndex</var> ＋ <var>queryString</var> の <a
                                    data-link-type="dfn" href="https://infra.spec.whatwg.org/#string-length"
                                    id="ref-for-string-length">長さ</a>とする。</p>
                            <div class="note" role="note"> <var>endIx</var> は一致文字列の末尾＋1の位置。</div>
                        <li data-md>
                            <p><var>start</var> を <a data-link-type="dfn"
                                    href="https://dom.spec.whatwg.org/#concept-range-bp"
                                    id="ref-for-concept-range-bp⑤">境界点</a>として <a data-link-type="dfn"
                                    href="#get-boundary-point-at-index" id="ref-for-get-boundary-point-at-index">get
                                    boundary point at
                                    index</a> <var>matchIndex</var> を <var>nodes</var>、isEnd=false で実行した結果に。</p>
                        <li data-md>
                            <p><var>end</var> を <a data-link-type="dfn"
                                    href="https://dom.spec.whatwg.org/#concept-range-bp"
                                    id="ref-for-concept-range-bp⑥">境界点</a>として <a data-link-type="dfn"
                                    href="#get-boundary-point-at-index" id="ref-for-get-boundary-point-at-index①">get
                                    boundary point at
                                    index</a> <var>endIx</var> を <var>nodes</var>、isEnd=true で実行した結果に。</p>
                        <li data-md>
                            <p><var>wordStartBounded</var> が true かつ <var>matchIndex</var> が <a data-link-type="dfn"
                                    href="#is-at-a-word-boundary" id="ref-for-is-at-a-word-boundary">単語境界でない</a>場合、または
                                <var>wordEndBounded</var> が true かつ <var>matchIndex</var>＋<var>queryString</var> の長さが <a
                                    data-link-type="dfn" href="#is-at-a-word-boundary"
                                    id="ref-for-is-at-a-word-boundary①">単語境界でない</a>場合：
                            </p>
                            <ol>
                                <li data-md>
                                    <p><var>searchStart</var> を <var>matchIndex</var>＋1に。</p>
                                <li data-md>
                                    <p><var>matchIndex</var> を nullに。</p>
                            </ol>
                    </ol>
                <li data-md>
                    <p><var>endInset</var> を0に初期化。</p>
                <li data-md>
                    <p><var>nodes</var> の末尾が <var>searchRange</var> の <a data-link-type="dfn"
                            href="https://dom.spec.whatwg.org/#concept-range-end-node"
                            id="ref-for-concept-range-end-node②">終了ノード</a>なら <var>endInset</var> を（
                        <var>searchRange</var> の <a data-link-type="dfn"
                            href="https://dom.spec.whatwg.org/#concept-range-end-node"
                            id="ref-for-concept-range-end-node③">終了ノード</a> の <a data-link-type="dfn"
                            href="https://dom.spec.whatwg.org/#concept-node-length"
                            id="ref-for-concept-node-length②">長さ</a> − <var>searchRange</var> の <a data-link-type="dfn"
                            href="https://dom.spec.whatwg.org/#concept-range-end-offset"
                            id="ref-for-concept-range-end-offset">終了オフセット</a> )に設定。
                    </p>
                    <div class="note" role="note"> <var>endInset</var>は最後のノードの逆方向のオフセット分。すなわち含まれない長さ。</div>
                <li data-md>
                    <p><var>matchIndex</var>＋<var>queryString</var> の <a data-link-type="dfn"
                            href="https://infra.spec.whatwg.org/#string-length" id="ref-for-string-length②">長さ</a> が
                        <var>searchBuffer</var> の長さ−<var>endInset</var> を超える場合、nullを返す。
                    </p>
                    <div class="note" role="note"> 範囲末尾をまたいだマッチは無効。</div>
                <li data-md>
                    <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#assert"
                            id="ref-for-assert⑦">Assert</a>: <var>start</var> と <var>end</var> は <var>searchRange</var>
                        内の非null・正当な <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-bp"
                            id="ref-for-concept-range-bp⑦">境界点</a> である。</p>
                <li data-md>
                    <p><a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range"
                            id="ref-for-concept-range③⓪">範囲</a>（開始：<a data-link-type="dfn"
                            href="https://dom.spec.whatwg.org/#concept-range-start"
                            id="ref-for-concept-range-start①⑧">start</a>、終了：<a data-link-type="dfn"
                            href="https://dom.spec.whatwg.org/#concept-range-end"
                            id="ref-for-concept-range-end①⑤">end</a>）を返す。</p>
            </ol>
        </div>
        <div class="algorithm" data-algorithm="boundary point at index">
            <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport
                id="get-boundary-point-at-index">インデックスから境界点を得る</dfn>には、整数 <var>index</var>、<a data-link-type="dfn"
                href="https://infra.spec.whatwg.org/#list" id="ref-for-list①⓪">Textノードリスト</a> <var>nodes</var>、ブール値
            <var>isEnd</var> を受け、次の手順：
            <div class="note" role="note">
                <p> これは上記アルゴリズムで、連結文字列上のインデックスがどのノードに所属するか確定するための補助ルーチンです。</p>
                <p> <var>isEnd</var>は始端と終端を区別のため利用。終端インデックスは一致文字列の「次の位置」を指す。マッチがノード境界上なら、次ノード頭ではなく、そのノード末としてほしい。</p>
            </div>
            <ol class="algorithm">
                <li data-md>
                    <p><var>counted</var> を0に初期化。</p>
                <li data-md>
                    <p><var>nodes</var> の各 <var>curNode</var> について：</p>
                    <ol>
                        <li data-md>
                            <p><var>nodeEnd</var> を (<var>counted</var>＋<var>curNode</var> の <a data-link-type="dfn"
                                    href="https://dom.spec.whatwg.org/#concept-node-length"
                                    id="ref-for-concept-node-length③">長さ</a>) とする。</p>
                        <li data-md>
                            <p><var>isEnd</var> が true なら <var>nodeEnd</var> に1加算。</p>
                        <li data-md>
                            <p><var>nodeEnd</var> ＞ <var>index</var> なら：</p>
                            <ol>
                                <li data-md>
                                    <p><a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-bp"
                                            id="ref-for-concept-range-bp⑧">境界点</a> (<var>curNode</var>,
                                        <var>index</var>−<var>counted</var>)を返す。
                                    </p>
                            </ol>
                        <li data-md>
                            <p><var>counted</var> に <var>curNode</var> の <a data-link-type="dfn"
                                    href="https://dom.spec.whatwg.org/#concept-node-length"
                                    id="ref-for-concept-node-length④">長さ</a> を加算。</p>
                    </ol>
                <li data-md>
                    <p>nullを返す。</p>
            </ol>
        </div>
        <h4 class="heading settled" data-level="3.6.2" id="word-boundaries"><span class="secno">3.6.2. </span><span
                class="content">単語境界</span><a class="self-link" href="#word-boundaries"></a></h4>
        <div class="note" role="note"> 単語境界への一致限定は、クロスオリジン情報漏洩を抑制するための対策の1つです。 </div>
        <div class="note" role="note"> <a
                href="https://github.com/tc39/proposal-intl-segmenter">Intl.Segmenter</a>（Unicodeセグメンテーション規定を提案するもの）を参照。単語セグメント化も含む。将来的に規定されれば、このアルゴリズムもIntl.Segmenter
            APIを活用して単語境界一致を改善できる。 </div>
        <p> <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="word-boundary">単語境界</dfn>は、<a
                data-link-type="biblio" href="#biblio-uax29" title="Unicode Text Segmentation">[UAX29]</a>および<a
                href="https://www.unicode.org/reports/tr29/tr29-43.html#Word_Boundaries">Unicode Text Segmentation
                § Word_Boundaries</a>で定義されます。<a
                href="https://www.unicode.org/reports/tr29/tr29-43.html#Default_Word_Boundaries">Unicode Text
                Segmentation § Default_Word_Boundaries</a>では
            デフォルトの単語境界規則セットを規定していますが、仕様でも述べている通り、より高度なアルゴリズムをロケールに応じて使うべきです。
        </p>
        <p> 辞書ベースの単語境界判定は、単語区切り文字のないロケールでは特に注意が必要です。英語ではスペース('
            ')で単語区切りですが、日本語には単語間を区切る文字がありません。そのような場合、かつアルファベットが100文字未満の場合、辞書には有効な1文字単語をアルファベットの20%以内に抑える必要があります。 </p>
        <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="locale">ロケール</dfn>とは、有効な<a
                data-link-type="dfn" href="https://infra.spec.whatwg.org/#string" id="ref-for-string⑥">文字列</a>（<a
                data-link-type="biblio" href="#biblio-bcp47"
                title="Tags for Identifying Languages">[BCP47]</a>言語タグ）または空文字列です。空文字列は主言語が不明であることを示します。</p>
        <p>部分文字列が<a class="dfn-paneled" data-dfn-type="dfn" data-noexport id="word-bounded">単語境界で区切られている</a>とは、<a
                data-link-type="dfn" href="https://infra.spec.whatwg.org/#string" id="ref-for-string⑦">文字列</a>
            <var>text</var>、<a data-link-type="dfn" href="#locale" id="ref-for-locale">ロケール</a> <var>startLocale</var> と
            <var>endLocale</var> が与えられたとき、その最初の文字の位置が <a data-link-type="dfn" href="#is-at-a-word-boundary"
                id="ref-for-is-at-a-word-boundary②">単語境界である</a>かつ、末尾（最後の文字の直後の位置）が <a data-link-type="dfn"
                href="#is-at-a-word-boundary" id="ref-for-is-at-a-word-boundary③">単語境界である</a>場合を指します。
        </p>
        <p>数値 <var>position</var> が <a class="dfn-paneled" data-dfn-type="dfn" data-noexport
                id="is-at-a-word-boundary">単語境界である</a>のは、<a data-link-type="dfn"
                href="https://infra.spec.whatwg.org/#string" id="ref-for-string⑧">文字列</a> <var>text</var>、および <a
                data-link-type="dfn" href="#locale" id="ref-for-locale①">ロケール</a> <var>locale</var>
            が与えられたとき、<var>locale</var>に従い <a data-link-type="dfn" href="#word-boundary"
                id="ref-for-word-boundary①">単語境界</a>が直前にある、または <var>text</var> の長さが0より大きく、<var>position</var>が0 または
            <var>text</var>長と等しい場合を指します。
        </p>
        <div class="note" role="note">
            直観的に、部分文字列が <a data-link-type="dfn" href="#word-bounded"
                id="ref-for-word-bounded">単語境界に区切られている</a>とは、その始端・終端とも単語の途中ではないということです。
            <p>区切り記号（例: 半角スペース）がある言語では（ほぼ）簡単ですが、技術資料で扱う改行・ハイフネーション・引用符等の詳細な規定があります。</p>
            <p>区切り記号のない言語（中・日・韓等）は辞書ベースで有効な単語を認識する必要があります。</p>
        </div>
        <div class="example" id="example-0a0acb46">
            <a class="self-link" href="#example-0a0acb46"></a>
            <p> テキストフラグメントの一致語句は、隣接する文脈語と連結したときに単語境界となるように制限されます。たとえば exact検索 <code>prefix,start,suffix</code>
                では、<code>"prefix+start+suffix"</code>全体が単語境界で区切られているときのみマッチします。一方range検索
                <code>prefix,start,end,suffix</code>
                では、<code>"prefix+start"</code>と<code>"end+suffix"</code>の両方が単語境界である必要があります。
            </p>
            <p> 目的は、第三者が一致トークンの全体を既知であるケースのみ閲覧できること。<code>start,end</code>のrangeマッチで内側が単語境界でなければ、第三者が繰り返し一致探索してトークン復元を試行（例：<code>"Balance: 123,456 $"</code>なら
                <code>prefix="Balance: ", end="$"</code> かつ <code>start</code> を1文字ずつ試す）できてしまう。
            </p>
            <p>詳細は<a
                    href="https://docs.google.com/document/d/1YHcl1-vE_ZnZ0kL2almeikAj2gkwCq8_5xwIae7PVik/edit#heading=h.78iny7nejmx2">セキュリティレビュー文書</a>
                参照。</p>
        </div>
        <div class="example" id="example-1b2a6f00"><a class="self-link" href="#example-1b2a6f00"></a> 文字列 "An impressive
            mountain range" の中では "mountain range" は単語境界で区切られていますが、"An impressive mountain ranger" 内では区切られていません。 </div>
        <div class="example" id="example-c7882c95"><a class="self-link" href="#example-c7882c95"></a> 日本語の "<span
                lang="ja">ウィキペディアへようこそ</span>" では "<span lang="ja">ようこそ</span>" は単語境界となりますが、"<span lang="ja">ようこ</span>"
            は単語途中とみなされます。
        </div>
        <h3 class="heading settled" data-level="3.7" id="indicating-the-text-match"><span class="secno">3.7.
            </span><span class="content">一致したテキストの指示</span><a class="self-link" href="#indicating-the-text-match"></a>
        </h3>
        <p>UAは、<a data-link-type="dfn"
                href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#try-to-scroll-to-the-fragment"
                id="ref-for-try-to-scroll-to-the-fragment①">try to scroll to the fragment</a>
            の手順や他のメカニズムの一環として、テキストフラグメントをインビューにスクロールしても構いませんが、必ずしも一致箇所を表示する義務はありません。</p>
        <p>UAはユーザに一致箇所を認識させるため、ハイコントラストなハイライトなど視覚的に強調して示すべきです。</p>
        <p>UAはユーザーの操作で一致表示状態を解除し、強調を消す手段も提示すべきです。</p>
        <p>その見た目やUI動作はUA依存です。ただし、オーサスクリプトで観測可能な手法（例：Documentの<a
                href="https://w3c.github.io/selection-api/#dfn-selection">selection</a>）によって表示してはなりません。そうするとコンテント抽出の攻撃ベクトルとなります。
        </p>
        <p>UAは提供されたコンテキスト語句には視覚的強調を表示してはいけません。</p>
        <p>強調はドキュメントの内容の一部ではないため、UAはユーザがページ内容と区別できる工夫も推奨されます。</p>
        <div class="example" id="example-30d9320e"><a class="self-link" href="#example-30d9320e"></a>
            UAは初回数回だけ、マーカーがリンク元によるUAによる目印である旨のヘルプをインプロダクトUI（例: ポップアップ）で提示してもよいでしょう。 </div>
        <h4 class="heading settled" data-level="3.7.1" id="urls-in-ua-features"><span class="secno">3.7.1. </span><span
                class="content">UA機能のURL表示</span><a class="self-link" href="#urls-in-ua-features"></a></h4>
        <p>UAは、ドキュメントURLを消費する様々な場所を提供します（<code>window.location</code>のようなAPIを除く）。例としては、ロケーションバーで現在表示中ドキュメントのURLを見せたり、ブックマーク作成時のURLなどがあります。
        </p>
        <p>ユーザの混乱を避けるため、こうしたURLに<a data-link-type="dfn" href="#fragment-directive"
                id="ref-for-fragment-directive⑧">フラグメントディレクティブ</a>を含めるかどうかは統一すべきです。本節で推奨する標準動作例を示します。</p>
        <div class="note" role="note">
            <p> ここでの推奨は統一的なユーザ体験を基準としますが、UA間相互運用性には影響せず厳密な適合要件ではありません。 </p>
            <p>細かい挙動は実装UAに委ねられ、デフォルト設定を変えたり抽出UIを出すのも可。例えばユーザがURL内のフラグメントディレクティブ公開を選べるようにも。 </p>
            <p>UX向上実験も許容されます。例えばテキストフラグメントが画面外にスクロールされた場合表示URLから省略してもよいでしょう。</p>
            <p></p>
        </div>
        <p>原則として、URLはビジュアル指示（マーカー）が表示中のみ<a data-link-type="dfn" href="#fragment-directive"
                id="ref-for-fragment-directive⑨">フラグメントディレクティブ</a>を含めるべきです。マーカーが解除されたらURLからも<a data-link-type="dfn"
                href="#fragment-directive" id="ref-for-fragment-directive①⓪">同ディレクティブ</a>を除外すべきです。</p>
        <p>URLがテキストフラグメントを含むが実際には一致しなかった場合、UAは公開URLからそれを省くこともできます。</p>
        <div class="note" role="note">
            <p> ページ内にフラグメントが見つからないのは、リンク作成以降ページが変わったなどをユーザに示す有用な情報となります。 </p>
            <p> ただしブックマーク目的ではその情報はあまり役に立ちません。</p>
        </div>
        <p>よくある具体例は以下のとおりです。</p>
        <div class="note" role="note">
            ここでは「テキストフラグメント」「フラグメントディレクティブ」を区別せず同義に扱います。将来別種のディレクティブが登場した場合は、これらUXを個別に見直すことが必要です。 </div>
        <h5 class="heading settled" data-level="3.7.1.1" id="urls-in-location-bar"><span class="secno">3.7.1.1.
            </span><span class="content">ロケーションバー</span><a class="self-link" href="#urls-in-location-bar"></a></h5>
        <p>ロケーションバーのURLには、マーカー表示中はテキストフラグメントを含めるべきです。マーカー解除時はロケーションバーのURLから<a data-link-type="dfn"
                href="#fragment-directive" id="ref-for-fragment-directive①①">同ディレクティブ</a>を消してください。</p>
        <p>たとえ一致しなくても、ロケーションバーにはフラグメント情報を含めることが推奨されます。</p>
        <h5 class="heading settled" data-level="3.7.1.2" id="urls-in-bookmarks"><span class="secno">3.7.1.2.
            </span><span class="content">ブックマーク</span><a class="self-link" href="#urls-in-bookmarks"></a></h5>
        <p>多くのUAは「ブックマーク」機能で現在ページへのリンクを保存できます。</p>
        <p>新たに作成されたブックマークURLは、デフォルトで一致がありかつマーカー表示中であれば<a data-link-type="dfn" href="#fragment-directive"
                id="ref-for-fragment-directive①②">フラグメントディレクティブ</a>を含めるべきです。</p>
        <p>ブックマークからの遷移時は通常と同様、<a data-link-type="dfn" href="#fragment-directive"
                id="ref-for-fragment-directive①③">同ディレクティブ</a>を処理します。</p>
        <h5 class="heading settled" data-level="3.7.1.3" id="urls-in-sharing"><span class="secno">3.7.1.3. </span><span
                class="content">共有</span><a class="self-link" href="#urls-in-sharing"></a></h5>
        <p>一部UAはURL共有（他アプリ・メッセージ転送）機能を提供します。</p>
        <p>この場合も、一致がありマーカーが未解除なら<a data-link-type="dfn" href="#fragment-directive"
                id="ref-for-fragment-directive①④">フラグメントディレクティブ</a>をURLに含めるべきです。</p>
        <h3 class="heading settled" data-level="3.8" id="document-policy-integration"><span class="secno">3.8.
            </span><span class="content">Document Policyとの統合</span><a class="self-link"
                href="#document-policy-integration"></a></h3>
        <p>本仕様は <a href="https://wicg.github.io/document-policy#configuration-point">Document Policy</a> の設定点として
            "force-load-at-top" という名前で定義します。<a
                href="https://wicg.github.io/document-policy#configuration-point-type">型</a>は <code>boolean</code> で、<a
                href="https://wicg.github.io/document-policy#configuration-point-default-value">初期値</a>
            は <code>false</code>です。
        </p>
        <div class="note" role="note"> 有効化時、このポリシーは全自動ページ読込時スクロール機能（テキストフラグメント・要素フラグメント・履歴復元スクロール）を無効化します。</div>
        <div class="example" id="example-a128f34b">
            <a class="self-link" href="#example-a128f34b"></a> 例：ユーザが
            <code>https://example.com#:~:text=foo</code> に遷移、
            example.comはレスポンスヘッダで
            <pre>Document-Policy: force-load-at-top
</pre>
            と返した場合、
            <p>ページロード時、"foo"を含む要素は indicated partとしてマークされ、target elementとなります。しかし "foo" はスクロール表示されません。</p>
        </div>
        <p>このポリシーによるフラグメント由来のスクロール抑制は、本書<a data-link-type="dfn"
                href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#scroll-to-the-fragment-identifier"
                id="ref-for-scroll-to-the-fragment-identifier④">scroll to the fragment</a>アルゴリズム修正として<a
                href="#navigating-to-text-fragment">§ 3.6 テキストフラグメントへのナビゲート</a>内で規定されています。
        </p>
        <p>履歴スクロール復元の抑制は、<a data-link-type="dfn"
                href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#restore-persisted-state"
                id="ref-for-restore-persisted-state①">restore
                persisted state</a> ステップの2の直後に下記処理を挿入することで規定します：</p>
        <ol start="3">
            <li data-md>
                <p><a href="https://wicg.github.io/document-policy#algo-get-policy-value">"force-load-at-top"
                        機能のDocument policy値を取得</a>し、<a data-link-type="dfn"
                        href="https://dom.spec.whatwg.org/#concept-document"
                        id="ref-for-concept-document①⓪">Document</a>について
                    trueなら、ユーザエージェントは <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-document"
                        id="ref-for-concept-document①①">Document</a>やそのスクロール可能領域のスクロール位置を復元してはならない。</p>
        </ol>
        <h3 class="heading settled" data-level="3.9" id="feature-detectability"><span class="secno">3.9. </span><span
                class="content">機能検出について</span><a class="self-link" href="#feature-detectability"></a></h3>
        <p>機能検出のため、新しいFragmentDirectiveインターフェイスを追加し、UAが対応していれば<code>document.fragmentDirective</code>で公開する提案です。</p>
        <pre class="idl highlight def">[<a class="idl-code" data-link-type="extended-attribute" href="https://webidl.spec.whatwg.org/#Exposed" id="ref-for-Exposed"><c- g>Exposed</c-></a>=<c- n>Window</c->]
<c- b>interface</c-> <dfn class="dfn-paneled idl-code" data-dfn-type="interface" data-export id="fragmentdirective"><code><c- g>FragmentDirective</c-></code></dfn> {
};
</pre>
        <p>このため <code
                class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document">Document</a></code>
            インターフェイスに <code>fragmentDirective</code> プロパティを追加します：</p>
        <pre class="idl highlight def"><c- b>partial</c-> <c- b>interface</c-> <a class="idl-code" data-link-type="interface" href="https://dom.spec.whatwg.org/#document" id="ref-for-document①"><c- g>Document</c-></a> {
    [<a class="idl-code" data-link-type="extended-attribute" href="https://webidl.spec.whatwg.org/#SameObject" id="ref-for-SameObject"><c- g>SameObject</c-></a>] <c- b>readonly</c-> <c- b>attribute</c-> <a data-link-type="idl-name" href="#fragmentdirective" id="ref-for-fragmentdirective"><c- n>FragmentDirective</c-></a> <dfn class="idl-code" data-dfn-for="Document" data-dfn-type="attribute" data-export data-readonly data-type="FragmentDirective" id="dom-document-fragmentdirective"><code><c- g>fragmentDirective</c-></code><a class="self-link" href="#dom-document-fragmentdirective"></a></dfn>;
};
</pre>
        <p>このオブジェクトは将来テキストフラグメントやその他ディレクティブに関する追加情報を提供する目的にも使えるでしょう。</p>
        <h2 class="heading settled" data-level="4" id="generating-text-fragment-directives"><span class="secno">4.
            </span><span class="content">テキストフラグメントディレクティブ生成</span><a class="self-link"
                href="#generating-text-fragment-directives"></a></h2>
        <div class="note" role="note"> この節は規範的でありません。 </div>
        <p>本節ではUAが<a data-link-type="dfn" href="#text-directive"
                id="ref-for-text-directive①④">テキストディレクティブ</a>付きURLを自動生成する際の推奨を示します。必須仕様ではありませんが、生成URLの安定性・利便性を高める観点でまとめています。
        </p>
        <h3 class="heading settled" data-level="4.1" id="prefer-exact-matching-to-range-based"><span class="secno">4.1.
            </span><span class="content">範囲一致より完全一致を優先</span><a class="self-link"
                href="#prefer-exact-matching-to-range-based"></a></h3>
        <p>一致テキストは exact型（例: "text=foo%20bar%20baz"）または range型（例: "text=foo,bar"）いずれでも指定できます。</p>
        <p>可能なら全体を1つの文字列として指定するほうが望ましいです。これにより遷移先ページが削除・変動しても意図したリンク先がURLから分かります。</p>
        <div class="example" id="example-53e82e58">
            <a class="self-link" href="#example-53e82e58"></a> 例：URL
            https://en.wikipedia.org/wiki/History_of_computing の下記文引用のリンクを作りたい場合:
            <pre>The first recorded idea of using digital electronics for computing was the
1931 paper "The Use of Thyratrons for High Speed Automatic Counting of
Physical Phenomena" by C. E. Wynn-Williams.
</pre>
            <p>範囲指定の場合:</p>
            <p><a href="https://en.wikipedia.org/wiki/History_of_computing#:~:text=The%20first%20recorded,Williams">
                    https://en.wikipedia.org/wiki/History_of_computing#:~:text=The%20first%20recorded,Williams</a></p>
            <p>完全一致指定の場合:</p>
            <p><a
                    href="https://en.wikipedia.org/wiki/History_of_computing#:~:text=The%20first%20recorded%20idea%20of%20using%20digital%20electronics%20for%20computing%20was%20the%201931%20paper%20%22The%20Use%20of%20Thyratrons%20for%20High%20Speed%20Automatic%20Counting%20of%20Physical%20Phenomena%22%20by%20C.%20E.%20Wynn-Williams">
                    https://en.wikipedia.org/wiki/History_of_computing#:~:text=The%20first%20recorded%20idea%20of%20using%20digital%20electronics%20for%20computing%20was%20the%201931%20paper%20%22The%20Use%20of%20Thyratrons%20for%20High%20Speed%20Automatic%20Counting%20of%20Physical%20Phenomena%22%20by%20C.%20E.%20Wynn-Williams</a>
            </p>
            <p>範囲一致は安定性が低く、ページ途中に "The first recorded" が追加されると違う箇所がターゲットとなってしまいます。</p>
            <p>また、範囲一致は意味的な価値も小さいです。当該文自体がなくなった場合、ユーザーは意図したターゲット文を知り得ません。exactタイプならUAやユーザーが「探しても出ない」旨明示できます。</p>
        </div>
        <p>範囲一致は引用テキストが非常に長く、全体をエンコードするとURLが極端に長大になる場合は有用です。</p>
        <p>300文字未満のテキスト断片は完全一致を推奨、超える場合はrange型も可。</p>
        <div class="note" role="note"> 今後この上限値について合理的な指標を検討予定。 </div>
        <h3 class="heading settled" data-level="4.2" id="use-context-only-when-necessary"><span class="secno">4.2.
            </span><span class="content">文脈指定は必要時のみ</span><a class="self-link"
                href="#use-context-only-when-necessary"></a></h3>
        <p>文脈指定は<a data-link-type="dfn" href="#text-directive"
                id="ref-for-text-directive①⑤">テキストディレクティブ</a>によるページ内断片の曖昧性解消に使えますが、構造変化などで
            脆くなりやすいです。多くの場合、断片テキストは要素境界で始まったり終わることが多いので文脈側が隣接別要素に現れます。そのためページ構造の変更で文脈と一致断片が隣接しなくなりURLが無効になりがちです。</p>
        <div class="example" id="example-7a86f6f5">
            <a class="self-link" href="#example-7a86f6f5"></a> 例：次のテキストへのURL化の場合
            <pre>&lt;div class="section">HEADER&lt;/div>
&lt;div class="content">Text to quote&lt;/div>
</pre>
            <p>ディレクティブ例：</p>
            <pre>text=HEADER-,Text%20to%20quote
</pre>
            <p>しかし、ページが [edit] リンクをヘッダー隣に追加した場合、このURLは壊れてしまいます。</p>
        </div>
        <p>断片テキストが十分長くユニークな場合、UAは無用な文脈語追加を避けるべきです。</p>
        <p>文脈指定が必要な条件：</p>
        <ul>
            <li>UAが引用テキストが曖昧だと判定した場合
            <li>引用テキストが3語以下
        </ul>
        <div class="note" role="note"> この数値基準も今後検討予定。 </div>
        <h3 class="heading settled" data-level="4.3" id="determine-if-fragment-id-is-needed"><span class="secno">4.3.
            </span><span class="content">フラグメントIDの要否判定</span><a class="self-link"
                href="#determine-if-fragment-id-is-needed"></a></h3>
        <p>UAが<a data-link-type="dfn" href="#text-directive"
                id="ref-for-text-directive①⑧">テキストディレクティブ</a>付きURLへ遷移時、テキストフラグメントが見つからなければ通常の要素IDフラグメントにフォールバックしてスクロールします。
        </p>
        <p>これは、ページテキストが変化して<a data-link-type="dfn" href="#text-directive"
                id="ref-for-text-directive①⑨">テキストディレクティブ</a>が無効化された場合の保険として有用です。</p>
        <div class="example" id="example-5990805b">
            <a class="self-link" href="#example-5990805b"></a> 例：URL
            https://en.wikipedia.org/wiki/History_of_computing の下記文引用時
            <pre>The earliest known tool for use in computation is the Sumerian abacus
</pre>
            <p>該当文が含まれるセクションを#で指定することで、文が消えてもユーザーを該当セクションに案内できます：</p>
            <p><a
                    href="https://en.wikipedia.org/wiki/History_of_computing#Early_computation:~:text=The%20earliest%20known%20tool%20for%20use%20in%20computation%20is%20the%20Sumerian%20abacus">
                    https://en.wikipedia.org/wiki/History_of_computing#Early_computation:~:text=The%20earliest%20known%20tool%20for%20use%20in%20computation%20is%20the%20Sumerian%20abacus</a>
            </p>
        </div>
        <p>ただし、フォールバック先の要素IDが適切かどうか注意が必要です：</p>
        <div class="example" id="example-3c4e565c">
            <a class="self-link" href="#example-3c4e565c"></a> 例：ユーザが
            https://en.wikipedia.org/wiki/History_of_computing#Early_computation に遷移、下方にスクロールして Symbolic Computations
            セクション内のテキスト断片を選択してURLを作る場合:
            <pre>By the late 1960s, computer systems could perform symbolic algebraic
manipulations
</pre>
            <p>この時ページURLは
                https://en.wikipedia.org/wiki/History_of_computing#Early_computation
                ですが、フォールバックで#Early_computationを使うべきではありません。当該文が消えた場合、全く関係ない位置（#Early_computation）が開いてしまい混乱の元となります。</p>
            <p>UAが妥当な要素IDフラグメントを自動判定できない場合、URLからフラグメントIDを除去するべきです：</p>
            <p><a
                    href="https://en.wikipedia.org/wiki/History_of_computing#:~:text=By%20the%20late%201960s,%20computer%20systems%20could%20perform%20symbolic%20algebraic%20manipulations">
                    https://en.wikipedia.org/wiki/History_of_computing#:~:text=By%20the%20late%201960s,%20computer%20systems%20could%20perform%20symbolic%20algebraic%20manipulations</a>
            </p>
        </div>
    </main>
    <div data-fill-with="conformance">
        <h2 class="no-ref no-num heading settled" id="w3c-conformance"><span class="content">適合性</span><a
                class="self-link" href="#w3c-conformance"></a></h2>
        <h3 class="no-ref no-num heading settled" id="w3c-conventions"><span class="content">ドキュメント慣例</span><a
                class="self-link" href="#w3c-conventions"></a></h3>
        <p>適合要件は、記述的な断言とRFC 2119用語の組み合わせで表現されています。
            この文書の規範的な部分で使われている “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”,
            “RECOMMENDED”,
            “MAY”, “OPTIONAL” などの用語はRFC 2119で定義される意味として解釈してください。
            ただし読みやすさのため、本仕様ではこれらの用語はすべて大文字で表記しているわけではありません。 </p>
        <p>本仕様のテキストは、明示的に非規範・例・注記と記されたもの以外はすべて規範的です。<a data-link-type="biblio" href="#biblio-rfc2119"
                title="Key words for use in RFCs to Indicate Requirement Levels">[RFC2119]</a>
        </p>
        <p>本仕様の例は “for example” や <code>class="example"</code> の記述で導入し、本文と区別します。 </p>
        <div class="example" id="w3c-example">
            <a class="self-link" href="#w3c-example"></a>
            <p>これは情報提供目的の例です。 </p>
        </div>
        <p>非規範的な注記（Note）は文頭が “Note” で始まるか、<code>class="note"</code> などで本文と区別します。</p>
        <p class="note" role="note">注：これは情報目的の注記です。</p>
        <details class="wpt-tests-block" dir="ltr" lang="en" open>
            <summary>テスト</summary>
            <p>本仕様の内容に関するテストはこのような “Tests” ブロック内で示すことがあります。
                その種のブロックは規範的ではありません。</p>
            <ul class="wpt-tests-list"></ul>
            <hr>
        </details>
    </div>
    <script src="https://www.w3.org/scripts/TR/2021/fixup.js"></script>
    <h2 class="no-num no-ref heading settled" id="index"><span class="content">索引</span><a class="self-link"
            href="#index"></a></h2>
    <h3 class="no-num no-ref heading settled" id="index-defined-here"><span class="content">本仕様で定義される用語</span><a
            class="self-link" href="#index-defined-here"></a></h3>
    <ul class="index">
        <li><a href="#characterstring">CharacterString</a><span>、§ 3.3.3 にて</span>
        <li><a href="#check-if-a-text-directive-can-be-scrolled">テキストディレクティブがスクロール可能か確認</a><span>、§ 3.5.4 にて</span>
        <li><a href="#directives">ディレクティブ</a><span>、§ 3.3 にて</span>
        <li>
            ディレクティブ状態
            <ul>
                <li><a href="#directive-state">定義</a><span>、§ 3.3.1 にて</span>
                <li><a href="#she-directive-state">sheの定義</a><span>、§ 3.3.1 にて</span>
            </ul>
        <li><a href="#text-directive-end">終端</a><span>、§ 3.4 にて</span>
        <li><a href="#explicitchar">ExplicitChar</a><span>、§ 3.3.3 にて</span>
        <li><a href="#find-a-range-from-a-node-list">ノードリストから範囲を探す</a><span>、§ 3.6.1 にて</span>
        <li><a href="#find-a-range-from-a-text-directive">テキストディレクティブから範囲を探す</a><span>、§ 3.6.1 にて</span>
        <li><a href="#find-a-string-in-range">範囲内で文字列を検索</a><span>、§ 3.6.1 にて</span>
        <li><a href="#first-common-ancestor">最初の共通祖先</a><span>、§ 3.6 にて</span>
        <li><a href="#fragment-directive">フラグメントディレクティブ</a><span>、§ 3.3 にて</span>
        <li>
            FragmentDirective
            <ul>
                <li><a href="#fragmentdirective">(インターフェイス)</a><span>、§ 3.9 にて</span>
                <li><a href="#fragmentdirectiveproduction">定義</a><span>、§ 3.3.3 にて</span>
            </ul>
        <li><a href="#dom-document-fragmentdirective">fragmentDirective</a><span>、§ 3.9 にて</span>
        <li><a href="#fragment-directive-delimiter">フラグメントディレクティブ区切り記号</a><span>、§ 3.3 にて</span>
        <li><a href="#get-boundary-point-at-index">インデックスから境界点を得る</a><span>、§ 3.6.1 にて</span>
        <li><a href="#has-block-level-display">ブロックレベル表示を持つ</a><span>、§ 3.6.1 にて</span>
        <li><a href="#invoke-text-directives">テキストディレクティブの実行</a><span>、§ 3.6.1 にて</span>
        <li><a href="#is-at-a-word-boundary">単語境界である</a><span>、§ 3.6.2 にて</span>
        <li><a href="#locale">ロケール</a><span>、§ 3.6.2 にて</span>
        <li><a href="#nearest-block-ancestor">直近のブロック祖先</a><span>、§ 3.6.1 にて</span>
        <li><a href="#next-non-whitespace-position">次の非空白位置</a><span>、§ 3.6.1 にて</span>
        <li><a href="#non-searchable-subtree">検索不可部分木</a><span>、§ 3.6.1 にて</span>
        <li><a href="#parse-a-text-directive">テキストディレクティブの構文解析</a><span>、§ 3.4 にて</span>
        <li><a href="#parse-the-fragment-directive">フラグメントディレクティブの構文解析</a><span>、§ 3.4 にて</span>
        <li><a href="#document-pending-text-directives">保留中のテキストディレクティブ</a><span>、§ 3.3.2 にて</span>
        <li><a href="#percent-decode-a-text-directive-term">テキストディレクティブ語のパーセントデコード</a><span>、§ 3.4 にて</span>
        <li><a href="#percentencodedbyte">PercentEncodedByte</a><span>、§ 3.3.3 にて</span>
        <li><a href="#text-directive-prefix">前置</a><span>、§ 3.4 にて</span>
        <li><a href="#remove-the-fragment-directive">フラグメントディレクティブの除去</a><span>、§ 3.3.1 にて</span>
        <li><a href="#search-invisible">検索不可</a><span>、§ 3.6.1 にて</span>
        <li><a href="#shadow-including-parent">shadow-including 親</a><span>、§ 3.6 にて</span>
        <li><a href="#text-directive-start">開始</a><span>、§ 3.4 にて</span>
        <li><a href="#text-directive-suffix">後置</a><span>、§ 3.4 にて</span>
        <li><a href="#text-directive">テキストディレクティブ</a><span>、§ 3.4 にて</span>
        <li><a href="#textdirective">TextDirective</a><span>、§ 3.3.3 にて</span>
        <li><a href="#text-directive-allowing-mime-type">MIME 型を許容するテキストディレクティブ</a><span>、§ 3.5.4 にて</span>
        <li><a href="#textdirectiveexplicitchar">TextDirectiveExplicitChar</a><span>、§ 3.3.3 にて</span>
        <li><a href="#textdirectiveparameters">TextDirectiveParameters</a><span>、§ 3.3.3 にて</span>
        <li><a href="#textdirectiveprefix">TextDirectivePrefix</a><span>、§ 3.3.3 にて</span>
        <li><a href="#textdirectivestring">TextDirectiveString</a><span>、§ 3.3.3 にて</span>
        <li><a href="#textdirectivesuffix">TextDirectiveSuffix</a><span>、§ 3.3.3 にて</span>
        <li>
            テキストディレクティブのユーザー操作
            <ul>
                <li><a href="#document-text-directive-user-activation">documentの定義</a><span>、§ 3.5.4 にて</span>
                <li><a href="#request-text-directive-user-activation">requestの定義</a><span>、§ 3.5.4 にて</span>
            </ul>
        <li><a href="#unknowndirective">UnknownDirective</a><span>、§ 3.3.3 にて</span>
        <li><a href="#navigation-params-user-involvement">ユーザー関与</a><span>、§ 3.5.4 にて</span>
        <li><a href="#validtextdirective">ValidTextDirective</a><span>、§ 3.3.3 にて</span>
        <li><a href="#directive-state-value">値</a><span>、§ 3.3.1 にて</span>
        <li><a href="#visible-text-node">可視テキストノード</a><span>、§ 3.6.1 にて</span>
        <li><a href="#word-boundary">単語境界</a><span>、§ 3.6.2 にて</span>
        <li><a href="#word-bounded">単語境界で区切られている</a><span>、§ 3.6.2 にて</span>
    </ul>
    <h3 class="no-num no-ref heading settled" id="index-defined-elsewhere"><span
            class="content">参考規格によって定義される用語</span><a class="self-link" href="#index-defined-elsewhere"></a></h3>
    <ul class="index">
        <li>
            <a data-link-type="biblio">[CSS-CASCADE-5]</a> は次の用語を定義します:
            <ul>
                <li><span class="dfn-paneled" id="9cd25054">computed value</span>
            </ul>
        <li>
            <a data-link-type="biblio">[CSS-DISPLAY-3]</a> は次の用語を定義します:
            <ul>
                <li><span class="dfn-paneled" id="66498315">flex</span>
                <li><span class="dfn-paneled" id="a555386f">grid</span>
            </ul>
        <li>
            <a data-link-type="biblio">[CSS-DISPLAY-4]</a> は次の用語を定義します:
            <ul>
                <li><span class="dfn-paneled" id="bb886fc6">block</span>
                <li><span class="dfn-paneled" id="e7f0dd6c">display</span>
                <li><span class="dfn-paneled" id="607244fc">flow-root</span>
                <li><span class="dfn-paneled" id="96626f55">list-item</span>
                <li><span class="dfn-paneled" id="55e8f5de">none</span>
                <li><span class="dfn-paneled" id="abb2bed7">table</span>
                <li><span class="dfn-paneled" id="12f8fb07">visibility</span>
                <li><span class="dfn-paneled" id="6420cb11">visible</span>
            </ul>
        <li>
            <a data-link-type="biblio">[CSSOM-VIEW-1]</a> は次の用語を定義します:
            <ul>
                <li><span class="dfn-paneled" id="2cbb079e">ターゲットをスクロールして表示</span>
            </ul>
        <li>
            <a data-link-type="biblio">[DOM]</a> は次の用語を定義します:
            <ul>
                <li><span class="dfn-paneled" id="85394472">Document</span>
                <li><span class="dfn-paneled" id="597088f0">Text</span>
                <li><span class="dfn-paneled" id="4fef809c">after</span>
                <li><span class="dfn-paneled" id="8a3e6de2">境界点</span>
                <li><span class="dfn-paneled" id="8aac8409">collapsed</span>
                <li><span class="dfn-paneled" id="3f23ec71">content type</span>
                <li><span class="dfn-paneled" id="212ee1f7">data</span>
                <li><span class="dfn-paneled" id="cefd9ec1">doctype</span>
                <li><span class="dfn-paneled" id="a973e0fe">document</span>
                <li><span class="dfn-paneled" id="2f0ba72c">ドキュメント要素</span>
                <li><span class="dfn-paneled" id="27d9b7ea">要素</span>
                <li><span class="dfn-paneled" id="5bbf7dec">終了</span>
                <li><span class="dfn-paneled" id="3edd98b4">終了ノード</span>
                <li><span class="dfn-paneled" id="203b148b">終了オフセット</span>
                <li><span class="dfn-paneled" id="6fba6744">following</span>
                <li><span class="dfn-paneled" id="5d233601">host</span>
                <li><span class="dfn-paneled" id="5e8d5f81">length</span>
                <li><span class="dfn-paneled" id="d462b34f">ノード</span>
                <li><span class="dfn-paneled" id="5216e1a0">ノードドキュメント</span>
                <li><span class="dfn-paneled" id="c62cd7cf">origin</span>
                <li><span class="dfn-paneled" id="d729a9ff">親</span>
                <li><span class="dfn-paneled" id="5afeceea">親要素</span>
                <li><span class="dfn-paneled" id="8044ee41">範囲</span>
                <li><span class="dfn-paneled" id="3fcc582f">shadow root</span>
                <li><span class="dfn-paneled" id="8f378588">shadow-including ancestor</span>
                <li><span class="dfn-paneled" id="fd32e3c9">shadow-including descendant</span>
                <li><span class="dfn-paneled" id="3d6a3d36">shadow-including inclusive ancestor</span>
                <li><span class="dfn-paneled" id="fefa5851">shadow-including tree order</span>
                <li><span class="dfn-paneled" id="936c50ab">開始</span>
                <li><span class="dfn-paneled" id="6c88f67e">開始ノード</span>
                <li><span class="dfn-paneled" id="683b1507">開始オフセット</span>
                <li><span class="dfn-paneled" id="c9f15d91">部分文字列データ</span>
                <li><span class="dfn-paneled" id="347e8fe9">url</span>
            </ul>
        <li>
            <a data-link-type="biblio">[ENCODING]</a> は次の用語も定義します:
            <ul>
                <li><span class="dfn-paneled" id="a3033be5">utf-8 decode without bom</span>
            </ul>
        <li>
            <a data-link-type="biblio">[FETCH]</a> は次の用語を定義します:
            <ul>
                <li><span class="dfn-paneled" id="55213b5b">request</span>
            </ul>
        <li>
            <a data-link-type="biblio">[HTML]</a> は次の用語を定義します:
            <ul>
                <li><span class="dfn-paneled" id="fe2a6718">HTMLAudioElement</span>
                <li><span class="dfn-paneled" id="10e25f42">HTMLIFrameElement</span>
                <li><span class="dfn-paneled" id="c5891539">HTMLImageElement</span>
                <li><span class="dfn-paneled" id="cc59b66b">HTMLMeterElement</span>
                <li><span class="dfn-paneled" id="59ce5887">HTMLObjectElement</span>
                <li><span class="dfn-paneled" id="fcadc50c">HTMLProgressElement</span>
                <li><span class="dfn-paneled" id="ec4838d8">HTMLScriptElement</span>
                <li><span class="dfn-paneled" id="aa8746c3">HTMLStyleElement</span>
                <li><span class="dfn-paneled" id="f57f330b">HTMLVideoElement</span>
                <li><span class="dfn-paneled" id="78492a07">HashChangeEvent</span>
                <li><span class="dfn-paneled" id="cc549724">Location</span>
                <li><span class="dfn-paneled" id="35972864">active document</span>
                <li><span class="dfn-paneled" id="3c75104d">apply the history step</span>
                <li><span class="dfn-paneled" id="1c1db69e">apply the push/replace history step</span>
                <li><span class="dfn-paneled" id="f8434dee">being rendered</span>
                <li><span class="dfn-paneled" id="3b2ff63e">browsing context</span>
                <li><span class="dfn-paneled" id="b0b49d3c">browsing context set</span>
                <li><span class="dfn-paneled" id="07ad3048">create navigation params by fetching</span>
                <li><span class="dfn-paneled" id="65393af9">document</span>
                <li><span class="dfn-paneled" id="092de955">document state</span>
                <li><span class="dfn-paneled" id="7f118064">finalize a cross-document navigation</span>
                <li><span class="dfn-paneled" id="40a1c717">group</span>
                <li><span class="dfn-paneled" id="2895d75d">initiator origin</span>
                <li><span class="dfn-paneled" id="d4dbbbf0">language</span>
                <li><span class="dfn-paneled" id="b07164ad">multiple</span>
                <li><span class="dfn-paneled" id="2594e562">navigate</span>
                <li><span class="dfn-paneled" id="fffd9ca9">navigate to a fragment</span>
                <li><span class="dfn-paneled" id="4437edc6">navigation params</span>
                <li><span class="dfn-paneled" id="13dd6cae">node navigable</span>
                <li><span class="dfn-paneled" id="086e3aff">origin</span>
                <li><span class="dfn-paneled" id="1bba3db7">親</span>
                <li><span class="dfn-paneled" id="8b87b428">保存状態の復元</span>
                <li><span class="dfn-paneled" id="7393da89">同一オリジン</span>
                <li><span class="dfn-paneled" id="3f2e859c">フラグメントまでスクロール</span>
                <li><span class="dfn-paneled" id="85188fb3">select</span>
                <li><span class="dfn-paneled" id="c3ae9e6a">voidとしてシリアライズ</span>
                <li><span class="dfn-paneled" id="8a051c9f">try to scroll to the fragment</span>
                <li><span class="dfn-paneled" id="5c1d019b">apply the history step適用のためのドキュメント更新</span>
                <li><span class="dfn-paneled" id="34d2343e">ユーザーナビゲーション関与</span>
            </ul>
        <li>
            <a data-link-type="biblio">[INFRA]</a> は次の用語を定義します:
            <ul>
                <li><span class="dfn-paneled" id="53275e46">append</span>
                <li><span class="dfn-paneled" id="2d5a2765">ASCII文字列</span>
                <li><span class="dfn-paneled" id="77b4c09a">assert</span>
                <li><span class="dfn-paneled" id="7b0d918d">break</span>
                <li><span class="dfn-paneled" id="915aff5e">コードポイント</span>
                <li><span class="dfn-paneled" id="4ef39030">コードポイント長</span>
                <li><span class="dfn-paneled" id="bb1f9628">コードポイント部分文字列</span>
                <li><span class="dfn-paneled" id="cfd05055">位置指定コードポイント部分文字列</span>
                <li><span class="dfn-paneled" id="b8906bbb">末尾までのコードポイント部分文字列</span>
                <li><span class="dfn-paneled" id="4a3bf5fb">連結</span>
                <li><span class="dfn-paneled" id="f937b7b6">continue</span>
                <li><span class="dfn-paneled" id="03afaf9c">empty</span>
                <li><span class="dfn-paneled" id="9c05f1bf">ends with</span>
                <li><span class="dfn-paneled" id="16d07e10">for each</span>
                <li><span class="dfn-paneled" id="f052b1ea">html名前空間</span>
                <li><span class="dfn-paneled" id="860300d4">実装依存</span>
                <li><span class="dfn-paneled" id="0fa357c3">length</span>
                <li><span class="dfn-paneled" id="649608b9">リスト</span>
                <li><span class="dfn-paneled" id="75bee4d5">位置変数</span>
                <li><span class="dfn-paneled" id="0204d188">サイズ</span>
                <li><span class="dfn-paneled" id="54627f47">starts with</span>
                <li><span class="dfn-paneled" id="7a3dbdb1">厳密な文字列分割</span>
                <li><span class="dfn-paneled" id="0698d556">文字列</span>
                <li><span class="dfn-paneled" id="984221ca">構造体</span>
            </ul>
        <li>
            <a data-link-type="biblio">[MIMESNIFF]</a> は次の用語を定義します:
            <ul>
                <li><span class="dfn-paneled" id="7c195f8b">essence</span>
                <li><span class="dfn-paneled" id="16785ec4">mime type</span>
            </ul>
        <li>
            <a data-link-type="biblio">[URL]</a> は次の用語を定義します:
            <ul>
                <li><span class="dfn-paneled" id="ed948033">フラグメント</span>
                <li><span class="dfn-paneled" id="79fa146b">フラグメント・パーセントエンコード集合</span>
                <li><span class="dfn-paneled" id="8f69ce41">パーセントデコード</span>
                <li><span class="dfn-paneled" id="dcffbccd">url</span>
                <li><span class="dfn-paneled" id="4bb788fe">url コードポイント</span>
            </ul>
        <li>
            <a data-link-type="biblio">[WEBIDL]</a> は次の用語を定義します:
            <ul>
                <li><span class="dfn-paneled" id="889e932f">Exposed</span>
                <li><span class="dfn-paneled" id="a5c91173">SameObject</span>
            </ul>
    </ul>
    <h2 class="no-num no-ref heading settled" id="references"><span class="content">参考文献</span><a class="self-link"
            href="#references"></a></h2>
    <h3 class="no-num no-ref heading settled" id="normative"><span class="content">規範参考文献</span><a class="self-link"
            href="#normative"></a></h3>
    <dl>
        <dt id="biblio-css-cascade-5">[CSS-CASCADE-5]
        <dd>Elika Etemad; Miriam Suzanne; Tab Atkins Jr.. <a href="https://drafts.csswg.org/css-cascade-5/"><cite>CSS
                    カスケーディングおよび継承 レベル5</cite></a>. URL: <a
                href="https://drafts.csswg.org/css-cascade-5/">https://drafts.csswg.org/css-cascade-5/</a>
        <dt id="biblio-css-display-3">[CSS-DISPLAY-3]
        <dd>Elika Etemad; Tab Atkins Jr.. <a href="https://drafts.csswg.org/css-display/"><cite>CSS Display モジュール レベル
                    3</cite></a>. URL: <a
                href="https://drafts.csswg.org/css-display/">https://drafts.csswg.org/css-display/</a>
        <dt id="biblio-css-display-4">[CSS-DISPLAY-4]
        <dd><a href="https://drafts.csswg.org/css-display-4/"><cite>CSS Display モジュール レベル 4</cite></a>. Editor's
            Draft. URL: <a href="https://drafts.csswg.org/css-display-4/">https://drafts.csswg.org/css-display-4/</a>
        <dt id="biblio-cssom-view-1">[CSSOM-VIEW-1]
        <dd>Simon Pieters. <a href="https://drafts.csswg.org/cssom-view/"><cite>CSSOM View モジュール</cite></a>. URL: <a
                href="https://drafts.csswg.org/cssom-view/">https://drafts.csswg.org/cssom-view/</a>
        <dt id="biblio-document-policy">[DOCUMENT-POLICY]
        <dd>Ian Clelland. <a href="https://wicg.github.io/document-policy"><cite>ドキュメントポリシー</cite></a>. ED. URL: <a
                href="https://wicg.github.io/document-policy">https://wicg.github.io/document-policy</a>
        <dt id="biblio-dom">[DOM]
        <dd>Anne van Kesteren. <a href="https://dom.spec.whatwg.org/"><cite>DOM 標準</cite></a>. Living Standard.
            URL: <a href="https://dom.spec.whatwg.org/">https://dom.spec.whatwg.org/</a>
        <dt id="biblio-encoding">[ENCODING]
        <dd>Anne van Kesteren. <a href="https://encoding.spec.whatwg.org/"><cite>エンコーディング標準</cite></a>. Living
            Standard. URL: <a href="https://encoding.spec.whatwg.org/">https://encoding.spec.whatwg.org/</a>
        <dt id="biblio-fetch">[FETCH]
        <dd>Anne van Kesteren. <a href="https://fetch.spec.whatwg.org/"><cite>Fetch 標準</cite></a>. Living
            Standard. URL: <a href="https://fetch.spec.whatwg.org/">https://fetch.spec.whatwg.org/</a>
        <dt id="biblio-html">[HTML]
        <dd>Anne van Kesteren; et al. <a href="https://html.spec.whatwg.org/multipage/"><cite>HTML 標準</cite></a>.
            Living Standard. URL: <a
                href="https://html.spec.whatwg.org/multipage/">https://html.spec.whatwg.org/multipage/</a>
        <dt id="biblio-infra">[INFRA]
        <dd>Anne van Kesteren; Domenic Denicola. <a href="https://infra.spec.whatwg.org/"><cite>インフラ標準</cite></a>.
            Living Standard. URL: <a href="https://infra.spec.whatwg.org/">https://infra.spec.whatwg.org/</a>
        <dt id="biblio-mimesniff">[MIMESNIFF]
        <dd>Gordon P. Hemsley. <a href="https://mimesniff.spec.whatwg.org/"><cite>MIME スニッフィング標準</cite></a>.
            Living Standard. URL: <a href="https://mimesniff.spec.whatwg.org/">https://mimesniff.spec.whatwg.org/</a>
        <dt id="biblio-rfc2119">[RFC2119]
        <dd>S. Bradner. <a href="https://datatracker.ietf.org/doc/html/rfc2119"><cite>RFC で要件レベルを示すためのキーワード</cite></a>.
            1997年3月. Best Current Practice. URL: <a
                href="https://datatracker.ietf.org/doc/html/rfc2119">https://datatracker.ietf.org/doc/html/rfc2119</a>
        <dt id="biblio-uax29">[UAX29]
        <dd>Josh Hadley. <a href="https://www.unicode.org/reports/tr29/tr29-43.html"><cite>Unicode
                    テキストセグメンテーション</cite></a>. 2023年8月16日. Unicode Standard Annex #29. URL: <a
                href="https://www.unicode.org/reports/tr29/tr29-43.html">https://www.unicode.org/reports/tr29/tr29-43.html</a>
        <dt id="biblio-url">[URL]
        <dd>Anne van Kesteren. <a href="https://url.spec.whatwg.org/"><cite>URL 標準</cite></a>. Living Standard.
            URL: <a href="https://url.spec.whatwg.org/">https://url.spec.whatwg.org/</a>
        <dt id="biblio-uts10">[UTS10]
        <dd>Ken Whistler; Markus Scherer. <a href="https://www.unicode.org/reports/tr10/tr10-49.html"><cite>Unicode
                    照合アルゴリズム</cite></a>. 2023年9月5日. Unicode Technical Standard #10. URL: <a
                href="https://www.unicode.org/reports/tr10/tr10-49.html">https://www.unicode.org/reports/tr10/tr10-49.html</a>
        <dt id="biblio-webidl">[WEBIDL]
        <dd>Edgar Chen; Timothy Gu. <a href="https://webidl.spec.whatwg.org/"><cite>Web IDL 標準</cite></a>. Living
            Standard. URL: <a href="https://webidl.spec.whatwg.org/">https://webidl.spec.whatwg.org/</a>
    </dl>
    <h3 class="no-num no-ref heading settled" id="informative"><span class="content">参考情報</span><a class="self-link"
            href="#informative"></a></h3>
    <dl>
        <dt id="biblio-bcp47">[BCP47]
        <dd>A. Phillips, Ed.; M. Davis, Ed.. <a href="https://www.rfc-editor.org/rfc/rfc5646"><cite>言語識別用タグ</cite></a>.
            2009年9月. Best Current Practice. URL: <a
                href="https://www.rfc-editor.org/rfc/rfc5646">https://www.rfc-editor.org/rfc/rfc5646</a>
        <dt id="biblio-fetch-metadata">[FETCH-METADATA]
        <dd>Mike West. <a href="https://w3c.github.io/webappsec-fetch-metadata/"><cite>Fetch メタデータリクエストヘッダ</cite></a>.
            WD. URL: <a
                href="https://w3c.github.io/webappsec-fetch-metadata/">https://w3c.github.io/webappsec-fetch-metadata/</a>
    </dl>
    <h2 class="no-num no-ref heading settled" id="idl-index"><span class="content">IDL 索引</span><a class="self-link"
            href="#idl-index"></a></h2>
    <pre class="idl highlight def">[<a class="idl-code" data-link-type="extended-attribute" href="https://webidl.spec.whatwg.org/#Exposed"><c- g>Exposed</c-></a>=<c- n>Window</c->]
<c- b>interface</c-> <a href="#fragmentdirective"><code><c- g>FragmentDirective</c-></code></a> {
};

<c- b>partial</c-> <c- b>interface</c-> <a class="idl-code" data-link-type="interface" href="https://dom.spec.whatwg.org/#document"><c- g>Document</c-></a> {
    [<a class="idl-code" data-link-type="extended-attribute" href="https://webidl.spec.whatwg.org/#SameObject"><c- g>SameObject</c-></a>] <c- b>readonly</c-> <c- b>attribute</c-> <a data-link-type="idl-name" href="#fragmentdirective"><c- n>FragmentDirective</c-></a> <a data-readonly data-type="FragmentDirective" href="#dom-document-fragmentdirective"><code><c- g>fragmentDirective</c-></code></a>;
};

</pre>
    <h2 class="no-num no-ref heading settled" id="issues-index"><span class="content">課題索引</span><a class="self-link"
            href="#issues-index"></a></h2>
    <div style="counter-reset:issue">
        <div class="issue"> TODO: URL のフラグメントが ':~:' で終わる場合（つまり空ディレクティブ）、null
            を返し、明示的なディレクティブが指定されていない（既存ディレクティブの上書きを回避）扱いになる。ただし、空文字列を返す方が良いかもしれません？この場合、ページは '#:~:' へ navigate/pushState
            することで明示的にディレクティブ／ハイライトを消せるようになります。<a class="issue-return" href="#issue-f4a5d96b"
                title="Jump to section">↵</a></div>
        <div class="issue"> シャドウツリー内の場合、ターゲットは何を設定すべきか？ <a
                href="https://github.com/WICG/scroll-to-text-fragment/issues/190">#190</a> <a class="issue-return"
                href="#issue-424a4e25" title="Jump to section">↵</a></div>
        <div class="issue"> これらの特定アルゴリズムはいまのままだと target が祖先やルートドキュメントノードになりうるためうまく動作しない。<a
                href="https://github.com/WICG/scroll-to-text-fragment/issues/89">#89</a> では一致対象を
            <code>contain:style layout</code> ブロックに限定する提案があり、これが解決につながる。<a class="issue-return" href="#issue-10739530"
                title="Jump to section">↵</a>
        </div>
        <div class="issue">実装ノート：現状Blinkはtext fragmentでフォーカスを設定しませんが、すべき？TODO: crbugをファイル化。<a class="issue-return"
                href="#issue-e253a983" title="Jump to section">↵</a></div>
        <div class="issue"> 厳密には正しくなく、Chromeは same-origin イニシエーターには許容しています。この点の仕様修正が必要です。<a
                href="https://github.com/WICG/scroll-to-text-fragment/issues/240">[Issue
                #WICG/scroll-to-text-fragment#240]</a> <a class="issue-return" href="#issue-35f490f0"
                title="Jump to section">↵</a></div>
        <div class="issue"> HTML仕様でこれを書いていいのか？ <a class="issue-return" href="#issue-0e1d8eda"
                title="Jump to section">↵</a></div>
        <div class="issue"> <code>force-load-at-top</code> が Navigation API とどう連携すべきか決定が必要。<a
                href="https://github.com/WICG/scroll-to-text-fragment/issues/242">[Issue
                #WICG/scroll-to-text-fragment#242]</a> <a class="issue-return" href="#issue-de0fed9d"
                title="Jump to section">↵</a></div>
        <div class="issue"> <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-cd-data">data</a>
            はここでDOMの文字データそのものであり本来正しくありません。このアルゴリズムは描画結果テキストで処理し（その後DOMに戻す）ことを意図しています。<a
                href="https://github.com/WICG/scroll-to-text-fragment/issues/98">[Issue
                #WICG/scroll-to-text-fragment#98]</a> <a class="issue-return" href="#issue-96fe4755"
                title="Jump to section">↵</a></div>
    </div>
    <script>/* Boilerplate: script-dfn-panel */
        "use strict";
        {
            const dfnsJson = window.dfnsJson || {};

            function genDfnPanel({ dfnID, url, dfnText, refSections, external }) {
                return mk.aside({
                    class: "dfn-panel",
                    id: `infopanel-for-${dfnID}`,
                    "data-for": dfnID,
                    "aria-labelled-by": `infopaneltitle-for-${dfnID}`,
                },
                    mk.span({ id: `infopaneltitle-for-${dfnID}`, style: "display:none" },
                        `Info about the '${dfnText}' ${external ? "external" : ""} reference.`),
                    mk.a({ href: url }, url),
                    mk.b({}, "Referenced in:"),
                    mk.ul({},
                        ...refSections.map(section =>
                            mk.li({},
                                ...section.refs.map((ref, refI) =>
                                    [
                                        mk.a({
                                            href: `#${ref.id}`
                                        },
                                            (refI == 0) ? section.title : `(${refI + 1})`
                                        ),
                                        " ",
                                    ]
                                ),
                            ),
                        ),
                    ),
                );
            }

            function genAllDfnPanels() {
                for (const panelData of Object.values(window.dfnpanelData)) {
                    const dfnID = panelData.dfnID;
                    const dfn = document.getElementById(dfnID);
                    if (!dfn) {
                        console.log(`Can't find dfn#${dfnID}.`, panelData);
                    } else {
                        const panel = genDfnPanel(panelData);
                        append(document.body, panel);
                        insertDfnPopupAction(dfn, panel)
                    }
                }
            }

            document.addEventListener("DOMContentLoaded", () => {
                genAllDfnPanels();

                // Add popup behavior to all dfns to show the corresponding dfn-panel.
                var dfns = queryAll('.dfn-paneled');
                for (let dfn of dfns) { ; }

                document.body.addEventListener("click", (e) => {
                    // If not handled already, just hide all dfn panels.
                    hideAllDfnPanels();
                });
            })


            function hideAllDfnPanels() {
                // Turn off any currently "on" or "activated" panels.
                queryAll(".dfn-panel.on, .dfn-panel.activated").forEach(el => hideDfnPanel(el));
            }

            function showDfnPanel(dfnPanel, dfn) {
                hideAllDfnPanels(); // Only display one at this time.
                dfn.setAttribute("aria-expanded", "true");
                dfnPanel.classList.add("on");
                dfnPanel.style.left = "5px";
                dfnPanel.style.top = "0px";
                const panelRect = dfnPanel.getBoundingClientRect();
                const panelWidth = panelRect.right - panelRect.left;
                if (panelRect.right > document.body.scrollWidth) {
                    // Panel's overflowing the screen.
                    // Just drop it below the dfn and flip it rightward instead.
                    // This still wont' fix things if the screen is *really* wide,
                    // but fixing that's a lot harder without 'anchor()'.
                    dfnPanel.style.top = "1.5em";
                    dfnPanel.style.left = "auto";
                    dfnPanel.style.right = "0px";
                }
            }

            function pinDfnPanel(dfnPanel) {
                // Switch it to "activated" state, which pins it.
                dfnPanel.classList.add("activated");
                dfnPanel.style.left = null;
                dfnPanel.style.top = null;
            }

            function hideDfnPanel(dfnPanel, dfn) {
                if (!dfn) {
                    dfn = document.getElementById(dfnPanel.getAttribute("data-for"));
                }
                dfn.setAttribute("aria-expanded", "false")
                dfnPanel.classList.remove("on");
                dfnPanel.classList.remove("activated");
            }

            function toggleDfnPanel(dfnPanel, dfn) {
                if (dfnPanel.classList.contains("on")) {
                    hideDfnPanel(dfnPanel, dfn);
                } else {
                    showDfnPanel(dfnPanel, dfn);
                }
            }

            function insertDfnPopupAction(dfn, dfnPanel) {
                // Find dfn panel
                const panelWrapper = document.createElement('span');
                panelWrapper.appendChild(dfnPanel);
                panelWrapper.style.position = "relative";
                panelWrapper.style.height = "0px";
                dfn.insertAdjacentElement("afterend", panelWrapper);
                dfn.setAttribute('role', 'button');
                dfn.setAttribute('aria-expanded', 'false')
                dfn.tabIndex = 0;
                dfn.classList.add('has-dfn-panel');
                dfn.addEventListener('click', (event) => {
                    showDfnPanel(dfnPanel, dfn);
                    event.stopPropagation();
                });
                dfn.addEventListener('keypress', (event) => {
                    const kc = event.keyCode;
                    // 32->Space, 13->Enter
                    if (kc == 32 || kc == 13) {
                        toggleDfnPanel(dfnPanel, dfn);
                        event.stopPropagation();
                        event.preventDefault();
                    }
                });

                dfnPanel.addEventListener('click', (event) => {
                    if (event.target.nodeName == 'A') {
                        pinDfnPanel(dfnPanel);
                    }
                    event.stopPropagation();
                });

                dfnPanel.addEventListener('keydown', (event) => {
                    if (event.keyCode == 27) { // Escape key
                        hideDfnPanel(dfnPanel, dfn);
                        event.stopPropagation();
                        event.preventDefault();
                    }
                })
            }
        }
    </script>
    <script>/* Boilerplate: script-dfn-panel */
        "use strict";
        {
            const dfnsJson = window.dfnsJson || {};

            function genDfnPanel({ dfnID, url, dfnText, refSections, external }) {
                return mk.aside({
                    class: "dfn-panel",
                    id: `infopanel-for-${dfnID}`,
                    "data-for": dfnID,
                    "aria-labelled-by": `infopaneltitle-for-${dfnID}`,
                },
                    mk.span({ id: `infopaneltitle-for-${dfnID}`, style: "display:none" },
                        `Info about the '${dfnText}' ${external ? "external" : ""} reference.`),
                    mk.a({ href: url }, url),
                    mk.b({}, "Referenced in:"),
                    mk.ul({},
                        ...refSections.map(section =>
                            mk.li({},
                                ...section.refs.map((ref, refI) =>
                                    [
                                        mk.a({
                                            href: `#${ref.id}`
                                        },
                                            (refI == 0) ? section.title : `(${refI + 1})`
                                        ),
                                        " ",
                                    ]
                                ),
                            ),
                        ),
                    ),
                );
            }

            function genAllDfnPanels() {
                for (const panelData of Object.values(window.dfnpanelData)) {
                    const dfnID = panelData.dfnID;
                    const dfn = document.getElementById(dfnID);
                    if (!dfn) {
                        console.log(`Can't find dfn#${dfnID}.`, panelData);
                    } else {
                        const panel = genDfnPanel(panelData);
                        append(document.body, panel);
                        insertDfnPopupAction(dfn, panel)
                    }
                }
            }

            document.addEventListener("DOMContentLoaded", () => {
                genAllDfnPanels();

                // Add popup behavior to all dfns to show the corresponding dfn-panel.
                var dfns = queryAll('.dfn-paneled');
                for (let dfn of dfns) { ; }

                document.body.addEventListener("click", (e) => {
                    // If not handled already, just hide all dfn panels.
                    hideAllDfnPanels();
                });
            })


            function hideAllDfnPanels() {
                // Turn off any currently "on" or "activated" panels.
                queryAll(".dfn-panel.on, .dfn-panel.activated").forEach(el => hideDfnPanel(el));
            }

            function showDfnPanel(dfnPanel, dfn) {
                hideAllDfnPanels(); // Only display one at this time.
                dfn.setAttribute("aria-expanded", "true");
                dfnPanel.classList.add("on");
                dfnPanel.style.left = "5px";
                dfnPanel.style.top = "0px";
                const panelRect = dfnPanel.getBoundingClientRect();
                const panelWidth = panelRect.right - panelRect.left;
                if (panelRect.right > document.body.scrollWidth) {
                    // Panel's overflowing the screen.
                    // Just drop it below the dfn and flip it rightward instead.
                    // This still wont' fix things if the screen is *really* wide,
                    // but fixing that's a lot harder without 'anchor()'.
                    dfnPanel.style.top = "1.5em";
                    dfnPanel.style.left = "auto";
                    dfnPanel.style.right = "0px";
                }
            }

            function pinDfnPanel(dfnPanel) {
                // Switch it to "activated" state, which pins it.
                dfnPanel.classList.add("activated");
                dfnPanel.style.left = null;
                dfnPanel.style.top = null;
            }

            function hideDfnPanel(dfnPanel, dfn) {
                if (!dfn) {
                    dfn = document.getElementById(dfnPanel.getAttribute("data-for"));
                }
                dfn.setAttribute("aria-expanded", "false")
                dfnPanel.classList.remove("on");
                dfnPanel.classList.remove("activated");
            }

            function toggleDfnPanel(dfnPanel, dfn) {
                if (dfnPanel.classList.contains("on")) {
                    hideDfnPanel(dfnPanel, dfn);
                } else {
                    showDfnPanel(dfnPanel, dfn);
                }
            }

            function insertDfnPopupAction(dfn, dfnPanel) {
                // Find dfn panel
                const panelWrapper = document.createElement('span');
                panelWrapper.appendChild(dfnPanel);
                panelWrapper.style.position = "relative";
                panelWrapper.style.height = "0px";
                dfn.insertAdjacentElement("afterend", panelWrapper);
                dfn.setAttribute('role', 'button');
                dfn.setAttribute('aria-expanded', 'false')
                dfn.tabIndex = 0;
                dfn.classList.add('has-dfn-panel');
                dfn.addEventListener('click', (event) => {
                    showDfnPanel(dfnPanel, dfn);
                    event.stopPropagation();
                });
                dfn.addEventListener('keypress', (event) => {
                    const kc = event.keyCode;
                    // 32->Space, 13->Enter
                    if (kc == 32 || kc == 13) {
                        toggleDfnPanel(dfnPanel, dfn);
                        event.stopPropagation();
                        event.preventDefault();
                    }
                });

                dfnPanel.addEventListener('click', (event) => {
                    if (event.target.nodeName == 'A') {
                        pinDfnPanel(dfnPanel);
                    }
                    event.stopPropagation();
                });

                dfnPanel.addEventListener('keydown', (event) => {
                    if (event.keyCode == 27) { // Escape key
                        hideDfnPanel(dfnPanel, dfn);
                        event.stopPropagation();
                        event.preventDefault();
                    }
                })
            }
        }
    </script>
    <script>/* Boilerplate: script-dfn-panel-json */
        window.dfnpanelData = {};
        window.dfnpanelData['9cd25054'] = { "dfnID": "9cd25054", "url": "https://drafts.csswg.org/css-cascade-5/#computed-value", "dfnText": "computed value", "refSections": [{ "refs": [{ "id": "ref-for-computed-value" }, { "id": "ref-for-computed-value\u2460" }, { "id": "ref-for-computed-value\u2461" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['66498315'] = { "dfnID": "66498315", "url": "https://drafts.csswg.org/css-display-3/#valdef-display-flex", "dfnText": "flex", "refSections": [{ "refs": [{ "id": "ref-for-valdef-display-flex" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['a555386f'] = { "dfnID": "a555386f", "url": "https://drafts.csswg.org/css-display-3/#valdef-display-grid", "dfnText": "grid", "refSections": [{ "refs": [{ "id": "ref-for-valdef-display-grid" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['bb886fc6'] = { "dfnID": "bb886fc6", "url": "https://drafts.csswg.org/css-display-4/#valdef-display-block", "dfnText": "block", "refSections": [{ "refs": [{ "id": "ref-for-valdef-display-block" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['e7f0dd6c'] = { "dfnID": "e7f0dd6c", "url": "https://drafts.csswg.org/css-display-4/#propdef-display", "dfnText": "display", "refSections": [{ "refs": [{ "id": "ref-for-propdef-display" }, { "id": "ref-for-propdef-display\u2460" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['607244fc'] = { "dfnID": "607244fc", "url": "https://drafts.csswg.org/css-display-4/#valdef-display-flow-root", "dfnText": "flow-root", "refSections": [{ "refs": [{ "id": "ref-for-valdef-display-flow-root" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['96626f55'] = { "dfnID": "96626f55", "url": "https://drafts.csswg.org/css-display-4/#valdef-display-list-item", "dfnText": "list-item", "refSections": [{ "refs": [{ "id": "ref-for-valdef-display-list-item" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['55e8f5de'] = { "dfnID": "55e8f5de", "url": "https://drafts.csswg.org/css-display-4/#valdef-display-none", "dfnText": "none", "refSections": [{ "refs": [{ "id": "ref-for-valdef-display-none" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['abb2bed7'] = { "dfnID": "abb2bed7", "url": "https://drafts.csswg.org/css-display-4/#valdef-display-table", "dfnText": "table", "refSections": [{ "refs": [{ "id": "ref-for-valdef-display-table" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['12f8fb07'] = { "dfnID": "12f8fb07", "url": "https://drafts.csswg.org/css-display-4/#propdef-visibility", "dfnText": "visibility", "refSections": [{ "refs": [{ "id": "ref-for-propdef-visibility" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['6420cb11'] = { "dfnID": "6420cb11", "url": "https://drafts.csswg.org/css-display-4/#valdef-visibility-visible", "dfnText": "visible", "refSections": [{ "refs": [{ "id": "ref-for-valdef-visibility-visible" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['2cbb079e'] = { "dfnID": "2cbb079e", "url": "https://drafts.csswg.org/cssom-view-1/#scroll-a-target-into-view", "dfnText": "scroll a target into view", "refSections": [{ "refs": [{ "id": "ref-for-scroll-a-target-into-view" }], "title": "3.4.1. Invoking Text Directives" }], "external": true };
        window.dfnpanelData['85394472'] = { "dfnID": "85394472", "url": "https://dom.spec.whatwg.org/#document", "dfnText": "Document", "refSections": [{ "refs": [{ "id": "ref-for-document" }, { "id": "ref-for-document\u2460" }], "title": "3.9. Feature Detectability" }], "external": true };
        window.dfnpanelData['597088f0'] = { "dfnID": "597088f0", "url": "https://dom.spec.whatwg.org/#text", "dfnText": "Text", "refSections": [{ "refs": [{ "id": "ref-for-text" }, { "id": "ref-for-text\u2460" }, { "id": "ref-for-text\u2461" }, { "id": "ref-for-text\u2462" }, { "id": "ref-for-text\u2463" }, { "id": "ref-for-text\u2464" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['4fef809c'] = { "dfnID": "4fef809c", "url": "https://dom.spec.whatwg.org/#concept-range-bp-after", "dfnText": "after", "refSections": [{ "refs": [{ "id": "ref-for-concept-range-bp-after" }, { "id": "ref-for-concept-range-bp-after\u2460" }, { "id": "ref-for-concept-range-bp-after\u2461" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['8a3e6de2'] = { "dfnID": "8a3e6de2", "url": "https://dom.spec.whatwg.org/#concept-range-bp", "dfnText": "boundary point", "refSections": [{ "refs": [{ "id": "ref-for-concept-range-bp" }, { "id": "ref-for-concept-range-bp\u2460" }, { "id": "ref-for-concept-range-bp\u2461" }, { "id": "ref-for-concept-range-bp\u2462" }, { "id": "ref-for-concept-range-bp\u2463" }, { "id": "ref-for-concept-range-bp\u2464" }, { "id": "ref-for-concept-range-bp\u2465" }, { "id": "ref-for-concept-range-bp\u2466" }, { "id": "ref-for-concept-range-bp\u2467" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['8aac8409'] = { "dfnID": "8aac8409", "url": "https://dom.spec.whatwg.org/#range-collapsed", "dfnText": "collapsed", "refSections": [{ "refs": [{ "id": "ref-for-range-collapsed" }, { "id": "ref-for-range-collapsed\u2460" }, { "id": "ref-for-range-collapsed\u2461" }, { "id": "ref-for-range-collapsed\u2462" }, { "id": "ref-for-range-collapsed\u2463" }, { "id": "ref-for-range-collapsed\u2464" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['3f23ec71'] = { "dfnID": "3f23ec71", "url": "https://dom.spec.whatwg.org/#concept-document-content-type", "dfnText": "content type", "refSections": [{ "refs": [{ "id": "ref-for-concept-document-content-type" }], "title": "3.5.4. Restricting the Text Fragment" }], "external": true };
        window.dfnpanelData['212ee1f7'] = { "dfnID": "212ee1f7", "url": "https://dom.spec.whatwg.org/#concept-cd-data", "dfnText": "data", "refSections": [{ "refs": [{ "id": "ref-for-concept-cd-data" }, { "id": "ref-for-concept-cd-data\u2460" }, { "id": "ref-for-concept-cd-data\u2461" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['cefd9ec1'] = { "dfnID": "cefd9ec1", "url": "https://dom.spec.whatwg.org/#concept-doctype", "dfnText": "doctype", "refSections": [{ "refs": [{ "id": "ref-for-concept-doctype" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['a973e0fe'] = { "dfnID": "a973e0fe", "url": "https://dom.spec.whatwg.org/#concept-document", "dfnText": "document", "refSections": [{ "refs": [{ "id": "ref-for-concept-document" }], "title": "3.3.2. Applying directives to a document" }, { "refs": [{ "id": "ref-for-concept-document\u2460" }], "title": "3.5.3. Search Timing" }, { "refs": [{ "id": "ref-for-concept-document\u2461" }, { "id": "ref-for-concept-document\u2462" }, { "id": "ref-for-concept-document\u2463" }, { "id": "ref-for-concept-document\u2464" }, { "id": "ref-for-concept-document\u2465" }, { "id": "ref-for-concept-document\u2466" }], "title": "3.5.4. Restricting the Text Fragment" }, { "refs": [{ "id": "ref-for-concept-document\u2467" }, { "id": "ref-for-concept-document\u2468" }], "title": "3.6.1. Finding Ranges in a Document" }, { "refs": [{ "id": "ref-for-concept-document\u2460\u24ea" }, { "id": "ref-for-concept-document\u2460\u2460" }], "title": "3.8. Document Policy Integration" }], "external": true };
        window.dfnpanelData['2f0ba72c'] = { "dfnID": "2f0ba72c", "url": "https://dom.spec.whatwg.org/#document-element", "dfnText": "document element", "refSections": [{ "refs": [{ "id": "ref-for-document-element" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['27d9b7ea'] = { "dfnID": "27d9b7ea", "url": "https://dom.spec.whatwg.org/#concept-element", "dfnText": "element", "refSections": [{ "refs": [{ "id": "ref-for-concept-element" }, { "id": "ref-for-concept-element\u2460" }], "title": "3.4.1. Invoking Text Directives" }, { "refs": [{ "id": "ref-for-concept-element\u2461" }], "title": "3.6. Navigating to a Text Fragment" }, { "refs": [{ "id": "ref-for-concept-element\u2462" }, { "id": "ref-for-concept-element\u2463" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['5bbf7dec'] = { "dfnID": "5bbf7dec", "url": "https://dom.spec.whatwg.org/#concept-range-end", "dfnText": "end", "refSections": [{ "refs": [{ "id": "ref-for-concept-range-end" }, { "id": "ref-for-concept-range-end\u2460" }, { "id": "ref-for-concept-range-end\u2461" }, { "id": "ref-for-concept-range-end\u2462" }, { "id": "ref-for-concept-range-end\u2463" }, { "id": "ref-for-concept-range-end\u2464" }, { "id": "ref-for-concept-range-end\u2465" }, { "id": "ref-for-concept-range-end\u2466" }, { "id": "ref-for-concept-range-end\u2467" }, { "id": "ref-for-concept-range-end\u2468" }, { "id": "ref-for-concept-range-end\u2460\u24ea" }, { "id": "ref-for-concept-range-end\u2460\u2460" }, { "id": "ref-for-concept-range-end\u2460\u2461" }, { "id": "ref-for-concept-range-end\u2460\u2462" }, { "id": "ref-for-concept-range-end\u2460\u2463" }, { "id": "ref-for-concept-range-end\u2460\u2464" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['3edd98b4'] = { "dfnID": "3edd98b4", "url": "https://dom.spec.whatwg.org/#concept-range-end-node", "dfnText": "end node", "refSections": [{ "refs": [{ "id": "ref-for-concept-range-end-node" }], "title": "3.4.1. Invoking Text Directives" }, { "refs": [{ "id": "ref-for-concept-range-end-node\u2460" }], "title": "3.5.4. Restricting the Text Fragment" }, { "refs": [{ "id": "ref-for-concept-range-end-node\u2461" }, { "id": "ref-for-concept-range-end-node\u2462" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['203b148b'] = { "dfnID": "203b148b", "url": "https://dom.spec.whatwg.org/#concept-range-end-offset", "dfnText": "end offset", "refSections": [{ "refs": [{ "id": "ref-for-concept-range-end-offset" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['6fba6744'] = { "dfnID": "6fba6744", "url": "https://dom.spec.whatwg.org/#concept-tree-following", "dfnText": "following", "refSections": [{ "refs": [{ "id": "ref-for-concept-tree-following" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['5d233601'] = { "dfnID": "5d233601", "url": "https://dom.spec.whatwg.org/#concept-documentfragment-host", "dfnText": "host", "refSections": [{ "refs": [{ "id": "ref-for-concept-documentfragment-host" }], "title": "3.6. Navigating to a Text Fragment" }], "external": true };
        window.dfnpanelData['5e8d5f81'] = { "dfnID": "5e8d5f81", "url": "https://dom.spec.whatwg.org/#concept-node-length", "dfnText": "length", "refSections": [{ "refs": [{ "id": "ref-for-concept-node-length" }, { "id": "ref-for-concept-node-length\u2460" }, { "id": "ref-for-concept-node-length\u2461" }, { "id": "ref-for-concept-node-length\u2462" }, { "id": "ref-for-concept-node-length\u2463" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['d462b34f'] = { "dfnID": "d462b34f", "url": "https://dom.spec.whatwg.org/#boundary-point-node", "dfnText": "node", "refSections": [{ "refs": [{ "id": "ref-for-boundary-point-node" }, { "id": "ref-for-boundary-point-node\u2460" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['5216e1a0'] = { "dfnID": "5216e1a0", "url": "https://dom.spec.whatwg.org/#concept-node-document", "dfnText": "node document", "refSections": [{ "refs": [{ "id": "ref-for-concept-node-document" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['c62cd7cf'] = { "dfnID": "c62cd7cf", "url": "https://dom.spec.whatwg.org/#concept-document-origin", "dfnText": "origin", "refSections": [{ "refs": [{ "id": "ref-for-concept-document-origin" }], "title": "3.5.4. Restricting the Text Fragment" }], "external": true };
        window.dfnpanelData['d729a9ff'] = { "dfnID": "d729a9ff", "url": "https://dom.spec.whatwg.org/#concept-tree-parent", "dfnText": "parent", "refSections": [{ "refs": [{ "id": "ref-for-concept-tree-parent" }], "title": "3.4.1. Invoking Text Directives" }, { "refs": [{ "id": "ref-for-concept-tree-parent\u2460" }], "title": "3.6. Navigating to a Text Fragment" }, { "refs": [{ "id": "ref-for-concept-tree-parent\u2461" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['5afeceea'] = { "dfnID": "5afeceea", "url": "https://dom.spec.whatwg.org/#parent-element", "dfnText": "parent element", "refSections": [{ "refs": [{ "id": "ref-for-parent-element" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['8044ee41'] = { "dfnID": "8044ee41", "url": "https://dom.spec.whatwg.org/#concept-range", "dfnText": "range", "refSections": [{ "refs": [{ "id": "ref-for-concept-range" }, { "id": "ref-for-concept-range\u2460" }, { "id": "ref-for-concept-range\u2461" }, { "id": "ref-for-concept-range\u2462" }, { "id": "ref-for-concept-range\u2463" }, { "id": "ref-for-concept-range\u2464" }, { "id": "ref-for-concept-range\u2465" }, { "id": "ref-for-concept-range\u2466" }, { "id": "ref-for-concept-range\u2467" }], "title": "3.4.1. Invoking Text Directives" }, { "refs": [{ "id": "ref-for-concept-range\u2468" }, { "id": "ref-for-concept-range\u2460\u24ea" }], "title": "3.5.4. Restricting the Text Fragment" }, { "refs": [{ "id": "ref-for-concept-range\u2460\u2460" }], "title": "3.6. Navigating to a Text Fragment" }, { "refs": [{ "id": "ref-for-concept-range\u2460\u2461" }, { "id": "ref-for-concept-range\u2460\u2462" }, { "id": "ref-for-concept-range\u2460\u2463" }, { "id": "ref-for-concept-range\u2460\u2464" }, { "id": "ref-for-concept-range\u2460\u2465" }, { "id": "ref-for-concept-range\u2460\u2466" }, { "id": "ref-for-concept-range\u2460\u2467" }, { "id": "ref-for-concept-range\u2460\u2468" }, { "id": "ref-for-concept-range\u2461\u24ea" }, { "id": "ref-for-concept-range\u2461\u2460" }, { "id": "ref-for-concept-range\u2461\u2461" }, { "id": "ref-for-concept-range\u2461\u2462" }, { "id": "ref-for-concept-range\u2461\u2463" }, { "id": "ref-for-concept-range\u2461\u2464" }, { "id": "ref-for-concept-range\u2461\u2465" }, { "id": "ref-for-concept-range\u2461\u2466" }, { "id": "ref-for-concept-range\u2461\u2467" }, { "id": "ref-for-concept-range\u2461\u2468" }, { "id": "ref-for-concept-range\u2462\u24ea" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['3fcc582f'] = { "dfnID": "3fcc582f", "url": "https://dom.spec.whatwg.org/#concept-shadow-root", "dfnText": "shadow root", "refSections": [{ "refs": [{ "id": "ref-for-concept-shadow-root" }], "title": "3.6. Navigating to a Text Fragment" }], "external": true };
        window.dfnpanelData['8f378588'] = { "dfnID": "8f378588", "url": "https://dom.spec.whatwg.org/#concept-shadow-including-ancestor", "dfnText": "shadow-including ancestor", "refSections": [{ "refs": [{ "id": "ref-for-concept-shadow-including-ancestor" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['fd32e3c9'] = { "dfnID": "fd32e3c9", "url": "https://dom.spec.whatwg.org/#concept-shadow-including-descendant", "dfnText": "shadow-including descendant", "refSections": [{ "refs": [{ "id": "ref-for-concept-shadow-including-descendant" }, { "id": "ref-for-concept-shadow-including-descendant\u2460" }, { "id": "ref-for-concept-shadow-including-descendant\u2461" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['3d6a3d36'] = { "dfnID": "3d6a3d36", "url": "https://dom.spec.whatwg.org/#concept-shadow-including-inclusive-ancestor", "dfnText": "shadow-including inclusive ancestor", "refSections": [{ "refs": [{ "id": "ref-for-concept-shadow-including-inclusive-ancestor" }], "title": "3.6. Navigating to a Text Fragment" }], "external": true };
        window.dfnpanelData['fefa5851'] = { "dfnID": "fefa5851", "url": "https://dom.spec.whatwg.org/#concept-shadow-including-tree-order", "dfnText": "shadow-including tree order", "refSections": [{ "refs": [{ "id": "ref-for-concept-shadow-including-tree-order" }, { "id": "ref-for-concept-shadow-including-tree-order\u2460" }, { "id": "ref-for-concept-shadow-including-tree-order\u2461" }, { "id": "ref-for-concept-shadow-including-tree-order\u2462" }, { "id": "ref-for-concept-shadow-including-tree-order\u2463" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['936c50ab'] = { "dfnID": "936c50ab", "url": "https://dom.spec.whatwg.org/#concept-range-start", "dfnText": "start", "refSections": [{ "refs": [{ "id": "ref-for-concept-range-start" }, { "id": "ref-for-concept-range-start\u2460" }, { "id": "ref-for-concept-range-start\u2461" }, { "id": "ref-for-concept-range-start\u2462" }, { "id": "ref-for-concept-range-start\u2463" }, { "id": "ref-for-concept-range-start\u2464" }, { "id": "ref-for-concept-range-start\u2465" }, { "id": "ref-for-concept-range-start\u2466" }, { "id": "ref-for-concept-range-start\u2467" }, { "id": "ref-for-concept-range-start\u2468" }, { "id": "ref-for-concept-range-start\u2460\u24ea" }, { "id": "ref-for-concept-range-start\u2460\u2460" }, { "id": "ref-for-concept-range-start\u2460\u2461" }, { "id": "ref-for-concept-range-start\u2460\u2462" }, { "id": "ref-for-concept-range-start\u2460\u2463" }, { "id": "ref-for-concept-range-start\u2460\u2464" }, { "id": "ref-for-concept-range-start\u2460\u2465" }, { "id": "ref-for-concept-range-start\u2460\u2466" }, { "id": "ref-for-concept-range-start\u2460\u2467" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['6c88f67e'] = { "dfnID": "6c88f67e", "url": "https://dom.spec.whatwg.org/#concept-range-start-node", "dfnText": "start node", "refSections": [{ "refs": [{ "id": "ref-for-concept-range-start-node" }], "title": "3.4.1. Invoking Text Directives" }, { "refs": [{ "id": "ref-for-concept-range-start-node\u2460" }], "title": "3.5.4. Restricting the Text Fragment" }, { "refs": [{ "id": "ref-for-concept-range-start-node\u2461" }, { "id": "ref-for-concept-range-start-node\u2462" }, { "id": "ref-for-concept-range-start-node\u2463" }, { "id": "ref-for-concept-range-start-node\u2464" }, { "id": "ref-for-concept-range-start-node\u2465" }, { "id": "ref-for-concept-range-start-node\u2466" }, { "id": "ref-for-concept-range-start-node\u2467" }, { "id": "ref-for-concept-range-start-node\u2468" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['683b1507'] = { "dfnID": "683b1507", "url": "https://dom.spec.whatwg.org/#concept-range-start-offset", "dfnText": "start offset", "refSections": [{ "refs": [{ "id": "ref-for-concept-range-start-offset" }, { "id": "ref-for-concept-range-start-offset\u2460" }, { "id": "ref-for-concept-range-start-offset\u2461" }, { "id": "ref-for-concept-range-start-offset\u2462" }, { "id": "ref-for-concept-range-start-offset\u2463" }, { "id": "ref-for-concept-range-start-offset\u2464" }, { "id": "ref-for-concept-range-start-offset\u2465" }, { "id": "ref-for-concept-range-start-offset\u2466" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['c9f15d91'] = { "dfnID": "c9f15d91", "url": "https://dom.spec.whatwg.org/#concept-cd-substring", "dfnText": "substring data", "refSections": [{ "refs": [{ "id": "ref-for-concept-cd-substring" }, { "id": "ref-for-concept-cd-substring\u2460" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['347e8fe9'] = { "dfnID": "347e8fe9", "url": "https://dom.spec.whatwg.org/#concept-document-url", "dfnText": "url", "refSections": [{ "refs": [{ "id": "ref-for-concept-document-url" }], "title": "3.3.1. Extracting the fragment directive" }], "external": true };
        window.dfnpanelData['a3033be5'] = { "dfnID": "a3033be5", "url": "https://encoding.spec.whatwg.org/#utf-8-decode-without-bom", "dfnText": "utf-8 decode without bom", "refSections": [{ "refs": [{ "id": "ref-for-utf-8-decode-without-bom" }], "title": "3.4. Text Directives" }], "external": true };
        window.dfnpanelData['55213b5b'] = { "dfnID": "55213b5b", "url": "https://fetch.spec.whatwg.org/#concept-request", "dfnText": "request", "refSections": [{ "refs": [{ "id": "ref-for-concept-request" }, { "id": "ref-for-concept-request\u2460" }, { "id": "ref-for-concept-request\u2461" }, { "id": "ref-for-concept-request\u2462" }], "title": "3.5.4. Restricting the Text Fragment" }], "external": true };
        window.dfnpanelData['fe2a6718'] = { "dfnID": "fe2a6718", "url": "https://html.spec.whatwg.org/multipage/media.html#htmlaudioelement", "dfnText": "HTMLAudioElement", "refSections": [{ "refs": [{ "id": "ref-for-htmlaudioelement" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['10e25f42'] = { "dfnID": "10e25f42", "url": "https://html.spec.whatwg.org/multipage/iframe-embed-object.html#htmliframeelement", "dfnText": "HTMLIFrameElement", "refSections": [{ "refs": [{ "id": "ref-for-htmliframeelement" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['c5891539'] = { "dfnID": "c5891539", "url": "https://html.spec.whatwg.org/multipage/embedded-content.html#htmlimageelement", "dfnText": "HTMLImageElement", "refSections": [{ "refs": [{ "id": "ref-for-htmlimageelement" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['cc59b66b'] = { "dfnID": "cc59b66b", "url": "https://html.spec.whatwg.org/multipage/form-elements.html#htmlmeterelement", "dfnText": "HTMLMeterElement", "refSections": [{ "refs": [{ "id": "ref-for-htmlmeterelement" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['59ce5887'] = { "dfnID": "59ce5887", "url": "https://html.spec.whatwg.org/multipage/iframe-embed-object.html#htmlobjectelement", "dfnText": "HTMLObjectElement", "refSections": [{ "refs": [{ "id": "ref-for-htmlobjectelement" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['fcadc50c'] = { "dfnID": "fcadc50c", "url": "https://html.spec.whatwg.org/multipage/form-elements.html#htmlprogresselement", "dfnText": "HTMLProgressElement", "refSections": [{ "refs": [{ "id": "ref-for-htmlprogresselement" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['ec4838d8'] = { "dfnID": "ec4838d8", "url": "https://html.spec.whatwg.org/multipage/scripting.html#htmlscriptelement", "dfnText": "HTMLScriptElement", "refSections": [{ "refs": [{ "id": "ref-for-htmlscriptelement" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['aa8746c3'] = { "dfnID": "aa8746c3", "url": "https://html.spec.whatwg.org/multipage/semantics.html#htmlstyleelement", "dfnText": "HTMLStyleElement", "refSections": [{ "refs": [{ "id": "ref-for-htmlstyleelement" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['f57f330b'] = { "dfnID": "f57f330b", "url": "https://html.spec.whatwg.org/multipage/media.html#htmlvideoelement", "dfnText": "HTMLVideoElement", "refSections": [{ "refs": [{ "id": "ref-for-htmlvideoelement" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['78492a07'] = { "dfnID": "78492a07", "url": "https://html.spec.whatwg.org/multipage/nav-history-apis.html#hashchangeevent", "dfnText": "HashChangeEvent", "refSections": [{ "refs": [{ "id": "ref-for-hashchangeevent" }], "title": "3.3.1. Extracting the fragment directive" }], "external": true };
        window.dfnpanelData['cc549724'] = { "dfnID": "cc549724", "url": "https://html.spec.whatwg.org/multipage/nav-history-apis.html#location", "dfnText": "Location", "refSections": [{ "refs": [{ "id": "ref-for-location" }], "title": "3.3.1. Extracting the fragment directive" }], "external": true };
        window.dfnpanelData['35972864'] = { "dfnID": "35972864", "url": "https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document", "dfnText": "active document", "refSections": [{ "refs": [{ "id": "ref-for-nav-document" }], "title": "3.3.1. Extracting the fragment directive" }, { "refs": [{ "id": "ref-for-nav-document\u2460" }, { "id": "ref-for-nav-document\u2461" }, { "id": "ref-for-nav-document\u2462" }, { "id": "ref-for-nav-document\u2463" }], "title": "3.5.4. Restricting the Text Fragment" }], "external": true };
        window.dfnpanelData['3c75104d'] = { "dfnID": "3c75104d", "url": "https://html.spec.whatwg.org/multipage/browsing-the-web.html#apply-the-history-step", "dfnText": "apply the history step", "refSections": [{ "refs": [{ "id": "ref-for-apply-the-history-step" }], "title": "3.5.4. Restricting the Text Fragment" }], "external": true };
        window.dfnpanelData['1c1db69e'] = { "dfnID": "1c1db69e", "url": "https://html.spec.whatwg.org/multipage/browsing-the-web.html#apply-the-push%2Freplace-history-step", "dfnText": "apply the push/replace history step", "refSections": [{ "refs": [{ "id": "ref-for-apply-the-push%2Freplace-history-step" }], "title": "3.5.4. Restricting the Text Fragment" }], "external": true };
        window.dfnpanelData['f8434dee'] = { "dfnID": "f8434dee", "url": "https://html.spec.whatwg.org/multipage/rendering.html#being-rendered", "dfnText": "being rendered", "refSections": [{ "refs": [{ "id": "ref-for-being-rendered" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['3b2ff63e'] = { "dfnID": "3b2ff63e", "url": "https://html.spec.whatwg.org/multipage/document-sequences.html#concept-document-bc", "dfnText": "browsing context", "refSections": [{ "refs": [{ "id": "ref-for-concept-document-bc" }], "title": "3.5.4. Restricting the Text Fragment" }], "external": true };
        window.dfnpanelData['b0b49d3c'] = { "dfnID": "b0b49d3c", "url": "https://html.spec.whatwg.org/multipage/document-sequences.html#browsing-context-set", "dfnText": "browsing context set", "refSections": [{ "refs": [{ "id": "ref-for-browsing-context-set" }], "title": "3.5.4. Restricting the Text Fragment" }], "external": true };
        window.dfnpanelData['07ad3048'] = { "dfnID": "07ad3048", "url": "https://html.spec.whatwg.org/multipage/browsing-the-web.html#create-navigation-params-by-fetching", "dfnText": "create navigation params by fetching", "refSections": [{ "refs": [{ "id": "fc0e1ad00" }], "title": "3.3.1. Extracting the fragment directive" }, { "refs": [{ "id": "ref-for-create-navigation-params-by-fetching" }, { "id": "ref-for-create-navigation-params-by-fetching\u2460" }], "title": "3.5.4. Restricting the Text Fragment" }], "external": true };
        window.dfnpanelData['65393af9'] = { "dfnID": "65393af9", "url": "https://html.spec.whatwg.org/multipage/browsing-the-web.html#she-document", "dfnText": "document", "refSections": [{ "refs": [{ "id": "ref-for-she-document" }], "title": "3.5.4. Restricting the Text Fragment" }], "external": true };
        window.dfnpanelData['092de955'] = { "dfnID": "092de955", "url": "https://html.spec.whatwg.org/multipage/browsing-the-web.html#she-document-state", "dfnText": "document state", "refSections": [{ "refs": [{ "id": "ref-for-she-document-state" }], "title": "3.5.4. Restricting the Text Fragment" }], "external": true };
        window.dfnpanelData['7f118064'] = { "dfnID": "7f118064", "url": "https://html.spec.whatwg.org/multipage/browsing-the-web.html#finalize-a-cross-document-navigation", "dfnText": "finalize a cross-document navigation", "refSections": [{ "refs": [{ "id": "ref-for-finalize-a-cross-document-navigation" }], "title": "3.5.4. Restricting the Text Fragment" }], "external": true };
        window.dfnpanelData['40a1c717'] = { "dfnID": "40a1c717", "url": "https://html.spec.whatwg.org/multipage/browsers.html#tlbc-group", "dfnText": "group", "refSections": [{ "refs": [{ "id": "ref-for-tlbc-group" }], "title": "3.5.4. Restricting the Text Fragment" }], "external": true };
        window.dfnpanelData['2895d75d'] = { "dfnID": "2895d75d", "url": "https://html.spec.whatwg.org/multipage/browsing-the-web.html#document-state-initiator-origin", "dfnText": "initiator origin", "refSections": [{ "refs": [{ "id": "ref-for-document-state-initiator-origin" }], "title": "3.5.4. Restricting the Text Fragment" }], "external": true };
        window.dfnpanelData['d4dbbbf0'] = { "dfnID": "d4dbbbf0", "url": "https://html.spec.whatwg.org/multipage/dom.html#language", "dfnText": "language", "refSections": [{ "refs": [{ "id": "ref-for-language" }, { "id": "ref-for-language\u2460" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['b07164ad'] = { "dfnID": "b07164ad", "url": "https://html.spec.whatwg.org/multipage/form-elements.html#attr-select-multiple", "dfnText": "multiple", "refSections": [{ "refs": [{ "id": "ref-for-attr-select-multiple" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['2594e562'] = { "dfnID": "2594e562", "url": "https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigate", "dfnText": "navigate", "refSections": [{ "refs": [{ "id": "ref-for-navigate" }], "title": "3.3.1. Extracting the fragment directive" }, { "refs": [{ "id": "ref-for-navigate\u2460" }, { "id": "ref-for-navigate\u2461" }], "title": "3.5.4. Restricting the Text Fragment" }], "external": true };
        window.dfnpanelData['fffd9ca9'] = { "dfnID": "fffd9ca9", "url": "https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigate-fragid", "dfnText": "navigate to a fragment", "refSections": [{ "refs": [{ "id": "319d7c290" }, { "id": "319d7c291" }], "title": "3.3.1. Extracting the fragment directive" }, { "refs": [{ "id": "319d7c292" }], "title": "3.4.1. Invoking Text Directives" }, { "refs": [{ "id": "ref-for-navigate-fragid" }], "title": "3.5.4. Restricting the Text Fragment" }], "external": true };
        window.dfnpanelData['4437edc6'] = { "dfnID": "4437edc6", "url": "https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigation-params", "dfnText": "navigation params", "refSections": [{ "refs": [{ "id": "ref-for-navigation-params" }], "title": "3.5.4. Restricting the Text Fragment" }], "external": true };
        window.dfnpanelData['13dd6cae'] = { "dfnID": "13dd6cae", "url": "https://html.spec.whatwg.org/multipage/document-sequences.html#node-navigable", "dfnText": "node navigable", "refSections": [{ "refs": [{ "id": "ref-for-node-navigable" }], "title": "3.5.4. Restricting the Text Fragment" }], "external": true };
        window.dfnpanelData['086e3aff'] = { "dfnID": "086e3aff", "url": "https://html.spec.whatwg.org/multipage/browsers.html#concept-origin", "dfnText": "origin", "refSections": [{ "refs": [{ "id": "ref-for-concept-origin" }, { "id": "ref-for-concept-origin\u2460" }], "title": "3.5.4. Restricting the Text Fragment" }], "external": true };
        window.dfnpanelData['1bba3db7'] = { "dfnID": "1bba3db7", "url": "https://html.spec.whatwg.org/multipage/document-sequences.html#nav-parent", "dfnText": "parent", "refSections": [{ "refs": [{ "id": "ref-for-nav-parent" }], "title": "3.5.4. Restricting the Text Fragment" }], "external": true };
        window.dfnpanelData['8b87b428'] = { "dfnID": "8b87b428", "url": "https://html.spec.whatwg.org/multipage/browsing-the-web.html#restore-persisted-state", "dfnText": "restore persisted state", "refSections": [{ "refs": [{ "id": "ref-for-restore-persisted-state" }], "title": "3.5.5. Restricting Scroll on Load" }, { "refs": [{ "id": "ref-for-restore-persisted-state\u2460" }], "title": "3.8. Document Policy Integration" }], "external": true };
        window.dfnpanelData['7393da89'] = { "dfnID": "7393da89", "url": "https://html.spec.whatwg.org/multipage/browsers.html#same-origin", "dfnText": "same origin", "refSections": [{ "refs": [{ "id": "ref-for-same-origin" }], "title": "3.5.4. Restricting the Text Fragment" }], "external": true };
        window.dfnpanelData['3f2e859c'] = { "dfnID": "3f2e859c", "url": "https://html.spec.whatwg.org/multipage/browsing-the-web.html#scroll-to-the-fragment-identifier", "dfnText": "scroll to the fragment", "refSections": [{ "refs": [{ "id": "ref-for-scroll-to-the-fragment-identifier" }, { "id": "ref-for-scroll-to-the-fragment-identifier\u2460" }], "title": "3.4.1. Invoking Text Directives" }, { "refs": [{ "id": "ref-for-scroll-to-the-fragment-identifier\u2461" }, { "id": "ref-for-scroll-to-the-fragment-identifier\u2462" }], "title": "3.5.4. Restricting the Text Fragment" }, { "refs": [{ "id": "ref-for-scroll-to-the-fragment-identifier\u2463" }], "title": "3.8. Document Policy Integration" }], "external": true };
        window.dfnpanelData['85188fb3'] = { "dfnID": "85188fb3", "url": "https://html.spec.whatwg.org/multipage/form-elements.html#the-select-element", "dfnText": "select", "refSections": [{ "refs": [{ "id": "ref-for-the-select-element" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['c3ae9e6a'] = { "dfnID": "c3ae9e6a", "url": "https://html.spec.whatwg.org/multipage/parsing.html#serializes-as-void", "dfnText": "serializes as void", "refSections": [{ "refs": [{ "id": "ref-for-serializes-as-void" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['8a051c9f'] = { "dfnID": "8a051c9f", "url": "https://html.spec.whatwg.org/multipage/browsing-the-web.html#try-to-scroll-to-the-fragment", "dfnText": "try to scroll to the fragment", "refSections": [{ "refs": [{ "id": "44bd3acf0" }], "title": "3.4.1. Invoking Text Directives" }, { "refs": [{ "id": "ref-for-try-to-scroll-to-the-fragment" }], "title": "3.5.4. Restricting the Text Fragment" }, { "refs": [{ "id": "ref-for-try-to-scroll-to-the-fragment\u2460" }], "title": "3.7. Indicating The Text Match" }], "external": true };
        window.dfnpanelData['5c1d019b'] = { "dfnID": "5c1d019b", "url": "https://html.spec.whatwg.org/multipage/browsing-the-web.html#update-document-for-history-step-application", "dfnText": "update document for history step application", "refSections": [{ "refs": [{ "id": "ref-for-update-document-for-history-step-application" }], "title": "3.3.2. Applying directives to a document" }, { "refs": [{ "id": "ref-for-update-document-for-history-step-application\u2460" }, { "id": "ref-for-update-document-for-history-step-application\u2461" }], "title": "3.5.4. Restricting the Text Fragment" }, { "refs": [{ "id": "ref-for-update-document-for-history-step-application\u2462" }], "title": "3.5.5. Restricting Scroll on Load" }], "external": true };
        window.dfnpanelData['34d2343e'] = { "dfnID": "34d2343e", "url": "https://html.spec.whatwg.org/multipage/browsing-the-web.html#user-navigation-involvement", "dfnText": "user navigation involvement", "refSections": [{ "refs": [{ "id": "ref-for-user-navigation-involvement" }, { "id": "ref-for-user-navigation-involvement\u2460" }, { "id": "ref-for-user-navigation-involvement\u2461" }, { "id": "ref-for-user-navigation-involvement\u2462" }], "title": "3.5.4. Restricting the Text Fragment" }], "external": true };
        window.dfnpanelData['53275e46'] = { "dfnID": "53275e46", "url": "https://infra.spec.whatwg.org/#list-append", "dfnText": "append", "refSections": [{ "refs": [{ "id": "ref-for-list-append" }], "title": "3.4. Text Directives" }, { "refs": [{ "id": "ref-for-list-append\u2460" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['2d5a2765'] = { "dfnID": "2d5a2765", "url": "https://infra.spec.whatwg.org/#ascii-string", "dfnText": "ascii string", "refSections": [{ "refs": [{ "id": "ref-for-ascii-string" }], "title": "3.3.1. Extracting the fragment directive" }, { "refs": [{ "id": "ref-for-ascii-string\u2460" }, { "id": "ref-for-ascii-string\u2461" }, { "id": "ref-for-ascii-string\u2462" }], "title": "3.4. Text Directives" }], "external": true };
        window.dfnpanelData['77b4c09a'] = { "dfnID": "77b4c09a", "url": "https://infra.spec.whatwg.org/#assert", "dfnText": "assert", "refSections": [{ "refs": [{ "id": "ref-for-assert" }, { "id": "ref-for-assert\u2460" }, { "id": "ref-for-assert\u2461" }], "title": "3.4. Text Directives" }, { "refs": [{ "id": "ref-for-assert\u2462" }, { "id": "ref-for-assert\u2463" }, { "id": "ref-for-assert\u2464" }, { "id": "ref-for-assert\u2465" }, { "id": "ref-for-assert\u2466" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['7b0d918d'] = { "dfnID": "7b0d918d", "url": "https://infra.spec.whatwg.org/#iteration-break", "dfnText": "break", "refSections": [{ "refs": [{ "id": "ref-for-iteration-break" }, { "id": "ref-for-iteration-break\u2460" }, { "id": "ref-for-iteration-break\u2461" }, { "id": "ref-for-iteration-break\u2462" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['915aff5e'] = { "dfnID": "915aff5e", "url": "https://infra.spec.whatwg.org/#code-point", "dfnText": "code point", "refSections": [{ "refs": [{ "id": "ref-for-code-point" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['4ef39030'] = { "dfnID": "4ef39030", "url": "https://infra.spec.whatwg.org/#string-code-point-length", "dfnText": "code point length", "refSections": [{ "refs": [{ "id": "ref-for-string-code-point-length" }], "title": "3.3.1. Extracting the fragment directive" }, { "refs": [{ "id": "ref-for-string-code-point-length\u2460" }], "title": "3.4. Text Directives" }], "external": true };
        window.dfnpanelData['bb1f9628'] = { "dfnID": "bb1f9628", "url": "https://infra.spec.whatwg.org/#code-point-substring", "dfnText": "code point substring", "refSections": [{ "refs": [{ "id": "ref-for-code-point-substring" }], "title": "3.4. Text Directives" }], "external": true };
        window.dfnpanelData['cfd05055'] = { "dfnID": "cfd05055", "url": "https://infra.spec.whatwg.org/#code-point-substring-by-positions", "dfnText": "code point substring by positions", "refSections": [{ "refs": [{ "id": "ref-for-code-point-substring-by-positions" }], "title": "3.3.1. Extracting the fragment directive" }], "external": true };
        window.dfnpanelData['b8906bbb'] = { "dfnID": "b8906bbb", "url": "https://infra.spec.whatwg.org/#code-point-substring-to-the-end-of-the-string", "dfnText": "code point substring to the end of the string", "refSections": [{ "refs": [{ "id": "ref-for-code-point-substring-to-the-end-of-the-string" }], "title": "3.3.1. Extracting the fragment directive" }, { "refs": [{ "id": "ref-for-code-point-substring-to-the-end-of-the-string\u2460" }, { "id": "ref-for-code-point-substring-to-the-end-of-the-string\u2461" }], "title": "3.4. Text Directives" }], "external": true };
        window.dfnpanelData['4a3bf5fb'] = { "dfnID": "4a3bf5fb", "url": "https://infra.spec.whatwg.org/#string-concatenate", "dfnText": "concatenate", "refSections": [{ "refs": [{ "id": "ref-for-string-concatenate" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['f937b7b6'] = { "dfnID": "f937b7b6", "url": "https://infra.spec.whatwg.org/#iteration-continue", "dfnText": "continue", "refSections": [{ "refs": [{ "id": "ref-for-iteration-continue" }], "title": "3.4. Text Directives" }, { "refs": [{ "id": "ref-for-iteration-continue\u2460" }, { "id": "ref-for-iteration-continue\u2461" }, { "id": "ref-for-iteration-continue\u2462" }, { "id": "ref-for-iteration-continue\u2463" }, { "id": "ref-for-iteration-continue\u2464" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['03afaf9c'] = { "dfnID": "03afaf9c", "url": "https://infra.spec.whatwg.org/#list-empty", "dfnText": "empty", "refSections": [{ "refs": [{ "id": "ref-for-list-empty" }, { "id": "ref-for-list-empty\u2460" }, { "id": "ref-for-list-empty\u2461" }], "title": "3.4. Text Directives" }], "external": true };
        window.dfnpanelData['9c05f1bf'] = { "dfnID": "9c05f1bf", "url": "https://infra.spec.whatwg.org/#string-ends-with", "dfnText": "ends with", "refSections": [{ "refs": [{ "id": "ref-for-string-ends-with" }], "title": "3.4. Text Directives" }], "external": true };
        window.dfnpanelData['16d07e10'] = { "dfnID": "16d07e10", "url": "https://infra.spec.whatwg.org/#list-iterate", "dfnText": "for each", "refSections": [{ "refs": [{ "id": "ref-for-list-iterate" }], "title": "3.4. Text Directives" }, { "refs": [{ "id": "ref-for-list-iterate\u2460" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['f052b1ea'] = { "dfnID": "f052b1ea", "url": "https://infra.spec.whatwg.org/#html-namespace", "dfnText": "html namespace", "refSections": [{ "refs": [{ "id": "ref-for-html-namespace" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['860300d4'] = { "dfnID": "860300d4", "url": "https://infra.spec.whatwg.org/#implementation-defined", "dfnText": "implementation-defined", "refSections": [{ "refs": [{ "id": "ref-for-implementation-defined" }], "title": "3.4.1. Invoking Text Directives" }], "external": true };
        window.dfnpanelData['0fa357c3'] = { "dfnID": "0fa357c3", "url": "https://infra.spec.whatwg.org/#string-length", "dfnText": "length", "refSections": [{ "refs": [{ "id": "ref-for-string-length" }, { "id": "ref-for-string-length\u2460" }, { "id": "ref-for-string-length\u2461" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['649608b9'] = { "dfnID": "649608b9", "url": "https://infra.spec.whatwg.org/#list", "dfnText": "list", "refSections": [{ "refs": [{ "id": "ref-for-list" }], "title": "3.3.2. Applying directives to a document" }, { "refs": [{ "id": "ref-for-list\u2460" }, { "id": "ref-for-list\u2461" }], "title": "3.4. Text Directives" }, { "refs": [{ "id": "ref-for-list\u2462" }], "title": "3.4.1. Invoking Text Directives" }, { "refs": [{ "id": "ref-for-list\u2463" }, { "id": "ref-for-list\u2464" }, { "id": "ref-for-list\u2465" }, { "id": "ref-for-list\u2466" }, { "id": "ref-for-list\u2467" }, { "id": "ref-for-list\u2468" }, { "id": "ref-for-list\u2460\u24ea" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": true };
        window.dfnpanelData['75bee4d5'] = { "dfnID": "75bee4d5", "url": "https://infra.spec.whatwg.org/#string-position-variable", "dfnText": "position variable", "refSections": [{ "refs": [{ "id": "ref-for-string-position-variable" }], "title": "3.3.1. Extracting the fragment directive" }], "external": true };
        window.dfnpanelData['0204d188'] = { "dfnID": "0204d188", "url": "https://infra.spec.whatwg.org/#list-size", "dfnText": "size", "refSections": [{ "refs": [{ "id": "ref-for-list-size" }, { "id": "ref-for-list-size\u2460" }, { "id": "ref-for-list-size\u2461" }], "title": "3.4. Text Directives" }], "external": true };
        window.dfnpanelData['54627f47'] = { "dfnID": "54627f47", "url": "https://infra.spec.whatwg.org/#string-starts-with", "dfnText": "starts with", "refSections": [{ "refs": [{ "id": "ref-for-string-starts-with" }, { "id": "ref-for-string-starts-with\u2460" }], "title": "3.4. Text Directives" }], "external": true };
        window.dfnpanelData['7a3dbdb1'] = { "dfnID": "7a3dbdb1", "url": "https://infra.spec.whatwg.org/#strictly-split", "dfnText": "strictly split a string", "refSections": [{ "refs": [{ "id": "ref-for-strictly-split" }, { "id": "ref-for-strictly-split\u2460" }], "title": "3.4. Text Directives" }], "external": true };
        window.dfnpanelData['0698d556'] = { "dfnID": "0698d556", "url": "https://infra.spec.whatwg.org/#string", "dfnText": "string", "refSections": [{ "refs": [{ "id": "ref-for-string" }], "title": "3.3.3. Fragment directive grammar" }, { "refs": [{ "id": "ref-for-string\u2460" }, { "id": "ref-for-string\u2461" }, { "id": "ref-for-string\u2462" }, { "id": "ref-for-string\u2463" }], "title": "3.4. Text Directives" }, { "refs": [{ "id": "ref-for-string\u2464" }], "title": "3.6.1. Finding Ranges in a Document" }, { "refs": [{ "id": "ref-for-string\u2465" }, { "id": "ref-for-string\u2466" }, { "id": "ref-for-string\u2467" }], "title": "3.6.2. Word Boundaries" }], "external": true };
        window.dfnpanelData['984221ca'] = { "dfnID": "984221ca", "url": "https://infra.spec.whatwg.org/#struct", "dfnText": "struct", "refSections": [{ "refs": [{ "id": "ref-for-struct" }], "title": "3.4. Text Directives" }], "external": true };
        window.dfnpanelData['7c195f8b'] = { "dfnID": "7c195f8b", "url": "https://mimesniff.spec.whatwg.org/#mime-type-essence", "dfnText": "essence", "refSections": [{ "refs": [{ "id": "ref-for-mime-type-essence" }], "title": "3.5.4. Restricting the Text Fragment" }], "external": true };
        window.dfnpanelData['16785ec4'] = { "dfnID": "16785ec4", "url": "https://mimesniff.spec.whatwg.org/#mime-type", "dfnText": "mime type", "refSections": [{ "refs": [{ "id": "ref-for-mime-type" }], "title": "3.5.4. Restricting the Text Fragment" }], "external": true };
        window.dfnpanelData['ed948033'] = { "dfnID": "ed948033", "url": "https://url.spec.whatwg.org/#concept-url-fragment", "dfnText": "fragment", "refSections": [{ "refs": [{ "id": "ref-for-concept-url-fragment" }], "title": "3.3. The Fragment Directive" }, { "refs": [{ "id": "ref-for-concept-url-fragment\u2460" }, { "id": "ref-for-concept-url-fragment\u2461" }], "title": "3.3.1. Extracting the fragment directive" }], "external": true };
        window.dfnpanelData['79fa146b'] = { "dfnID": "79fa146b", "url": "https://url.spec.whatwg.org/#fragment-percent-encode-set", "dfnText": "fragment percent-encode set", "refSections": [{ "refs": [{ "id": "ref-for-fragment-percent-encode-set" }], "title": "3.4. Text Directives" }], "external": true };
        window.dfnpanelData['8f69ce41'] = { "dfnID": "8f69ce41", "url": "https://url.spec.whatwg.org/#string-percent-decode", "dfnText": "percent-decode", "refSections": [{ "refs": [{ "id": "ref-for-string-percent-decode" }], "title": "3.4. Text Directives" }], "external": true };
        window.dfnpanelData['dcffbccd'] = { "dfnID": "dcffbccd", "url": "https://url.spec.whatwg.org/#concept-url", "dfnText": "url", "refSections": [{ "refs": [{ "id": "ref-for-concept-url" }, { "id": "ref-for-concept-url\u2460" }, { "id": "ref-for-concept-url\u2461" }], "title": "3.3.1. Extracting the fragment directive" }], "external": true };
        window.dfnpanelData['4bb788fe'] = { "dfnID": "4bb788fe", "url": "https://url.spec.whatwg.org/#url-code-points", "dfnText": "url code point", "refSections": [{ "refs": [{ "id": "ref-for-url-code-points" }, { "id": "ref-for-url-code-points\u2460" }], "title": "3.3.3. Fragment directive grammar" }], "external": true };
        window.dfnpanelData['889e932f'] = { "dfnID": "889e932f", "url": "https://webidl.spec.whatwg.org/#Exposed", "dfnText": "Exposed", "refSections": [{ "refs": [{ "id": "ref-for-Exposed" }], "title": "3.9. Feature Detectability" }], "external": true };
        window.dfnpanelData['a5c91173'] = { "dfnID": "a5c91173", "url": "https://webidl.spec.whatwg.org/#SameObject", "dfnText": "SameObject", "refSections": [{ "refs": [{ "id": "ref-for-SameObject" }], "title": "3.9. Feature Detectability" }], "external": true };
        window.dfnpanelData['fragment-directive'] = { "dfnID": "fragment-directive", "url": "#fragment-directive", "dfnText": "fragment directive", "refSections": [{ "refs": [{ "id": "ref-for-fragment-directive" }], "title": "3.2. Syntax" }, { "refs": [{ "id": "ref-for-fragment-directive\u2460" }, { "id": "ref-for-fragment-directive\u2461" }], "title": "3.3. The Fragment Directive" }, { "refs": [{ "id": "ref-for-fragment-directive\u2462" }, { "id": "ref-for-fragment-directive\u2463" }, { "id": "ref-for-fragment-directive\u2464" }, { "id": "ref-for-fragment-directive\u2465" }], "title": "3.3.1. Extracting the fragment directive" }, { "refs": [{ "id": "ref-for-fragment-directive\u2466" }], "title": "3.3.2. Applying directives to a document" }, { "refs": [{ "id": "ref-for-fragment-directive\u2467" }, { "id": "ref-for-fragment-directive\u2468" }, { "id": "ref-for-fragment-directive\u2460\u24ea" }], "title": "3.7.1. URLs in UA features" }, { "refs": [{ "id": "ref-for-fragment-directive\u2460\u2460" }], "title": "3.7.1.1. Location Bar" }, { "refs": [{ "id": "ref-for-fragment-directive\u2460\u2461" }, { "id": "ref-for-fragment-directive\u2460\u2462" }], "title": "3.7.1.2. Bookmarks" }, { "refs": [{ "id": "ref-for-fragment-directive\u2460\u2463" }], "title": "3.7.1.3. Sharing" }], "external": false };
        window.dfnpanelData['fragment-directive-delimiter'] = { "dfnID": "fragment-directive-delimiter", "url": "#fragment-directive-delimiter", "dfnText": "fragment directive delimiter", "refSections": [{ "refs": [{ "id": "ref-for-fragment-directive-delimiter" }], "title": "3.3. The Fragment Directive" }, { "refs": [{ "id": "ref-for-fragment-directive-delimiter\u2460" }, { "id": "ref-for-fragment-directive-delimiter\u2461" }, { "id": "ref-for-fragment-directive-delimiter\u2462" }, { "id": "ref-for-fragment-directive-delimiter\u2463" }], "title": "3.3.1. Extracting the fragment directive" }], "external": false };
        window.dfnpanelData['directives'] = { "dfnID": "directives", "url": "#directives", "dfnText": "directives", "refSections": [{ "refs": [{ "id": "ref-for-directives" }], "title": "3.4. Text Directives" }], "external": false };
        window.dfnpanelData['directive-state'] = { "dfnID": "directive-state", "url": "#directive-state", "dfnText": "directive state", "refSections": [{ "refs": [{ "id": "ref-for-directive-state" }, { "id": "ref-for-directive-state\u2460" }, { "id": "ref-for-directive-state\u2461" }, { "id": "ref-for-directive-state\u2462" }, { "id": "ref-for-directive-state\u2463" }, { "id": "ref-for-directive-state\u2464" }, { "id": "ref-for-directive-state\u2465" }, { "id": "ref-for-directive-state\u2466" }], "title": "3.3.1. Extracting the fragment directive" }], "external": false };
        window.dfnpanelData['directive-state-value'] = { "dfnID": "directive-state-value", "url": "#directive-state-value", "dfnText": "value", "refSections": [{ "refs": [{ "id": "ref-for-directive-state-value" }, { "id": "ref-for-directive-state-value\u2460" }, { "id": "ref-for-directive-state-value\u2461" }, { "id": "ref-for-directive-state-value\u2462" }, { "id": "ref-for-directive-state-value\u2463" }], "title": "3.3.1. Extracting the fragment directive" }, { "refs": [{ "id": "ref-for-directive-state-value\u2464" }], "title": "3.3.2. Applying directives to a document" }], "external": false };
        window.dfnpanelData['she-directive-state'] = { "dfnID": "she-directive-state", "url": "#she-directive-state", "dfnText": "directive state", "refSections": [{ "refs": [{ "id": "ref-for-she-directive-state" }, { "id": "ref-for-she-directive-state\u2460" }, { "id": "ref-for-she-directive-state\u2461" }, { "id": "ref-for-she-directive-state\u2462" }, { "id": "ref-for-she-directive-state\u2463" }, { "id": "ref-for-she-directive-state\u2464" }, { "id": "ref-for-she-directive-state\u2465" }, { "id": "ref-for-she-directive-state\u2466" }], "title": "3.3.1. Extracting the fragment directive" }, { "refs": [{ "id": "ref-for-she-directive-state\u2467" }, { "id": "ref-for-she-directive-state\u2468" }, { "id": "ref-for-she-directive-state\u2460\u24ea" }, { "id": "ref-for-she-directive-state\u2460\u2460" }], "title": "3.3.2. Applying directives to a document" }], "external": false };
        window.dfnpanelData['remove-the-fragment-directive'] = { "dfnID": "remove-the-fragment-directive", "url": "#remove-the-fragment-directive", "dfnText": "remove the fragment directive", "refSections": [{ "refs": [{ "id": "ref-for-remove-the-fragment-directive" }, { "id": "ref-for-remove-the-fragment-directive\u2460" }, { "id": "ref-for-remove-the-fragment-directive\u2461" }, { "id": "ref-for-remove-the-fragment-directive\u2462" }], "title": "3.3.1. Extracting the fragment directive" }], "external": false };
        window.dfnpanelData['document-pending-text-directives'] = { "dfnID": "document-pending-text-directives", "url": "#document-pending-text-directives", "dfnText": "pending text directives", "refSections": [{ "refs": [{ "id": "ref-for-document-pending-text-directives" }], "title": "3.3.2. Applying directives to a document" }, { "refs": [{ "id": "ref-for-document-pending-text-directives\u2460" }, { "id": "ref-for-document-pending-text-directives\u2461" }, { "id": "ref-for-document-pending-text-directives\u2462" }, { "id": "ref-for-document-pending-text-directives\u2463" }, { "id": "ref-for-document-pending-text-directives\u2464" }, { "id": "ref-for-document-pending-text-directives\u2465" }, { "id": "ref-for-document-pending-text-directives\u2466" }, { "id": "ref-for-document-pending-text-directives\u2467" }, { "id": "ref-for-document-pending-text-directives\u2468" }, { "id": "ref-for-document-pending-text-directives\u2460\u24ea" }], "title": "3.4.1. Invoking Text Directives" }, { "refs": [{ "id": "ref-for-document-pending-text-directives\u2460\u2460" }], "title": "3.5.4. Restricting the Text Fragment" }], "external": false };
        window.dfnpanelData['fragmentdirectiveproduction'] = { "dfnID": "fragmentdirectiveproduction", "url": "#fragmentdirectiveproduction", "dfnText": "FragmentDirective", "refSections": [{ "refs": [{ "id": "ref-for-fragmentdirectiveproduction" }, { "id": "ref-for-fragmentdirectiveproduction\u2460" }, { "id": "ref-for-fragmentdirectiveproduction\u2461" }], "title": "3.3.3. Fragment directive grammar" }], "external": false };
        window.dfnpanelData['textdirective'] = { "dfnID": "textdirective", "url": "#textdirective", "dfnText": "TextDirective", "refSections": [{ "refs": [{ "id": "ref-for-textdirective" }, { "id": "ref-for-textdirective\u2460" }, { "id": "ref-for-textdirective\u2461" }], "title": "3.3.3. Fragment directive grammar" }], "external": false };
        window.dfnpanelData['unknowndirective'] = { "dfnID": "unknowndirective", "url": "#unknowndirective", "dfnText": "UnknownDirective", "refSections": [{ "refs": [{ "id": "ref-for-unknowndirective" }], "title": "3.3.3. Fragment directive grammar" }], "external": false };
        window.dfnpanelData['characterstring'] = { "dfnID": "characterstring", "url": "#characterstring", "dfnText": "CharacterString", "refSections": [{ "refs": [{ "id": "ref-for-characterstring" }, { "id": "ref-for-characterstring\u2460" }], "title": "3.3.3. Fragment directive grammar" }], "external": false };
        window.dfnpanelData['explicitchar'] = { "dfnID": "explicitchar", "url": "#explicitchar", "dfnText": "ExplicitChar", "refSections": [{ "refs": [{ "id": "ref-for-explicitchar" }, { "id": "ref-for-explicitchar\u2460" }], "title": "3.3.3. Fragment directive grammar" }], "external": false };
        window.dfnpanelData['validtextdirective'] = { "dfnID": "validtextdirective", "url": "#validtextdirective", "dfnText": "ValidTextDirective", "refSections": [{ "refs": [{ "id": "ref-for-validtextdirective" }], "title": "3.3.3. Fragment directive grammar" }], "external": false };
        window.dfnpanelData['textdirectiveparameters'] = { "dfnID": "textdirectiveparameters", "url": "#textdirectiveparameters", "dfnText": "TextDirectiveParameters", "refSections": [{ "refs": [{ "id": "ref-for-textdirectiveparameters" }], "title": "3.3.3. Fragment directive grammar" }], "external": false };
        window.dfnpanelData['textdirectiveprefix'] = { "dfnID": "textdirectiveprefix", "url": "#textdirectiveprefix", "dfnText": "TextDirectivePrefix", "refSections": [{ "refs": [{ "id": "ref-for-textdirectiveprefix" }], "title": "3.3.3. Fragment directive grammar" }], "external": false };
        window.dfnpanelData['textdirectivesuffix'] = { "dfnID": "textdirectivesuffix", "url": "#textdirectivesuffix", "dfnText": "TextDirectiveSuffix", "refSections": [{ "refs": [{ "id": "ref-for-textdirectivesuffix" }], "title": "3.3.3. Fragment directive grammar" }], "external": false };
        window.dfnpanelData['textdirectivestring'] = { "dfnID": "textdirectivestring", "url": "#textdirectivestring", "dfnText": "TextDirectiveString", "refSections": [{ "refs": [{ "id": "ref-for-textdirectivestring" }, { "id": "ref-for-textdirectivestring\u2460" }, { "id": "ref-for-textdirectivestring\u2461" }, { "id": "ref-for-textdirectivestring\u2462" }], "title": "3.3.3. Fragment directive grammar" }], "external": false };
        window.dfnpanelData['textdirectiveexplicitchar'] = { "dfnID": "textdirectiveexplicitchar", "url": "#textdirectiveexplicitchar", "dfnText": "TextDirectiveExplicitChar", "refSections": [{ "refs": [{ "id": "ref-for-textdirectiveexplicitchar" }, { "id": "ref-for-textdirectiveexplicitchar\u2460" }], "title": "3.3.3. Fragment directive grammar" }], "external": false };
        window.dfnpanelData['percentencodedbyte'] = { "dfnID": "percentencodedbyte", "url": "#percentencodedbyte", "dfnText": "PercentEncodedByte", "refSections": [{ "refs": [{ "id": "ref-for-percentencodedbyte" }, { "id": "ref-for-percentencodedbyte\u2460" }], "title": "3.3.3. Fragment directive grammar" }], "external": false };
        window.dfnpanelData['text-directive'] = { "dfnID": "text-directive", "url": "#text-directive", "dfnText": "text directive", "refSections": [{ "refs": [{ "id": "ref-for-text-directive" }], "title": "3.2. Syntax" }, { "refs": [{ "id": "ref-for-text-directive\u2460" }], "title": "3.3.2. Applying directives to a document" }, { "refs": [{ "id": "ref-for-text-directive\u2461" }, { "id": "ref-for-text-directive\u2462" }, { "id": "ref-for-text-directive\u2463" }, { "id": "ref-for-text-directive\u2464" }], "title": "3.4. Text Directives" }, { "refs": [{ "id": "ref-for-text-directive\u2465" }], "title": "3.4.1. Invoking Text Directives" }, { "refs": [{ "id": "ref-for-text-directive\u2466" }, { "id": "ref-for-text-directive\u2467" }], "title": "3.5.1. Motivation" }, { "refs": [{ "id": "ref-for-text-directive\u2468" }], "title": "3.5.3. Search Timing" }, { "refs": [{ "id": "ref-for-text-directive\u2460\u24ea" }], "title": "3.6. Navigating to a Text Fragment" }, { "refs": [{ "id": "ref-for-text-directive\u2460\u2460" }, { "id": "ref-for-text-directive\u2460\u2461" }, { "id": "ref-for-text-directive\u2460\u2462" }], "title": "3.6.1. Finding Ranges in a Document" }, { "refs": [{ "id": "ref-for-text-directive\u2460\u2463" }], "title": "4. Generating Text Fragment Directives" }, { "refs": [{ "id": "ref-for-text-directive\u2460\u2464" }, { "id": "ref-for-text-directive\u2460\u2465" }, { "id": "ref-for-text-directive\u2460\u2466" }], "title": "4.2. Use Context Only When Necessary" }, { "refs": [{ "id": "ref-for-text-directive\u2460\u2467" }, { "id": "ref-for-text-directive\u2460\u2468" }], "title": "4.3. Determine If Fragment Id Is Needed" }], "external": false };
        window.dfnpanelData['text-directive-start'] = { "dfnID": "text-directive-start", "url": "#text-directive-start", "dfnText": "start", "refSections": [{ "refs": [{ "id": "ref-for-text-directive-start" }, { "id": "ref-for-text-directive-start\u2460" }], "title": "3.4. Text Directives" }, { "refs": [{ "id": "ref-for-text-directive-start\u2461" }, { "id": "ref-for-text-directive-start\u2462" }, { "id": "ref-for-text-directive-start\u2463" }, { "id": "ref-for-text-directive-start\u2464" }, { "id": "ref-for-text-directive-start\u2465" }, { "id": "ref-for-text-directive-start\u2466" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": false };
        window.dfnpanelData['text-directive-end'] = { "dfnID": "text-directive-end", "url": "#text-directive-end", "dfnText": "end", "refSections": [{ "refs": [{ "id": "ref-for-text-directive-end" }], "title": "3.4. Text Directives" }, { "refs": [{ "id": "ref-for-text-directive-end\u2460" }, { "id": "ref-for-text-directive-end\u2461" }, { "id": "ref-for-text-directive-end\u2462" }, { "id": "ref-for-text-directive-end\u2463" }, { "id": "ref-for-text-directive-end\u2464" }, { "id": "ref-for-text-directive-end\u2465" }, { "id": "ref-for-text-directive-end\u2466" }, { "id": "ref-for-text-directive-end\u2467" }, { "id": "ref-for-text-directive-end\u2468" }, { "id": "ref-for-text-directive-end\u2460\u24ea" }, { "id": "ref-for-text-directive-end\u2460\u2460" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": false };
        window.dfnpanelData['text-directive-prefix'] = { "dfnID": "text-directive-prefix", "url": "#text-directive-prefix", "dfnText": "prefix", "refSections": [{ "refs": [{ "id": "ref-for-text-directive-prefix" }], "title": "3.4. Text Directives" }, { "refs": [{ "id": "ref-for-text-directive-prefix\u2460" }, { "id": "ref-for-text-directive-prefix\u2461" }, { "id": "ref-for-text-directive-prefix\u2462" }, { "id": "ref-for-text-directive-prefix\u2463" }, { "id": "ref-for-text-directive-prefix\u2464" }, { "id": "ref-for-text-directive-prefix\u2465" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": false };
        window.dfnpanelData['text-directive-suffix'] = { "dfnID": "text-directive-suffix", "url": "#text-directive-suffix", "dfnText": "suffix", "refSections": [{ "refs": [{ "id": "ref-for-text-directive-suffix" }], "title": "3.4. Text Directives" }, { "refs": [{ "id": "ref-for-text-directive-suffix\u2460" }, { "id": "ref-for-text-directive-suffix\u2461" }, { "id": "ref-for-text-directive-suffix\u2462" }, { "id": "ref-for-text-directive-suffix\u2463" }, { "id": "ref-for-text-directive-suffix\u2464" }, { "id": "ref-for-text-directive-suffix\u2465" }, { "id": "ref-for-text-directive-suffix\u2466" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": false };
        window.dfnpanelData['percent-decode-a-text-directive-term'] = { "dfnID": "percent-decode-a-text-directive-term", "url": "#percent-decode-a-text-directive-term", "dfnText": "percent-decode a text directive term", "refSections": [{ "refs": [{ "id": "ref-for-percent-decode-a-text-directive-term" }, { "id": "ref-for-percent-decode-a-text-directive-term\u2460" }, { "id": "ref-for-percent-decode-a-text-directive-term\u2461" }, { "id": "ref-for-percent-decode-a-text-directive-term\u2462" }], "title": "3.4. Text Directives" }], "external": false };
        window.dfnpanelData['parse-a-text-directive'] = { "dfnID": "parse-a-text-directive", "url": "#parse-a-text-directive", "dfnText": "parse a text directive", "refSections": [{ "refs": [{ "id": "ref-for-parse-a-text-directive" }], "title": "3.4. Text Directives" }], "external": false };
        window.dfnpanelData['parse-the-fragment-directive'] = { "dfnID": "parse-the-fragment-directive", "url": "#parse-the-fragment-directive", "dfnText": "parse the fragment directive", "refSections": [{ "refs": [{ "id": "ref-for-parse-the-fragment-directive" }], "title": "3.3.2. Applying directives to a document" }], "external": false };
        window.dfnpanelData['request-text-directive-user-activation'] = { "dfnID": "request-text-directive-user-activation", "url": "#request-text-directive-user-activation", "dfnText": "text directive user activation", "refSections": [{ "refs": [{ "id": "ref-for-request-text-directive-user-activation" }, { "id": "ref-for-request-text-directive-user-activation\u2460" }, { "id": "ref-for-request-text-directive-user-activation\u2461" }, { "id": "ref-for-request-text-directive-user-activation\u2462" }, { "id": "ref-for-request-text-directive-user-activation\u2463" }], "title": "3.5.4. Restricting the Text Fragment" }], "external": false };
        window.dfnpanelData['document-text-directive-user-activation'] = { "dfnID": "document-text-directive-user-activation", "url": "#document-text-directive-user-activation", "dfnText": "text directive user activation", "refSections": [{ "refs": [{ "id": "ref-for-document-text-directive-user-activation" }, { "id": "ref-for-document-text-directive-user-activation\u2460" }, { "id": "ref-for-document-text-directive-user-activation\u2461" }, { "id": "ref-for-document-text-directive-user-activation\u2462" }, { "id": "ref-for-document-text-directive-user-activation\u2463" }, { "id": "ref-for-document-text-directive-user-activation\u2464" }, { "id": "ref-for-document-text-directive-user-activation\u2465" }, { "id": "ref-for-document-text-directive-user-activation\u2466" }, { "id": "ref-for-document-text-directive-user-activation\u2467" }, { "id": "ref-for-document-text-directive-user-activation\u2468" }, { "id": "ref-for-document-text-directive-user-activation\u2460\u24ea" }, { "id": "ref-for-document-text-directive-user-activation\u2460\u2460" }, { "id": "ref-for-document-text-directive-user-activation\u2460\u2461" }, { "id": "ref-for-document-text-directive-user-activation\u2460\u2462" }], "title": "3.5.4. Restricting the Text Fragment" }], "external": false };
        window.dfnpanelData['navigation-params-user-involvement'] = { "dfnID": "navigation-params-user-involvement", "url": "#navigation-params-user-involvement", "dfnText": "user involvement", "refSections": [{ "refs": [{ "id": "ref-for-navigation-params-user-involvement" }, { "id": "ref-for-navigation-params-user-involvement\u2460" }, { "id": "ref-for-navigation-params-user-involvement\u2461" }, { "id": "ref-for-navigation-params-user-involvement\u2462" }], "title": "3.5.4. Restricting the Text Fragment" }], "external": false };
        window.dfnpanelData['text-directive-allowing-mime-type'] = { "dfnID": "text-directive-allowing-mime-type", "url": "#text-directive-allowing-mime-type", "dfnText": "text directive allowing MIME type", "refSections": [{ "refs": [{ "id": "ref-for-text-directive-allowing-mime-type" }], "title": "3.5.4. Restricting the Text Fragment" }], "external": false };
        window.dfnpanelData['check-if-a-text-directive-can-be-scrolled'] = { "dfnID": "check-if-a-text-directive-can-be-scrolled", "url": "#check-if-a-text-directive-can-be-scrolled", "dfnText": "check if a text directive can be scrolled", "refSections": [{ "refs": [{ "id": "ref-for-check-if-a-text-directive-can-be-scrolled" }, { "id": "ref-for-check-if-a-text-directive-can-be-scrolled\u2460" }], "title": "3.5.4. Restricting the Text Fragment" }], "external": false };
        window.dfnpanelData['first-common-ancestor'] = { "dfnID": "first-common-ancestor", "url": "#first-common-ancestor", "dfnText": "first common ancestor", "refSections": [{ "refs": [{ "id": "ref-for-first-common-ancestor" }], "title": "3.4.1. Invoking Text Directives" }, { "refs": [{ "id": "ref-for-first-common-ancestor\u2460" }], "title": "3.5.4. Restricting the Text Fragment" }], "external": false };
        window.dfnpanelData['shadow-including-parent'] = { "dfnID": "shadow-including-parent", "url": "#shadow-including-parent", "dfnText": "shadow-including parent", "refSections": [{ "refs": [{ "id": "ref-for-shadow-including-parent" }], "title": "3.6. Navigating to a Text Fragment" }], "external": false };
        window.dfnpanelData['invoke-text-directives'] = { "dfnID": "invoke-text-directives", "url": "#invoke-text-directives", "dfnText": "invoke text directives", "refSections": [{ "refs": [{ "id": "ref-for-invoke-text-directives" }], "title": "3.4.1. Invoking Text Directives" }, { "refs": [{ "id": "ref-for-invoke-text-directives\u2460" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": false };
        window.dfnpanelData['find-a-range-from-a-text-directive'] = { "dfnID": "find-a-range-from-a-text-directive", "url": "#find-a-range-from-a-text-directive", "dfnText": "find a range from a text directive", "refSections": [{ "refs": [{ "id": "ref-for-find-a-range-from-a-text-directive" }], "title": "3.5.3. Search Timing" }, { "refs": [{ "id": "ref-for-find-a-range-from-a-text-directive\u2460" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": false };
        window.dfnpanelData['next-non-whitespace-position'] = { "dfnID": "next-non-whitespace-position", "url": "#next-non-whitespace-position", "dfnText": "next\nnon-whitespace position", "refSections": [{ "refs": [{ "id": "ref-for-next-non-whitespace-position" }, { "id": "ref-for-next-non-whitespace-position\u2460" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": false };
        window.dfnpanelData['find-a-string-in-range'] = { "dfnID": "find-a-string-in-range", "url": "#find-a-string-in-range", "dfnText": "find a string in range", "refSections": [{ "refs": [{ "id": "ref-for-find-a-string-in-range" }, { "id": "ref-for-find-a-string-in-range\u2460" }, { "id": "ref-for-find-a-string-in-range\u2461" }, { "id": "ref-for-find-a-string-in-range\u2462" }, { "id": "ref-for-find-a-string-in-range\u2463" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": false };
        window.dfnpanelData['search-invisible'] = { "dfnID": "search-invisible", "url": "#search-invisible", "dfnText": "search invisible", "refSections": [{ "refs": [{ "id": "ref-for-search-invisible" }, { "id": "ref-for-search-invisible\u2460" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": false };
        window.dfnpanelData['non-searchable-subtree'] = { "dfnID": "non-searchable-subtree", "url": "#non-searchable-subtree", "dfnText": "non-searchable subtree", "refSections": [{ "refs": [{ "id": "ref-for-non-searchable-subtree" }, { "id": "ref-for-non-searchable-subtree\u2460" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": false };
        window.dfnpanelData['visible-text-node'] = { "dfnID": "visible-text-node", "url": "#visible-text-node", "dfnText": "visible text node", "refSections": [{ "refs": [{ "id": "ref-for-visible-text-node" }, { "id": "ref-for-visible-text-node\u2460" }, { "id": "ref-for-visible-text-node\u2461" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": false };
        window.dfnpanelData['has-block-level-display'] = { "dfnID": "has-block-level-display", "url": "#has-block-level-display", "dfnText": "has block-level display", "refSections": [{ "refs": [{ "id": "ref-for-has-block-level-display" }, { "id": "ref-for-has-block-level-display\u2460" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": false };
        window.dfnpanelData['nearest-block-ancestor'] = { "dfnID": "nearest-block-ancestor", "url": "#nearest-block-ancestor", "dfnText": "nearest block ancestor", "refSections": [{ "refs": [{ "id": "ref-for-nearest-block-ancestor" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": false };
        window.dfnpanelData['find-a-range-from-a-node-list'] = { "dfnID": "find-a-range-from-a-node-list", "url": "#find-a-range-from-a-node-list", "dfnText": "find a range from a node list", "refSections": [{ "refs": [{ "id": "ref-for-find-a-range-from-a-node-list" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": false };
        window.dfnpanelData['get-boundary-point-at-index'] = { "dfnID": "get-boundary-point-at-index", "url": "#get-boundary-point-at-index", "dfnText": "get boundary point at index", "refSections": [{ "refs": [{ "id": "ref-for-get-boundary-point-at-index" }, { "id": "ref-for-get-boundary-point-at-index\u2460" }], "title": "3.6.1. Finding Ranges in a Document" }], "external": false };
        window.dfnpanelData['word-boundary'] = { "dfnID": "word-boundary", "url": "#word-boundary", "dfnText": "word boundary", "refSections": [{ "refs": [{ "id": "ref-for-word-boundary" }], "title": "3.6.1. Finding Ranges in a Document" }, { "refs": [{ "id": "ref-for-word-boundary\u2460" }], "title": "3.6.2. Word Boundaries" }], "external": false };
        window.dfnpanelData['locale'] = { "dfnID": "locale", "url": "#locale", "dfnText": "locale", "refSections": [{ "refs": [{ "id": "ref-for-locale" }, { "id": "ref-for-locale\u2460" }], "title": "3.6.2. Word Boundaries" }], "external": false };
        window.dfnpanelData['word-bounded'] = { "dfnID": "word-bounded", "url": "#word-bounded", "dfnText": "word bounded", "refSections": [{ "refs": [{ "id": "ref-for-word-bounded" }], "title": "3.6.2. Word Boundaries" }], "external": false };
        window.dfnpanelData['is-at-a-word-boundary'] = { "dfnID": "is-at-a-word-boundary", "url": "#is-at-a-word-boundary", "dfnText": "is at a word boundary", "refSections": [{ "refs": [{ "id": "ref-for-is-at-a-word-boundary" }, { "id": "ref-for-is-at-a-word-boundary\u2460" }], "title": "3.6.1. Finding Ranges in a Document" }, { "refs": [{ "id": "ref-for-is-at-a-word-boundary\u2461" }, { "id": "ref-for-is-at-a-word-boundary\u2462" }], "title": "3.6.2. Word Boundaries" }], "external": false };
        window.dfnpanelData['fragmentdirective'] = { "dfnID": "fragmentdirective", "url": "#fragmentdirective", "dfnText": "FragmentDirective", "refSections": [{ "refs": [{ "id": "ref-for-fragmentdirective" }], "title": "3.9. Feature Detectability" }], "external": false };
    </script>
    <script>/* Boilerplate: script-dom-helper */
        function query(sel) { return document.querySelector(sel); }

        function queryAll(sel) { return [...document.querySelectorAll(sel)]; }

        function iter(obj) {
            if (!obj) return [];
            var it = obj[Symbol.iterator];
            if (it) return it;
            return Object.entries(obj);
        }

        function mk(tagname, attrs, ...children) {
            const el = document.createElement(tagname);
            for (const [k, v] of iter(attrs)) {
                if (k.slice(0, 3) == "_on") {
                    const eventName = k.slice(3);
                    el.addEventListener(eventName, v);
                } else if (k[0] == "_") {
                    // property, not attribute
                    el[k.slice(1)] = v;
                } else {
                    if (v === false || v == null) {
                        continue;
                    } else if (v === true) {
                        el.setAttribute(k, "");
                        continue;
                    } else {
                        el.setAttribute(k, v);
                    }
                }
            }
            append(el, children);
            return el;
        }

        /* Create shortcuts for every known HTML element */
        [
            "a",
            "abbr",
            "acronym",
            "address",
            "applet",
            "area",
            "article",
            "aside",
            "audio",
            "b",
            "base",
            "basefont",
            "bdo",
            "big",
            "blockquote",
            "body",
            "br",
            "button",
            "canvas",
            "caption",
            "center",
            "cite",
            "code",
            "col",
            "colgroup",
            "datalist",
            "dd",
            "del",
            "details",
            "dfn",
            "dialog",
            "div",
            "dl",
            "dt",
            "em",
            "embed",
            "fieldset",
            "figcaption",
            "figure",
            "font",
            "footer",
            "form",
            "frame",
            "frameset",
            "head",
            "header",
            "h1",
            "h2",
            "h3",
            "h4",
            "h5",
            "h6",
            "hr",
            "html",
            "i",
            "iframe",
            "img",
            "input",
            "ins",
            "kbd",
            "label",
            "legend",
            "li",
            "link",
            "main",
            "map",
            "mark",
            "meta",
            "meter",
            "nav",
            "nobr",
            "noscript",
            "object",
            "ol",
            "optgroup",
            "option",
            "output",
            "p",
            "param",
            "pre",
            "progress",
            "q",
            "s",
            "samp",
            "script",
            "section",
            "select",
            "small",
            "source",
            "span",
            "strike",
            "strong",
            "style",
            "sub",
            "summary",
            "sup",
            "table",
            "tbody",
            "td",
            "template",
            "textarea",
            "tfoot",
            "th",
            "thead",
            "time",
            "title",
            "tr",
            "u",
            "ul",
            "var",
            "video",
            "wbr",
            "xmp",
        ].forEach(tagname => {
            mk[tagname] = (...args) => mk(tagname, ...args);
        });

        function* nodesFromChildList(children) {
            for (const child of children.flat(Infinity)) {
                if (child instanceof Node) {
                    yield child;
                } else {
                    yield new Text(child);
                }
            }
        }
        function append(el, ...children) {
            for (const child of nodesFromChildList(children)) {
                if (el instanceof Node) el.appendChild(child);
                else el.push(child);
            }
            return el;
        }

        function insertAfter(el, ...children) {
            for (const child of nodesFromChildList(children)) {
                el.parentNode.insertBefore(child, el.nextSibling);
            }
            return el;
        }

        function clearContents(el) {
            el.innerHTML = "";
            return el;
        }

        function parseHTML(markup) {
            if (markup.toLowerCase().trim().indexOf('<!doctype') === 0) {
                const doc = document.implementation.createHTMLDocument("");
                doc.documentElement.innerHTML = markup;
                return doc;
            } else {
                const el = mk.template({});
                el.innerHTML = markup;
                return el.content;
            }
        }
    </script>
    <script>/* Boilerplate: script-var-click-highlighting */
        /*
        Color-choosing design:
        
        Colors are ordered by goodness.
        Each color has a usage count (initially zero).
        Each variable has a last-used color.
        
        * If the var has a last-used color, and that color's usage is 0,
            return that color.
        * Otherwise, return the lowest-indexed color with the lowest usage.
            Increment the color's usage and set it as the last-used color
            for that var.
        * On unclicking, decrement usage of the color.
        */
        "use strict";
        {
            document.addEventListener("click", e => {
                if (e.target.nodeName == "VAR") {
                    highlightSameAlgoVars(e.target);
                }
            });
            const indexCounts = new Map();
            const indexNames = new Map();
            function highlightSameAlgoVars(v) {
                // Find the algorithm container.
                let algoContainer = null;
                let searchEl = v;
                while (algoContainer == null && searchEl != document.body) {
                    searchEl = searchEl.parentNode;
                    if (searchEl.hasAttribute("data-algorithm")) {
                        algoContainer = searchEl;
                    }
                }

                // Not highlighting document-global vars,
                // too likely to be unrelated.
                if (algoContainer == null) return;

                const algoName = algoContainer.getAttribute("data-algorithm");
                const varName = getVarName(v);
                const addClass = !v.classList.contains("selected");
                let highlightClass = null;
                if (addClass) {
                    const index = chooseHighlightIndex(algoName, varName);
                    indexCounts.get(algoName)[index] += 1;
                    indexNames.set(algoName + "///" + varName, index);
                    highlightClass = nameFromIndex(index);
                } else {
                    const index = previousHighlightIndex(algoName, varName);
                    indexCounts.get(algoName)[index] -= 1;
                    highlightClass = nameFromIndex(index);
                }

                // Find all same-name vars, and toggle their class appropriately.
                for (const el of algoContainer.querySelectorAll("var")) {
                    if (getVarName(el) == varName) {
                        el.classList.toggle("selected", addClass);
                        el.classList.toggle(highlightClass, addClass);
                    }
                }
            }
            function getVarName(el) {
                return el.textContent.replace(/(\s|\xa0)+/, " ").trim();
            }
            function chooseHighlightIndex(algoName, varName) {
                let indexes = null;
                if (indexCounts.has(algoName)) {
                    indexes = indexCounts.get(algoName);
                } else {
                    // 7 classes right now
                    indexes = [0, 0, 0, 0, 0, 0, 0];
                    indexCounts.set(algoName, indexes);
                }

                // If the element was recently unclicked,
                // *and* that color is still unclaimed,
                // give it back the same color.
                const lastIndex = previousHighlightIndex(algoName, varName);
                if (indexes[lastIndex] === 0) return lastIndex;

                // Find the earliest index with the lowest count.
                const minCount = Math.min.apply(null, indexes);
                let index = null;
                for (var i = 0; i < indexes.length; i++) {
                    if (indexes[i] == minCount) {
                        return i;
                    }
                }
            }
            function previousHighlightIndex(algoName, varName) {
                return indexNames.get(algoName + "///" + varName);
            }
            function nameFromIndex(index) {
                return "selected" + index;
            }
        }
    </script>
    <script>/* Boilerplate: script-wpt */
        let wptPath = "/scroll-to-text-fragment/";
        "use strict";

        document.addEventListener("DOMContentLoaded", async () => {
            if (wptPath == "/") return;

            const runsUrl = "https://wpt.fyi/api/runs?label=master&label=stable&max-count=1&product=chrome&product=firefox&product=safari&product=edge";
            const runs = await (await fetch(runsUrl)).json();

            const testResults = await (await fetch("https://wpt.fyi/api/search", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    "run_ids": runs.map(x => x.id),
                    "query": { "path": wptPath },
                })
            })).json();

            const browsers = runs.map(x => ({ name: x.browser_name, version: x.browser_version, passes: 0, total: 0 }));
            const resultsFromPath = new Map(testResults.results.map(result => {
                const testPath = result.test;
                const passes = result.legacy_status.map(x => [x.passes, x.total]);
                return [testPath, passes];
            }));
            const seenTests = new Set();
            document.querySelectorAll(".wpt-name").forEach(nameEl => {
                const passData = resultsFromPath.get("/" + nameEl.getAttribute("title"));
                if (!passData) {
                    console.log("Couldn't find test in results:", nameEl);
                    return
                }
                const numTests = passData[0][1];
                if (numTests > 1) {
                    nameEl.insertAdjacentElement("beforeend",
                        el("small", {}, ` (${numTests} tests)`));
                }
                if (passData == undefined) return;
                const resultsEl = el("span", { "class": "wpt-results" },
                    ...passData.map((p, i) => el("span",
                        {
                            "title": `${browsers[i].name} ${p[0]}/${p[1]}`,
                            "class": "wpt-result",
                            "style": `background: conic-gradient(forestgreen ${p[0] / p[1] * 360}deg, darkred 0deg);`,
                        })),
                );
                nameEl.insertAdjacentElement("afterend", resultsEl);

                // Only update the summary pass/total count if we haven't seen this
                // test before, to support authors listing the same test multiple times
                // in a spec.
                if (!seenTests.has(nameEl.getAttribute("title"))) {
                    seenTests.add(nameEl.getAttribute("title"));
                    passData.forEach((p, i) => {
                        browsers[i].passes += p[0];
                        browsers[i].total += p[1];
                    });
                }
            });
            const overview = document.querySelector(".wpt-overview");
            if (overview) {
                overview.appendChild(el('ul', {}, ...browsers.map(formatWptResult)));
                document.head.appendChild(el('style', {},
                    `.wpt-overview ul { display: flex; flex-flow: row wrap; gap: .2em; justify-content: start; list-style: none; padding: 0; margin: 0;}
             .wpt-overview li { padding: .25em 1em; color: black; text-align: center; }
             .wpt-overview img { height: 1.5em; height: max(1.5em, 32px); background: transparent; }
             .wpt-overview .browser { font-weight: bold; }
             .wpt-overview .passes-none { background: #e57373; }
             .wpt-overview .passes-hardly { background: #ffb74d; }
             .wpt-overview .passes-a-few { background: #ffd54f; }
             .wpt-overview .passes-half { background: #fff176; }
             .wpt-overview .passes-lots { background: #dce775; }
             .wpt-overview .passes-most { background: #aed581; }
             .wpt-overview .passes-all { background: #81c784; }`));
            }
        });
        function el(name, attrs, ...content) {
            const x = document.createElement(name);
            for (const [k, v] of Object.entries(attrs)) {
                x.setAttribute(k, v);
            }
            for (let child of content) {
                if (typeof child == "string") child = document.createTextNode(child);
                try {
                    x.appendChild(child);
                } catch (e) { console.log({ x, child }); }
            }
            return x;
        }
        function formatWptResult({ name, version, passes, total }) {
            const passRate = passes / total;
            let passClass = "";
            if (passRate == 0) passClass = "passes-none";
            else if (passRate < .2) passClass = "passes-hardly";
            else if (passRate < .4) passClass = "passes-a-few";
            else if (passRate < .6) passClass = "passes-half";
            else if (passRate < .8) passClass = "passes-lots";
            else if (passRate < 1) passClass = "passes-most";
            else passClass = "passes-all";

            name = name[0].toUpperCase() + name.slice(1);
            const shortVersion = /^\d+/.exec(version);
            const icon = []

            if (name == "Chrome") icon.push(el('img', { alt: "", src: "https://wpt.fyi/static/chrome_64x64.png" }));
            if (name == "Edge") icon.push(el('img', { alt: "", src: "https://wpt.fyi/static/edge_64x64.png" }));
            if (name == "Safari") icon.push(el('img', { alt: "", src: "https://wpt.fyi/static/safari_64x64.png" }));
            if (name == "Firefox") icon.push(el('img', { alt: "", src: "https://wpt.fyi/static/firefox_64x64.png" }));

            return el('li', { "class": passClass },
                el('nobr', { 'class': 'browser' }, ...icon, ` ${name} ${shortVersion}`),
                el('br', {}),
                el('nobr', { 'class': 'pass-rate' }, `${passes}/${total}`)
            );
        }
    </script>
    <script src="https://htmlspecs.com/dropdown.js"></script>
